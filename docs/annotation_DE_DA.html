<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">

<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"/>
  <meta name="generator" content="distill" />

  <style type="text/css">
  /* Hide doc at startup (prevent jankiness while JS renders/transforms) */
  body {
    visibility: hidden;
  }
  </style>

 <!--radix_placeholder_import_source-->
 <!--/radix_placeholder_import_source-->

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ad0000; } /* Alert */
code span.an { color: #5e5e5e; } /* Annotation */
code span.at { color: #20794d; } /* Attribute */
code span.bn { color: #ad0000; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007ba5; } /* ControlFlow */
code span.ch { color: #20794d; } /* Char */
code span.cn { color: #8f5902; } /* Constant */
code span.co { color: #5e5e5e; } /* Comment */
code span.cv { color: #5e5e5e; font-style: italic; } /* CommentVar */
code span.do { color: #5e5e5e; font-style: italic; } /* Documentation */
code span.dt { color: #ad0000; } /* DataType */
code span.dv { color: #ad0000; } /* DecVal */
code span.er { color: #ad0000; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #ad0000; } /* Float */
code span.fu { color: #4758ab; } /* Function */
code span.im { } /* Import */
code span.in { color: #5e5e5e; } /* Information */
code span.kw { color: #007ba5; } /* Keyword */
code span.op { color: #5e5e5e; } /* Operator */
code span.ot { color: #007ba5; } /* Other */
code span.pp { color: #ad0000; } /* Preprocessor */
code span.sc { color: #20794d; } /* SpecialChar */
code span.ss { color: #20794d; } /* SpecialString */
code span.st { color: #20794d; } /* String */
code span.va { color: #111111; } /* Variable */
code span.vs { color: #20794d; } /* VerbatimString */
code span.wa { color: #5e5e5e; font-style: italic; } /* Warning */
</style>

  <!--radix_placeholder_meta_tags-->
  <title>C057: Untitled</title>
  
  
  
  
  <!--  https://developers.facebook.com/docs/sharing/webmasters#markup -->
  <meta property="og:title" content="C057: Untitled"/>
  <meta property="og:type" content="article"/>
  <meta property="og:locale" content="en_US"/>
  <meta property="og:site_name" content="C057"/>
  
  <!--  https://dev.twitter.com/cards/types/summary -->
  <meta property="twitter:card" content="summary"/>
  <meta property="twitter:title" content="C057: Untitled"/>
  
  <!--/radix_placeholder_meta_tags-->
  <!--radix_placeholder_rmarkdown_metadata-->
  
  <script type="text/json" id="radix-rmarkdown-metadata">
  {"type":"list","attributes":{},"value":[]}
  </script>
  <!--/radix_placeholder_rmarkdown_metadata-->
  <!--radix_placeholder_navigation_in_header-->
  <meta name="distill:offset" content=""/>
  
  <script type="application/javascript">
  
    window.headroom_prevent_pin = false;
  
    window.document.addEventListener("DOMContentLoaded", function (event) {
  
      // initialize headroom for banner
      var header = $('header').get(0);
      var headerHeight = header.offsetHeight;
      var headroom = new Headroom(header, {
        tolerance: 5,
        onPin : function() {
          if (window.headroom_prevent_pin) {
            window.headroom_prevent_pin = false;
            headroom.unpin();
          }
        }
      });
      headroom.init();
      if(window.location.hash)
        headroom.unpin();
      $(header).addClass('headroom--transition');
  
      // offset scroll location for banner on hash change
      // (see: https://github.com/WickyNilliams/headroom.js/issues/38)
      window.addEventListener("hashchange", function(event) {
        window.scrollTo(0, window.pageYOffset - (headerHeight + 25));
      });
  
      // responsive menu
      $('.distill-site-header').each(function(i, val) {
        var topnav = $(this);
        var toggle = topnav.find('.nav-toggle');
        toggle.on('click', function() {
          topnav.toggleClass('responsive');
        });
      });
  
      // nav dropdowns
      $('.nav-dropbtn').click(function(e) {
        $(this).next('.nav-dropdown-content').toggleClass('nav-dropdown-active');
        $(this).parent().siblings('.nav-dropdown')
           .children('.nav-dropdown-content').removeClass('nav-dropdown-active');
      });
      $("body").click(function(e){
        $('.nav-dropdown-content').removeClass('nav-dropdown-active');
      });
      $(".nav-dropdown").click(function(e){
        e.stopPropagation();
      });
    });
  </script>
  
  <style type="text/css">
  
  /* Theme (user-documented overrideables for nav appearance) */
  
  .distill-site-nav {
    color: rgba(255, 255, 255, 0.8);
    background-color: #0F2E3D;
    font-size: 15px;
    font-weight: 300;
  }
  
  .distill-site-nav a {
    color: inherit;
    text-decoration: none;
  }
  
  .distill-site-nav a:hover {
    color: white;
  }
  
  @media print {
    .distill-site-nav {
      display: none;
    }
  }
  
  .distill-site-header {
  
  }
  
  .distill-site-footer {
  
  }
  
  
  /* Site Header */
  
  .distill-site-header {
    width: 100%;
    box-sizing: border-box;
    z-index: 3;
  }
  
  .distill-site-header .nav-left {
    display: inline-block;
    margin-left: 8px;
  }
  
  @media screen and (max-width: 768px) {
    .distill-site-header .nav-left {
      margin-left: 0;
    }
  }
  
  
  .distill-site-header .nav-right {
    float: right;
    margin-right: 8px;
  }
  
  .distill-site-header a,
  .distill-site-header .title {
    display: inline-block;
    text-align: center;
    padding: 14px 10px 14px 10px;
  }
  
  .distill-site-header .title {
    font-size: 18px;
    min-width: 150px;
  }
  
  .distill-site-header .logo {
    padding: 0;
  }
  
  .distill-site-header .logo img {
    display: none;
    max-height: 20px;
    width: auto;
    margin-bottom: -4px;
  }
  
  .distill-site-header .nav-image img {
    max-height: 18px;
    width: auto;
    display: inline-block;
    margin-bottom: -3px;
  }
  
  
  
  @media screen and (min-width: 1000px) {
    .distill-site-header .logo img {
      display: inline-block;
    }
    .distill-site-header .nav-left {
      margin-left: 20px;
    }
    .distill-site-header .nav-right {
      margin-right: 20px;
    }
    .distill-site-header .title {
      padding-left: 12px;
    }
  }
  
  
  .distill-site-header .nav-toggle {
    display: none;
  }
  
  .nav-dropdown {
    display: inline-block;
    position: relative;
  }
  
  .nav-dropdown .nav-dropbtn {
    border: none;
    outline: none;
    color: rgba(255, 255, 255, 0.8);
    padding: 16px 10px;
    background-color: transparent;
    font-family: inherit;
    font-size: inherit;
    font-weight: inherit;
    margin: 0;
    margin-top: 1px;
    z-index: 2;
  }
  
  .nav-dropdown-content {
    display: none;
    position: absolute;
    background-color: white;
    min-width: 200px;
    border: 1px solid rgba(0,0,0,0.15);
    border-radius: 4px;
    box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.1);
    z-index: 1;
    margin-top: 2px;
    white-space: nowrap;
    padding-top: 4px;
    padding-bottom: 4px;
  }
  
  .nav-dropdown-content hr {
    margin-top: 4px;
    margin-bottom: 4px;
    border: none;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  }
  
  .nav-dropdown-active {
    display: block;
  }
  
  .nav-dropdown-content a, .nav-dropdown-content .nav-dropdown-header {
    color: black;
    padding: 6px 24px;
    text-decoration: none;
    display: block;
    text-align: left;
  }
  
  .nav-dropdown-content .nav-dropdown-header {
    display: block;
    padding: 5px 24px;
    padding-bottom: 0;
    text-transform: uppercase;
    font-size: 14px;
    color: #999999;
    white-space: nowrap;
  }
  
  .nav-dropdown:hover .nav-dropbtn {
    color: white;
  }
  
  .nav-dropdown-content a:hover {
    background-color: #ddd;
    color: black;
  }
  
  .nav-right .nav-dropdown-content {
    margin-left: -45%;
    right: 0;
  }
  
  @media screen and (max-width: 768px) {
    .distill-site-header a, .distill-site-header .nav-dropdown  {display: none;}
    .distill-site-header a.nav-toggle {
      float: right;
      display: block;
    }
    .distill-site-header .title {
      margin-left: 0;
    }
    .distill-site-header .nav-right {
      margin-right: 0;
    }
    .distill-site-header {
      overflow: hidden;
    }
    .nav-right .nav-dropdown-content {
      margin-left: 0;
    }
  }
  
  
  @media screen and (max-width: 768px) {
    .distill-site-header.responsive {position: relative; min-height: 500px; }
    .distill-site-header.responsive a.nav-toggle {
      position: absolute;
      right: 0;
      top: 0;
    }
    .distill-site-header.responsive a,
    .distill-site-header.responsive .nav-dropdown {
      display: block;
      text-align: left;
    }
    .distill-site-header.responsive .nav-left,
    .distill-site-header.responsive .nav-right {
      width: 100%;
    }
    .distill-site-header.responsive .nav-dropdown {float: none;}
    .distill-site-header.responsive .nav-dropdown-content {position: relative;}
    .distill-site-header.responsive .nav-dropdown .nav-dropbtn {
      display: block;
      width: 100%;
      text-align: left;
    }
  }
  
  /* Site Footer */
  
  .distill-site-footer {
    width: 100%;
    overflow: hidden;
    box-sizing: border-box;
    z-index: 3;
    margin-top: 30px;
    padding-top: 30px;
    padding-bottom: 30px;
    text-align: center;
  }
  
  /* Headroom */
  
  d-title {
    padding-top: 6rem;
  }
  
  @media print {
    d-title {
      padding-top: 4rem;
    }
  }
  
  .headroom {
    z-index: 1000;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
  }
  
  .headroom--transition {
    transition: all .4s ease-in-out;
  }
  
  .headroom--unpinned {
    top: -100px;
  }
  
  .headroom--pinned {
    top: 0;
  }
  
  /* adjust viewport for navbar height */
  /* helps vertically center bootstrap (non-distill) content */
  .min-vh-100 {
    min-height: calc(100vh - 100px) !important;
  }
  
  </style>
  
  <script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
  <link href="site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet"/>
  <link href="site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet"/>
  <script src="site_libs/headroom-0.9.4/headroom.min.js"></script>
  <script src="site_libs/autocomplete-0.37.1/autocomplete.min.js"></script>
  <script src="site_libs/fuse-6.4.1/fuse.min.js"></script>
  
  <script type="application/javascript">
  
  function getMeta(metaName) {
    var metas = document.getElementsByTagName('meta');
    for (let i = 0; i < metas.length; i++) {
      if (metas[i].getAttribute('name') === metaName) {
        return metas[i].getAttribute('content');
      }
    }
    return '';
  }
  
  function offsetURL(url) {
    var offset = getMeta('distill:offset');
    return offset ? offset + '/' + url : url;
  }
  
  function createFuseIndex() {
  
    // create fuse index
    var options = {
      keys: [
        { name: 'title', weight: 20 },
        { name: 'categories', weight: 15 },
        { name: 'description', weight: 10 },
        { name: 'contents', weight: 5 },
      ],
      ignoreLocation: true,
      threshold: 0
    };
    var fuse = new window.Fuse([], options);
  
    // fetch the main search.json
    return fetch(offsetURL('search.json'))
      .then(function(response) {
        if (response.status == 200) {
          return response.json().then(function(json) {
            // index main articles
            json.articles.forEach(function(article) {
              fuse.add(article);
            });
            // download collections and index their articles
            return Promise.all(json.collections.map(function(collection) {
              return fetch(offsetURL(collection)).then(function(response) {
                if (response.status === 200) {
                  return response.json().then(function(articles) {
                    articles.forEach(function(article) {
                      fuse.add(article);
                    });
                  })
                } else {
                  return Promise.reject(
                    new Error('Unexpected status from search index request: ' +
                              response.status)
                  );
                }
              });
            })).then(function() {
              return fuse;
            });
          });
  
        } else {
          return Promise.reject(
            new Error('Unexpected status from search index request: ' +
                        response.status)
          );
        }
      });
  }
  
  window.document.addEventListener("DOMContentLoaded", function (event) {
  
    // get search element (bail if we don't have one)
    var searchEl = window.document.getElementById('distill-search');
    if (!searchEl)
      return;
  
    createFuseIndex()
      .then(function(fuse) {
  
        // make search box visible
        searchEl.classList.remove('hidden');
  
        // initialize autocomplete
        var options = {
          autoselect: true,
          hint: false,
          minLength: 2,
        };
        window.autocomplete(searchEl, options, [{
          source: function(query, callback) {
            const searchOptions = {
              isCaseSensitive: false,
              shouldSort: true,
              minMatchCharLength: 2,
              limit: 10,
            };
            var results = fuse.search(query, searchOptions);
            callback(results
              .map(function(result) { return result.item; })
            );
          },
          templates: {
            suggestion: function(suggestion) {
              var img = suggestion.preview && Object.keys(suggestion.preview).length > 0
                ? `<img src="${offsetURL(suggestion.preview)}"</img>`
                : '';
              var html = `
                <div class="search-item">
                  <h3>${suggestion.title}</h3>
                  <div class="search-item-description">
                    ${suggestion.description || ''}
                  </div>
                  <div class="search-item-preview">
                    ${img}
                  </div>
                </div>
              `;
              return html;
            }
          }
        }]).on('autocomplete:selected', function(event, suggestion) {
          window.location.href = offsetURL(suggestion.path);
        });
        // remove inline display style on autocompleter (we want to
        // manage responsive display via css)
        $('.algolia-autocomplete').css("display", "");
      })
      .catch(function(error) {
        console.log(error);
      });
  
  });
  
  </script>
  
  <style type="text/css">
  
  .nav-search {
    font-size: x-small;
  }
  
  /* Algolioa Autocomplete */
  
  .algolia-autocomplete {
    display: inline-block;
    margin-left: 10px;
    vertical-align: sub;
    background-color: white;
    color: black;
    padding: 6px;
    padding-top: 8px;
    padding-bottom: 0;
    border-radius: 6px;
    border: 1px #0F2E3D solid;
    width: 180px;
  }
  
  
  @media screen and (max-width: 768px) {
    .distill-site-nav .algolia-autocomplete {
      display: none;
      visibility: hidden;
    }
    .distill-site-nav.responsive .algolia-autocomplete {
      display: inline-block;
      visibility: visible;
    }
    .distill-site-nav.responsive .algolia-autocomplete .aa-dropdown-menu {
      margin-left: 0;
      width: 400px;
      max-height: 400px;
    }
  }
  
  .algolia-autocomplete .aa-input, .algolia-autocomplete .aa-hint {
    width: 90%;
    outline: none;
    border: none;
  }
  
  .algolia-autocomplete .aa-hint {
    color: #999;
  }
  .algolia-autocomplete .aa-dropdown-menu {
    width: 550px;
    max-height: 70vh;
    overflow-x: visible;
    overflow-y: scroll;
    padding: 5px;
    margin-top: 3px;
    margin-left: -150px;
    background-color: #fff;
    border-radius: 5px;
    border: 1px solid #999;
    border-top: none;
  }
  
  .algolia-autocomplete .aa-dropdown-menu .aa-suggestion {
    cursor: pointer;
    padding: 5px 4px;
    border-bottom: 1px solid #eee;
  }
  
  .algolia-autocomplete .aa-dropdown-menu .aa-suggestion:last-of-type {
    border-bottom: none;
    margin-bottom: 2px;
  }
  
  .algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item {
    overflow: hidden;
    font-size: 0.8em;
    line-height: 1.4em;
  }
  
  .algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item h3 {
    font-size: 1rem;
    margin-block-start: 0;
    margin-block-end: 5px;
  }
  
  .algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item-description {
    display: inline-block;
    overflow: hidden;
    height: 2.8em;
    width: 80%;
    margin-right: 4%;
  }
  
  .algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item-preview {
    display: inline-block;
    width: 15%;
  }
  
  .algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item-preview img {
    height: 3em;
    width: auto;
    display: none;
  }
  
  .algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item-preview img[src] {
    display: initial;
  }
  
  .algolia-autocomplete .aa-dropdown-menu .aa-suggestion.aa-cursor {
    background-color: #eee;
  }
  .algolia-autocomplete .aa-dropdown-menu .aa-suggestion em {
    font-weight: bold;
    font-style: normal;
  }
  
  </style>
  
  
  <!--/radix_placeholder_navigation_in_header-->
  <!--radix_placeholder_distill-->
  
  <style type="text/css">
  
  body {
    background-color: white;
  }
  
  .pandoc-table {
    width: 100%;
  }
  
  .pandoc-table>caption {
    margin-bottom: 10px;
  }
  
  .pandoc-table th:not([align]) {
    text-align: left;
  }
  
  .pagedtable-footer {
    font-size: 15px;
  }
  
  d-byline .byline {
    grid-template-columns: 2fr 2fr;
  }
  
  d-byline .byline h3 {
    margin-block-start: 1.5em;
  }
  
  d-byline .byline .authors-affiliations h3 {
    margin-block-start: 0.5em;
  }
  
  .authors-affiliations .orcid-id {
    width: 16px;
    height:16px;
    margin-left: 4px;
    margin-right: 4px;
    vertical-align: middle;
    padding-bottom: 2px;
  }
  
  d-title .dt-tags {
    margin-top: 1em;
    grid-column: text;
  }
  
  .dt-tags .dt-tag {
    text-decoration: none;
    display: inline-block;
    color: rgba(0,0,0,0.6);
    padding: 0em 0.4em;
    margin-right: 0.5em;
    margin-bottom: 0.4em;
    font-size: 70%;
    border: 1px solid rgba(0,0,0,0.2);
    border-radius: 3px;
    text-transform: uppercase;
    font-weight: 500;
  }
  
  d-article table.gt_table td,
  d-article table.gt_table th {
    border-bottom: none;
  }
  
  .html-widget {
    margin-bottom: 2.0em;
  }
  
  .l-screen-inset {
    padding-right: 16px;
  }
  
  .l-screen .caption {
    margin-left: 10px;
  }
  
  .shaded {
    background: rgb(247, 247, 247);
    padding-top: 20px;
    padding-bottom: 20px;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  }
  
  .shaded .html-widget {
    margin-bottom: 0;
    border: 1px solid rgba(0, 0, 0, 0.1);
  }
  
  .shaded .shaded-content {
    background: white;
  }
  
  .text-output {
    margin-top: 0;
    line-height: 1.5em;
  }
  
  .hidden {
    display: none !important;
  }
  
  d-article {
    padding-top: 2.5rem;
    padding-bottom: 30px;
  }
  
  d-appendix {
    padding-top: 30px;
  }
  
  d-article>p>img {
    width: 100%;
  }
  
  d-article h2 {
    margin: 1rem 0 1.5rem 0;
  }
  
  d-article h3 {
    margin-top: 1.5rem;
  }
  
  d-article iframe {
    border: 1px solid rgba(0, 0, 0, 0.1);
    margin-bottom: 2.0em;
    width: 100%;
  }
  
  /* Tweak code blocks */
  
  d-article div.sourceCode code,
  d-article pre code {
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
  }
  
  d-article pre,
  d-article div.sourceCode,
  d-article div.sourceCode pre {
    overflow: auto;
  }
  
  d-article div.sourceCode {
    background-color: white;
  }
  
  d-article div.sourceCode pre {
    padding-left: 10px;
    font-size: 12px;
    border-left: 2px solid rgba(0,0,0,0.1);
  }
  
  d-article pre {
    font-size: 12px;
    color: black;
    background: none;
    margin-top: 0;
    text-align: left;
    white-space: pre;
    word-spacing: normal;
    word-break: normal;
    word-wrap: normal;
    line-height: 1.5;
  
    -moz-tab-size: 4;
    -o-tab-size: 4;
    tab-size: 4;
  
    -webkit-hyphens: none;
    -moz-hyphens: none;
    -ms-hyphens: none;
    hyphens: none;
  }
  
  d-article pre a {
    border-bottom: none;
  }
  
  d-article pre a:hover {
    border-bottom: none;
    text-decoration: underline;
  }
  
  d-article details {
    grid-column: text;
    margin-bottom: 0.8em;
  }
  
  @media(min-width: 768px) {
  
  d-article pre,
  d-article div.sourceCode,
  d-article div.sourceCode pre {
    overflow: visible !important;
  }
  
  d-article div.sourceCode pre {
    padding-left: 18px;
    font-size: 14px;
  }
  
  d-article pre {
    font-size: 14px;
  }
  
  }
  
  figure img.external {
    background: white;
    border: 1px solid rgba(0, 0, 0, 0.1);
    box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
    padding: 18px;
    box-sizing: border-box;
  }
  
  /* CSS for d-contents */
  
  .d-contents {
    grid-column: text;
    color: rgba(0,0,0,0.8);
    font-size: 0.9em;
    padding-bottom: 1em;
    margin-bottom: 1em;
    padding-bottom: 0.5em;
    margin-bottom: 1em;
    padding-left: 0.25em;
    justify-self: start;
  }
  
  @media(min-width: 1000px) {
    .d-contents.d-contents-float {
      height: 0;
      grid-column-start: 1;
      grid-column-end: 4;
      justify-self: center;
      padding-right: 3em;
      padding-left: 2em;
    }
  }
  
  .d-contents nav h3 {
    font-size: 18px;
    margin-top: 0;
    margin-bottom: 1em;
  }
  
  .d-contents li {
    list-style-type: none
  }
  
  .d-contents nav > ul {
    padding-left: 0;
  }
  
  .d-contents ul {
    padding-left: 1em
  }
  
  .d-contents nav ul li {
    margin-top: 0.6em;
    margin-bottom: 0.2em;
  }
  
  .d-contents nav a {
    font-size: 13px;
    border-bottom: none;
    text-decoration: none
    color: rgba(0, 0, 0, 0.8);
  }
  
  .d-contents nav a:hover {
    text-decoration: underline solid rgba(0, 0, 0, 0.6)
  }
  
  .d-contents nav > ul > li > a {
    font-weight: 600;
  }
  
  .d-contents nav > ul > li > ul {
    font-weight: inherit;
  }
  
  .d-contents nav > ul > li > ul > li {
    margin-top: 0.2em;
  }
  
  
  .d-contents nav ul {
    margin-top: 0;
    margin-bottom: 0.25em;
  }
  
  .d-article-with-toc h2:nth-child(2) {
    margin-top: 0;
  }
  
  
  /* Figure */
  
  .figure {
    position: relative;
    margin-bottom: 2.5em;
    margin-top: 1.5em;
  }
  
  .figure img {
    width: 100%;
  }
  
  .figure .caption {
    color: rgba(0, 0, 0, 0.6);
    font-size: 12px;
    line-height: 1.5em;
  }
  
  .figure img.external {
    background: white;
    border: 1px solid rgba(0, 0, 0, 0.1);
    box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
    padding: 18px;
    box-sizing: border-box;
  }
  
  .figure .caption a {
    color: rgba(0, 0, 0, 0.6);
  }
  
  .figure .caption b,
  .figure .caption strong, {
    font-weight: 600;
    color: rgba(0, 0, 0, 1.0);
  }
  
  /* Citations */
  
  d-article .citation {
    color: inherit;
    cursor: inherit;
  }
  
  div.hanging-indent{
    margin-left: 1em; text-indent: -1em;
  }
  
  /* Citation hover box */
  
  .tippy-box[data-theme~=light-border] {
    background-color: rgba(250, 250, 250, 0.95);
  }
  
  .tippy-content > p {
    margin-bottom: 0;
    padding: 2px;
  }
  
  
  /* Tweak 1000px media break to show more text */
  
  @media(min-width: 1000px) {
    .base-grid,
    distill-header,
    d-title,
    d-abstract,
    d-article,
    d-appendix,
    distill-appendix,
    d-byline,
    d-footnote-list,
    d-citation-list,
    distill-footer {
      grid-template-columns: [screen-start] 1fr [page-start kicker-start] 80px [middle-start] 50px [text-start kicker-end] 65px 65px 65px 65px 65px 65px 65px 65px [text-end gutter-start] 65px [middle-end] 65px [page-end gutter-end] 1fr [screen-end];
      grid-column-gap: 16px;
    }
  
    .grid {
      grid-column-gap: 16px;
    }
  
    d-article {
      font-size: 1.06rem;
      line-height: 1.7em;
    }
    figure .caption, .figure .caption, figure figcaption {
      font-size: 13px;
    }
  }
  
  @media(min-width: 1180px) {
    .base-grid,
    distill-header,
    d-title,
    d-abstract,
    d-article,
    d-appendix,
    distill-appendix,
    d-byline,
    d-footnote-list,
    d-citation-list,
    distill-footer {
      grid-template-columns: [screen-start] 1fr [page-start kicker-start] 60px [middle-start] 60px [text-start kicker-end] 60px 60px 60px 60px 60px 60px 60px 60px [text-end gutter-start] 60px [middle-end] 60px [page-end gutter-end] 1fr [screen-end];
      grid-column-gap: 32px;
    }
  
    .grid {
      grid-column-gap: 32px;
    }
  }
  
  
  /* Get the citation styles for the appendix (not auto-injected on render since
     we do our own rendering of the citation appendix) */
  
  d-appendix .citation-appendix,
  .d-appendix .citation-appendix {
    font-size: 11px;
    line-height: 15px;
    border-left: 1px solid rgba(0, 0, 0, 0.1);
    padding-left: 18px;
    border: 1px solid rgba(0,0,0,0.1);
    background: rgba(0, 0, 0, 0.02);
    padding: 10px 18px;
    border-radius: 3px;
    color: rgba(150, 150, 150, 1);
    overflow: hidden;
    margin-top: -12px;
    white-space: pre-wrap;
    word-wrap: break-word;
  }
  
  /* Include appendix styles here so they can be overridden */
  
  d-appendix {
    contain: layout style;
    font-size: 0.8em;
    line-height: 1.7em;
    margin-top: 60px;
    margin-bottom: 0;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
    color: rgba(0,0,0,0.5);
    padding-top: 60px;
    padding-bottom: 48px;
  }
  
  d-appendix h3 {
    grid-column: page-start / text-start;
    font-size: 15px;
    font-weight: 500;
    margin-top: 1em;
    margin-bottom: 0;
    color: rgba(0,0,0,0.65);
  }
  
  d-appendix h3 + * {
    margin-top: 1em;
  }
  
  d-appendix ol {
    padding: 0 0 0 15px;
  }
  
  @media (min-width: 768px) {
    d-appendix ol {
      padding: 0 0 0 30px;
      margin-left: -30px;
    }
  }
  
  d-appendix li {
    margin-bottom: 1em;
  }
  
  d-appendix a {
    color: rgba(0, 0, 0, 0.6);
  }
  
  d-appendix > * {
    grid-column: text;
  }
  
  d-appendix > d-footnote-list,
  d-appendix > d-citation-list,
  d-appendix > distill-appendix {
    grid-column: screen;
  }
  
  /* Include footnote styles here so they can be overridden */
  
  d-footnote-list {
    contain: layout style;
  }
  
  d-footnote-list > * {
    grid-column: text;
  }
  
  d-footnote-list a.footnote-backlink {
    color: rgba(0,0,0,0.3);
    padding-left: 0.5em;
  }
  
  
  
  /* Anchor.js */
  
  .anchorjs-link {
    /*transition: all .25s linear; */
    text-decoration: none;
    border-bottom: none;
  }
  *:hover > .anchorjs-link {
    margin-left: -1.125em !important;
    text-decoration: none;
    border-bottom: none;
  }
  
  /* Social footer */
  
  .social_footer {
    margin-top: 30px;
    margin-bottom: 0;
    color: rgba(0,0,0,0.67);
  }
  
  .disqus-comments {
    margin-right: 30px;
  }
  
  .disqus-comment-count {
    border-bottom: 1px solid rgba(0, 0, 0, 0.4);
    cursor: pointer;
  }
  
  #disqus_thread {
    margin-top: 30px;
  }
  
  .article-sharing a {
    border-bottom: none;
    margin-right: 8px;
  }
  
  .article-sharing a:hover {
    border-bottom: none;
  }
  
  .sidebar-section.subscribe {
    font-size: 12px;
    line-height: 1.6em;
  }
  
  .subscribe p {
    margin-bottom: 0.5em;
  }
  
  
  .article-footer .subscribe {
    font-size: 15px;
    margin-top: 45px;
  }
  
  
  .sidebar-section.custom {
    font-size: 12px;
    line-height: 1.6em;
  }
  
  .custom p {
    margin-bottom: 0.5em;
  }
  
  /* Styles for listing layout (hide title) */
  .layout-listing d-title, .layout-listing .d-title {
    display: none;
  }
  
  /* Styles for posts lists (not auto-injected) */
  
  
  .posts-with-sidebar {
    padding-left: 45px;
    padding-right: 45px;
  }
  
  .posts-list .description h2,
  .posts-list .description p {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
  }
  
  .posts-list .description h2 {
    font-weight: 700;
    border-bottom: none;
    padding-bottom: 0;
  }
  
  .posts-list h2.post-tag {
    border-bottom: 1px solid rgba(0, 0, 0, 0.2);
    padding-bottom: 12px;
  }
  .posts-list {
    margin-top: 60px;
    margin-bottom: 24px;
  }
  
  .posts-list .post-preview {
    text-decoration: none;
    overflow: hidden;
    display: block;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    padding: 24px 0;
  }
  
  .post-preview-last {
    border-bottom: none !important;
  }
  
  .posts-list .posts-list-caption {
    grid-column: screen;
    font-weight: 400;
  }
  
  .posts-list .post-preview h2 {
    margin: 0 0 6px 0;
    line-height: 1.2em;
    font-style: normal;
    font-size: 24px;
  }
  
  .posts-list .post-preview p {
    margin: 0 0 12px 0;
    line-height: 1.4em;
    font-size: 16px;
  }
  
  .posts-list .post-preview .thumbnail {
    box-sizing: border-box;
    margin-bottom: 24px;
    position: relative;
    max-width: 500px;
  }
  .posts-list .post-preview img {
    width: 100%;
    display: block;
  }
  
  .posts-list .metadata {
    font-size: 12px;
    line-height: 1.4em;
    margin-bottom: 18px;
  }
  
  .posts-list .metadata > * {
    display: inline-block;
  }
  
  .posts-list .metadata .publishedDate {
    margin-right: 2em;
  }
  
  .posts-list .metadata .dt-authors {
    display: block;
    margin-top: 0.3em;
    margin-right: 2em;
  }
  
  .posts-list .dt-tags {
    display: block;
    line-height: 1em;
  }
  
  .posts-list .dt-tags .dt-tag {
    display: inline-block;
    color: rgba(0,0,0,0.6);
    padding: 0.3em 0.4em;
    margin-right: 0.2em;
    margin-bottom: 0.4em;
    font-size: 60%;
    border: 1px solid rgba(0,0,0,0.2);
    border-radius: 3px;
    text-transform: uppercase;
    font-weight: 500;
  }
  
  .posts-list img {
    opacity: 1;
  }
  
  .posts-list img[data-src] {
    opacity: 0;
  }
  
  .posts-more {
    clear: both;
  }
  
  
  .posts-sidebar {
    font-size: 16px;
  }
  
  .posts-sidebar h3 {
    font-size: 16px;
    margin-top: 0;
    margin-bottom: 0.5em;
    font-weight: 400;
    text-transform: uppercase;
  }
  
  .sidebar-section {
    margin-bottom: 30px;
  }
  
  .categories ul {
    list-style-type: none;
    margin: 0;
    padding: 0;
  }
  
  .categories li {
    color: rgba(0, 0, 0, 0.8);
    margin-bottom: 0;
  }
  
  .categories li>a {
    border-bottom: none;
  }
  
  .categories li>a:hover {
    border-bottom: 1px solid rgba(0, 0, 0, 0.4);
  }
  
  .categories .active {
    font-weight: 600;
  }
  
  .categories .category-count {
    color: rgba(0, 0, 0, 0.4);
  }
  
  
  @media(min-width: 768px) {
    .posts-list .post-preview h2 {
      font-size: 26px;
    }
    .posts-list .post-preview .thumbnail {
      float: right;
      width: 30%;
      margin-bottom: 0;
    }
    .posts-list .post-preview .description {
      float: left;
      width: 45%;
    }
    .posts-list .post-preview .metadata {
      float: left;
      width: 20%;
      margin-top: 8px;
    }
    .posts-list .post-preview p {
      margin: 0 0 12px 0;
      line-height: 1.5em;
      font-size: 16px;
    }
    .posts-with-sidebar .posts-list {
      float: left;
      width: 75%;
    }
    .posts-with-sidebar .posts-sidebar {
      float: right;
      width: 20%;
      margin-top: 60px;
      padding-top: 24px;
      padding-bottom: 24px;
    }
  }
  
  
  /* Improve display for browsers without grid (IE/Edge <= 15) */
  
  .downlevel {
    line-height: 1.6em;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
    margin: 0;
  }
  
  .downlevel .d-title {
    padding-top: 6rem;
    padding-bottom: 1.5rem;
  }
  
  .downlevel .d-title h1 {
    font-size: 50px;
    font-weight: 700;
    line-height: 1.1em;
    margin: 0 0 0.5rem;
  }
  
  .downlevel .d-title p {
    font-weight: 300;
    font-size: 1.2rem;
    line-height: 1.55em;
    margin-top: 0;
  }
  
  .downlevel .d-byline {
    padding-top: 0.8em;
    padding-bottom: 0.8em;
    font-size: 0.8rem;
    line-height: 1.8em;
  }
  
  .downlevel .section-separator {
    border: none;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
  }
  
  .downlevel .d-article {
    font-size: 1.06rem;
    line-height: 1.7em;
    padding-top: 1rem;
    padding-bottom: 2rem;
  }
  
  
  .downlevel .d-appendix {
    padding-left: 0;
    padding-right: 0;
    max-width: none;
    font-size: 0.8em;
    line-height: 1.7em;
    margin-bottom: 0;
    color: rgba(0,0,0,0.5);
    padding-top: 40px;
    padding-bottom: 48px;
  }
  
  .downlevel .footnotes ol {
    padding-left: 13px;
  }
  
  .downlevel .base-grid,
  .downlevel .distill-header,
  .downlevel .d-title,
  .downlevel .d-abstract,
  .downlevel .d-article,
  .downlevel .d-appendix,
  .downlevel .distill-appendix,
  .downlevel .d-byline,
  .downlevel .d-footnote-list,
  .downlevel .d-citation-list,
  .downlevel .distill-footer,
  .downlevel .appendix-bottom,
  .downlevel .posts-container {
    padding-left: 40px;
    padding-right: 40px;
  }
  
  @media(min-width: 768px) {
    .downlevel .base-grid,
    .downlevel .distill-header,
    .downlevel .d-title,
    .downlevel .d-abstract,
    .downlevel .d-article,
    .downlevel .d-appendix,
    .downlevel .distill-appendix,
    .downlevel .d-byline,
    .downlevel .d-footnote-list,
    .downlevel .d-citation-list,
    .downlevel .distill-footer,
    .downlevel .appendix-bottom,
    .downlevel .posts-container {
    padding-left: 150px;
    padding-right: 150px;
    max-width: 900px;
  }
  }
  
  .downlevel pre code {
    display: block;
    border-left: 2px solid rgba(0, 0, 0, .1);
    padding: 0 0 0 20px;
    font-size: 14px;
  }
  
  .downlevel code, .downlevel pre {
    color: black;
    background: none;
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
    text-align: left;
    white-space: pre;
    word-spacing: normal;
    word-break: normal;
    word-wrap: normal;
    line-height: 1.5;
  
    -moz-tab-size: 4;
    -o-tab-size: 4;
    tab-size: 4;
  
    -webkit-hyphens: none;
    -moz-hyphens: none;
    -ms-hyphens: none;
    hyphens: none;
  }
  
  .downlevel .posts-list .post-preview {
    color: inherit;
  }
  
  
  
  </style>
  
  <script type="application/javascript">
  
  function is_downlevel_browser() {
    if (bowser.isUnsupportedBrowser({ msie: "12", msedge: "16"},
                                   window.navigator.userAgent)) {
      return true;
    } else {
      return window.load_distill_framework === undefined;
    }
  }
  
  // show body when load is complete
  function on_load_complete() {
  
    // add anchors
    if (window.anchors) {
      window.anchors.options.placement = 'left';
      window.anchors.add('d-article > h2, d-article > h3, d-article > h4, d-article > h5');
    }
  
  
    // set body to visible
    document.body.style.visibility = 'visible';
  
    // force redraw for leaflet widgets
    if (window.HTMLWidgets) {
      var maps = window.HTMLWidgets.findAll(".leaflet");
      $.each(maps, function(i, el) {
        var map = this.getMap();
        map.invalidateSize();
        map.eachLayer(function(layer) {
          if (layer instanceof L.TileLayer)
            layer.redraw();
        });
      });
    }
  
    // trigger 'shown' so htmlwidgets resize
    $('d-article').trigger('shown');
  }
  
  function init_distill() {
  
    init_common();
  
    // create front matter
    var front_matter = $('<d-front-matter></d-front-matter>');
    $('#distill-front-matter').wrap(front_matter);
  
    // create d-title
    $('.d-title').changeElementType('d-title');
  
    // create d-byline
    var byline = $('<d-byline></d-byline>');
    $('.d-byline').replaceWith(byline);
  
    // create d-article
    var article = $('<d-article></d-article>');
    $('.d-article').wrap(article).children().unwrap();
  
    // move posts container into article
    $('.posts-container').appendTo($('d-article'));
  
    // create d-appendix
    $('.d-appendix').changeElementType('d-appendix');
  
    // flag indicating that we have appendix items
    var appendix = $('.appendix-bottom').children('h3').length > 0;
  
    // replace footnotes with <d-footnote>
    $('.footnote-ref').each(function(i, val) {
      appendix = true;
      var href = $(this).attr('href');
      var id = href.replace('#', '');
      var fn = $('#' + id);
      var fn_p = $('#' + id + '>p');
      fn_p.find('.footnote-back').remove();
      var text = fn_p.html();
      var dtfn = $('<d-footnote></d-footnote>');
      dtfn.html(text);
      $(this).replaceWith(dtfn);
    });
    // remove footnotes
    $('.footnotes').remove();
  
    // move refs into #references-listing
    $('#references-listing').replaceWith($('#refs'));
  
    $('h1.appendix, h2.appendix').each(function(i, val) {
      $(this).changeElementType('h3');
    });
    $('h3.appendix').each(function(i, val) {
      var id = $(this).attr('id');
      $('.d-contents a[href="#' + id + '"]').parent().remove();
      appendix = true;
      $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('d-appendix'));
    });
  
    // show d-appendix if we have appendix content
    $("d-appendix").css('display', appendix ? 'grid' : 'none');
  
    // localize layout chunks to just output
    $('.layout-chunk').each(function(i, val) {
  
      // capture layout
      var layout = $(this).attr('data-layout');
  
      // apply layout to markdown level block elements
      var elements = $(this).children().not('details, div.sourceCode, pre, script');
      elements.each(function(i, el) {
        var layout_div = $('<div class="' + layout + '"></div>');
        if (layout_div.hasClass('shaded')) {
          var shaded_content = $('<div class="shaded-content"></div>');
          $(this).wrap(shaded_content);
          $(this).parent().wrap(layout_div);
        } else {
          $(this).wrap(layout_div);
        }
      });
  
  
      // unwrap the layout-chunk div
      $(this).children().unwrap();
    });
  
    // remove code block used to force  highlighting css
    $('.distill-force-highlighting-css').parent().remove();
  
    // remove empty line numbers inserted by pandoc when using a
    // custom syntax highlighting theme
    $('code.sourceCode a:empty').remove();
  
    // load distill framework
    load_distill_framework();
  
    // wait for window.distillRunlevel == 4 to do post processing
    function distill_post_process() {
  
      if (!window.distillRunlevel || window.distillRunlevel < 4)
        return;
  
      // hide author/affiliations entirely if we have no authors
      var front_matter = JSON.parse($("#distill-front-matter").html());
      var have_authors = front_matter.authors && front_matter.authors.length > 0;
      if (!have_authors)
        $('d-byline').addClass('hidden');
  
      // article with toc class
      $('.d-contents').parent().addClass('d-article-with-toc');
  
      // strip links that point to #
      $('.authors-affiliations').find('a[href="#"]').removeAttr('href');
  
      // add orcid ids
      $('.authors-affiliations').find('.author').each(function(i, el) {
        var orcid_id = front_matter.authors[i].orcidID;
        if (orcid_id) {
          var a = $('<a></a>');
          a.attr('href', 'https://orcid.org/' + orcid_id);
          var img = $('<img></img>');
          img.addClass('orcid-id');
          img.attr('alt', 'ORCID ID');
          img.attr('src','data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg==');
          a.append(img);
          $(this).append(a);
        }
      });
  
      // hide elements of author/affiliations grid that have no value
      function hide_byline_column(caption) {
        $('d-byline').find('h3:contains("' + caption + '")').parent().css('visibility', 'hidden');
      }
  
      // affiliations
      var have_affiliations = false;
      for (var i = 0; i<front_matter.authors.length; ++i) {
        var author = front_matter.authors[i];
        if (author.affiliation !== "&nbsp;") {
          have_affiliations = true;
          break;
        }
      }
      if (!have_affiliations)
        $('d-byline').find('h3:contains("Affiliations")').css('visibility', 'hidden');
  
      // published date
      if (!front_matter.publishedDate)
        hide_byline_column("Published");
  
      // document object identifier
      var doi = $('d-byline').find('h3:contains("DOI")');
      var doi_p = doi.next().empty();
      if (!front_matter.doi) {
        // if we have a citation and valid citationText then link to that
        if ($('#citation').length > 0 && front_matter.citationText) {
          doi.html('Citation');
          $('<a href="#citation"></a>')
            .text(front_matter.citationText)
            .appendTo(doi_p);
        } else {
          hide_byline_column("DOI");
        }
      } else {
        $('<a></a>')
           .attr('href', "https://doi.org/" + front_matter.doi)
           .html(front_matter.doi)
           .appendTo(doi_p);
      }
  
       // change plural form of authors/affiliations
      if (front_matter.authors.length === 1) {
        var grid = $('.authors-affiliations');
        grid.children('h3:contains("Authors")').text('Author');
        grid.children('h3:contains("Affiliations")').text('Affiliation');
      }
  
      // remove d-appendix and d-footnote-list local styles
      $('d-appendix > style:first-child').remove();
      $('d-footnote-list > style:first-child').remove();
  
      // move appendix-bottom entries to the bottom
      $('.appendix-bottom').appendTo('d-appendix').children().unwrap();
      $('.appendix-bottom').remove();
  
      // hoverable references
      $('span.citation[data-cites]').each(function() {
        var refHtml = $('#ref-' + $(this).attr('data-cites')).html();
        window.tippy(this, {
          allowHTML: true,
          content: refHtml,
          maxWidth: 500,
          interactive: true,
          interactiveBorder: 10,
          theme: 'light-border',
          placement: 'bottom-start'
        });
      });
  
      // clear polling timer
      clearInterval(tid);
  
      // show body now that everything is ready
      on_load_complete();
    }
  
    var tid = setInterval(distill_post_process, 50);
    distill_post_process();
  
  }
  
  function init_downlevel() {
  
    init_common();
  
     // insert hr after d-title
    $('.d-title').after($('<hr class="section-separator"/>'));
  
    // check if we have authors
    var front_matter = JSON.parse($("#distill-front-matter").html());
    var have_authors = front_matter.authors && front_matter.authors.length > 0;
  
    // manage byline/border
    if (!have_authors)
      $('.d-byline').remove();
    $('.d-byline').after($('<hr class="section-separator"/>'));
    $('.d-byline a').remove();
  
    // remove toc
    $('.d-contents').remove();
  
    // move appendix elements
    $('h1.appendix, h2.appendix').each(function(i, val) {
      $(this).changeElementType('h3');
    });
    $('h3.appendix').each(function(i, val) {
      $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('.d-appendix'));
    });
  
  
    // inject headers into references and footnotes
    var refs_header = $('<h3></h3>');
    refs_header.text('References');
    $('#refs').prepend(refs_header);
  
    var footnotes_header = $('<h3></h3');
    footnotes_header.text('Footnotes');
    $('.footnotes').children('hr').first().replaceWith(footnotes_header);
  
    // move appendix-bottom entries to the bottom
    $('.appendix-bottom').appendTo('.d-appendix').children().unwrap();
    $('.appendix-bottom').remove();
  
    // remove appendix if it's empty
    if ($('.d-appendix').children().length === 0)
      $('.d-appendix').remove();
  
    // prepend separator above appendix
    $('.d-appendix').before($('<hr class="section-separator" style="clear: both"/>'));
  
    // trim code
    $('pre>code').each(function(i, val) {
      $(this).html($.trim($(this).html()));
    });
  
    // move posts-container right before article
    $('.posts-container').insertBefore($('.d-article'));
  
    $('body').addClass('downlevel');
  
    on_load_complete();
  }
  
  
  function init_common() {
  
    // jquery plugin to change element types
    (function($) {
      $.fn.changeElementType = function(newType) {
        var attrs = {};
  
        $.each(this[0].attributes, function(idx, attr) {
          attrs[attr.nodeName] = attr.nodeValue;
        });
  
        this.replaceWith(function() {
          return $("<" + newType + "/>", attrs).append($(this).contents());
        });
      };
    })(jQuery);
  
    // prevent underline for linked images
    $('a > img').parent().css({'border-bottom' : 'none'});
  
    // mark non-body figures created by knitr chunks as 100% width
    $('.layout-chunk').each(function(i, val) {
      var figures = $(this).find('img, .html-widget');
      if ($(this).attr('data-layout') !== "l-body") {
        figures.css('width', '100%');
      } else {
        figures.css('max-width', '100%');
        figures.filter("[width]").each(function(i, val) {
          var fig = $(this);
          fig.css('width', fig.attr('width') + 'px');
        });
  
      }
    });
  
    // auto-append index.html to post-preview links in file: protocol
    // and in rstudio ide preview
    $('.post-preview').each(function(i, val) {
      if (window.location.protocol === "file:")
        $(this).attr('href', $(this).attr('href') + "index.html");
    });
  
    // get rid of index.html references in header
    if (window.location.protocol !== "file:") {
      $('.distill-site-header a[href]').each(function(i,val) {
        $(this).attr('href', $(this).attr('href').replace("index.html", "./"));
      });
    }
  
    // add class to pandoc style tables
    $('tr.header').parent('thead').parent('table').addClass('pandoc-table');
    $('.kable-table').children('table').addClass('pandoc-table');
  
    // add figcaption style to table captions
    $('caption').parent('table').addClass("figcaption");
  
    // initialize posts list
    if (window.init_posts_list)
      window.init_posts_list();
  
    // implmement disqus comment link
    $('.disqus-comment-count').click(function() {
      window.headroom_prevent_pin = true;
      $('#disqus_thread').toggleClass('hidden');
      if (!$('#disqus_thread').hasClass('hidden')) {
        var offset = $(this).offset();
        $(window).resize();
        $('html, body').animate({
          scrollTop: offset.top - 35
        });
      }
    });
  }
  
  document.addEventListener('DOMContentLoaded', function() {
    if (is_downlevel_browser())
      init_downlevel();
    else
      window.addEventListener('WebComponentsReady', init_distill);
  });
  
  </script>
  
  <!--/radix_placeholder_distill-->
  <script src="site_libs/popper-2.6.0/popper.min.js"></script>
  <link href="site_libs/tippy-6.2.7/tippy.css" rel="stylesheet" />
  <link href="site_libs/tippy-6.2.7/tippy-light-border.css" rel="stylesheet" />
  <script src="site_libs/tippy-6.2.7/tippy.umd.min.js"></script>
  <script src="site_libs/anchor-4.2.2/anchor.min.js"></script>
  <script src="site_libs/bowser-1.9.3/bowser.min.js"></script>
  <script src="site_libs/webcomponents-2.0.0/webcomponents.js"></script>
  <script src="site_libs/distill-2.2.21/template.v2.js"></script>
  <!--radix_placeholder_site_in_header-->
  <!--/radix_placeholder_site_in_header-->


</head>

<body>

<!--radix_placeholder_front_matter-->

<script id="distill-front-matter" type="text/json">
{"title":"Untitled","authors":[]}
</script>

<!--/radix_placeholder_front_matter-->
<!--radix_placeholder_navigation_before_body-->
<header class="header header--fixed" role="banner">
<nav class="distill-site-nav distill-site-header">
<div class="nav-left">
<a href="index.html" class="title">C057</a>
<a href="index.html">Introduction</a>
<a href="C057_Cooney.demultiplex.html">Demultiplexing</a>
<a href="C057_Cooney.preprocess.html">Preprocessing</a>
<a href="C057_Cooney.cell_selection.html">Selecting biologically relevant cells</a>
<a href="C057_Cooney.annotate.html">Annotating cells</a>
<a href="C057_Cooney.multi-sample_comparisons.html">Differential analyses</a>
<a href="C057_Cooney.repertoire-seq.html">Immune repertoire analysis</a>
<div class="nav-dropdown">
<button class="nav-dropbtn">
Supplementary files
 
<span class="down-arrow">&#x25BE;</span>
</button>
<div class="nav-dropdown-content">
<a href="../output/CellRanger/">CellRanger reports</a>
<a href="../output/marker_genes/">Marker gene tables</a>
<a href="../output/DEGs/">Differentially expressed genes</a>
<a href="../output/glimma-plots/">Glimma plots</a>
</div>
</div>
</div>
<div class="nav-right">
<a href="https://github.com/WEHISCORE/C057_Cooney">
<i class="fa fa-github" aria-hidden="true"></i>
</a>
<a href="javascript:void(0);" class="nav-toggle">&#9776;</a>
</div>
</nav>
</header>
<!--/radix_placeholder_navigation_before_body-->
<!--radix_placeholder_site_before_body-->
<!--/radix_placeholder_site_before_body-->

<div class="d-title">
<h1>annotation_DE_DA.R</h1>
<!--radix_placeholder_categories-->
<!--/radix_placeholder_categories-->

</div>

<div class="d-byline">
  
  hickey
  
<br/>2021-04-01
</div>

<div class="d-article">
<div class="layout-chunk" data-layout="l-body">
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># Setup ------------------------------------------------------------------------</span>

<span class='co'># Takes off from cell selection</span>

<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'>SingleCellExperiment</span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://here.r-lib.org/'>here</a></span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://wilkelab.org/cowplot/'>cowplot</a></span><span class='op'>)</span>

<span class='va'>sce</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/readRDS.html'>readRDS</a></span><span class='op'>(</span><span class='fu'><a href='https://here.r-lib.org//reference/here.html'>here</a></span><span class='op'>(</span><span class='st'>"data/SCEs/C057_Cooney.cells_selected.SCE.rds"</span><span class='op'>)</span><span class='op'>)</span>

<span class='co'># data frames containing co-ordinates and factors for creating reduced</span>
<span class='co'># dimensionality plots.</span>
<span class='va'>umap_df</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/cbind.html'>cbind</a></span><span class='op'>(</span>
  <span class='fu'><a href='https://rdrr.io/r/base/data.frame.html'>data.frame</a></span><span class='op'>(</span>
    x <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/pkg/SingleCellExperiment/man/reducedDims.html'>reducedDim</a></span><span class='op'>(</span><span class='va'>sce</span>, <span class='st'>"UMAP"</span><span class='op'>)</span><span class='op'>[</span>, <span class='fl'>1</span><span class='op'>]</span>,
    y <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/pkg/SingleCellExperiment/man/reducedDims.html'>reducedDim</a></span><span class='op'>(</span><span class='va'>sce</span>, <span class='st'>"UMAP"</span><span class='op'>)</span><span class='op'>[</span>, <span class='fl'>2</span><span class='op'>]</span><span class='op'>)</span>,
  <span class='fu'><a href='https://rdrr.io/r/base/as.data.frame.html'>as.data.frame</a></span><span class='op'>(</span><span class='fu'>colData</span><span class='op'>(</span><span class='va'>sce</span><span class='op'>)</span><span class='op'>[</span>, <span class='op'>!</span><span class='fu'><a href='https://rdrr.io/r/base/colnames.html'>colnames</a></span><span class='op'>(</span><span class='fu'>colData</span><span class='op'>(</span><span class='va'>sce</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%in%</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"TRA"</span>, <span class='st'>"TRB"</span><span class='op'>)</span><span class='op'>]</span><span class='op'>)</span><span class='op'>)</span>

<span class='co'># Some useful colours</span>
<span class='va'>sample_colours</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/setNames.html'>setNames</a></span><span class='op'>(</span>
  <span class='fu'><a href='https://rdrr.io/r/base/unique.html'>unique</a></span><span class='op'>(</span><span class='va'>sce</span><span class='op'>$</span><span class='va'>sample_colours</span><span class='op'>)</span>,
  <span class='fu'><a href='https://rdrr.io/r/base/unique.html'>unique</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/names.html'>names</a></span><span class='op'>(</span><span class='va'>sce</span><span class='op'>$</span><span class='va'>sample_colours</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span>
<span class='va'>treatment_colours</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/setNames.html'>setNames</a></span><span class='op'>(</span>
  <span class='fu'><a href='https://rdrr.io/r/base/unique.html'>unique</a></span><span class='op'>(</span><span class='va'>sce</span><span class='op'>$</span><span class='va'>treatment_colours</span><span class='op'>)</span>,
  <span class='fu'><a href='https://rdrr.io/r/base/unique.html'>unique</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/names.html'>names</a></span><span class='op'>(</span><span class='va'>sce</span><span class='op'>$</span><span class='va'>treatment_colours</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span>
<span class='va'>cluster_colours</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/setNames.html'>setNames</a></span><span class='op'>(</span>
  <span class='fu'><a href='https://rdrr.io/r/base/unique.html'>unique</a></span><span class='op'>(</span><span class='va'>sce</span><span class='op'>$</span><span class='va'>cluster_colours</span><span class='op'>)</span>,
  <span class='fu'><a href='https://rdrr.io/r/base/unique.html'>unique</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/names.html'>names</a></span><span class='op'>(</span><span class='va'>sce</span><span class='op'>$</span><span class='va'>cluster_colours</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span>

<span class='co'># Some useful gene sets</span>
<span class='va'>mito_set</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/colnames.html'>rownames</a></span><span class='op'>(</span><span class='va'>sce</span><span class='op'>)</span><span class='op'>[</span><span class='fu'><a href='https://rdrr.io/r/base/which.html'>which</a></span><span class='op'>(</span><span class='fu'>rowData</span><span class='op'>(</span><span class='va'>sce</span><span class='op'>)</span><span class='op'>$</span><span class='va'>CHR</span> <span class='op'>==</span> <span class='st'>"MT"</span><span class='op'>)</span><span class='op'>]</span>
<span class='va'>ribo_set</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/grep.html'>grep</a></span><span class='op'>(</span><span class='st'>"^RP(S|L)"</span>, <span class='fu'><a href='https://rdrr.io/r/base/colnames.html'>rownames</a></span><span class='op'>(</span><span class='va'>sce</span><span class='op'>)</span>, value <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span>
<span class='co'># NOTE: A more curated approach for identifying ribosomal protein genes</span>
<span class='co'>#       (https://github.com/Bioconductor/OrchestratingSingleCellAnalysis-base/blob/ae201bf26e3e4fa82d9165d8abf4f4dc4b8e5a68/feature-selection.Rmd#L376-L380)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://igordot.github.io/msigdbr'>msigdbr</a></span><span class='op'>)</span>
<span class='va'>c2_sets</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://igordot.github.io/msigdbr/reference/msigdbr.html'>msigdbr</a></span><span class='op'>(</span>species <span class='op'>=</span> <span class='st'>"Homo sapiens"</span>, category <span class='op'>=</span> <span class='st'>"C2"</span><span class='op'>)</span>
<span class='va'>ribo_set</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/sets.html'>union</a></span><span class='op'>(</span>
  <span class='va'>ribo_set</span>,
  <span class='va'>c2_sets</span><span class='op'>[</span><span class='va'>c2_sets</span><span class='op'>$</span><span class='va'>gs_name</span> <span class='op'>==</span> <span class='st'>"KEGG_RIBOSOME"</span>, <span class='op'>]</span><span class='op'>$</span><span class='va'>human_gene_symbol</span><span class='op'>)</span>

<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'>scran</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/base/Random.html'>set.seed</a></span><span class='op'>(</span><span class='fl'>1000</span><span class='op'>)</span>
<span class='va'>var_fit</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scran/man/modelGeneVarByPoisson.html'>modelGeneVarByPoisson</a></span><span class='op'>(</span><span class='va'>sce</span>, block <span class='op'>=</span> <span class='va'>sce</span><span class='op'>$</span><span class='va'>batch</span><span class='op'>)</span>
<span class='va'>hvg</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scran/man/getTopHVGs.html'>getTopHVGs</a></span><span class='op'>(</span><span class='va'>var_fit</span>, var.threshold <span class='op'>=</span> <span class='fl'>0</span><span class='op'>)</span>
<span class='va'>is_mito</span> <span class='op'>&lt;-</span> <span class='va'>hvg</span> <span class='op'>%in%</span> <span class='va'>mito_set</span>
<span class='va'>is_ribo</span> <span class='op'>&lt;-</span> <span class='va'>hvg</span> <span class='op'>%in%</span> <span class='va'>ribo_set</span>
<span class='va'>hvg</span> <span class='op'>&lt;-</span> <span class='va'>hvg</span><span class='op'>[</span><span class='op'>!</span><span class='op'>(</span><span class='va'>is_mito</span> <span class='op'>|</span> <span class='va'>is_ribo</span><span class='op'>)</span><span class='op'>]</span>

<span class='fu'><a href='https://rdrr.io/r/base/Random.html'>set.seed</a></span><span class='op'>(</span><span class='fl'>1010</span><span class='op'>)</span>
<span class='va'>var_fit.sample</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scran/man/modelGeneVarByPoisson.html'>modelGeneVarByPoisson</a></span><span class='op'>(</span><span class='va'>sce</span>, block <span class='op'>=</span> <span class='va'>sce</span><span class='op'>$</span><span class='va'>Sample</span><span class='op'>)</span>
<span class='va'>hvg.sample</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scran/man/getTopHVGs.html'>getTopHVGs</a></span><span class='op'>(</span><span class='va'>var_fit.sample</span>, var.threshold <span class='op'>=</span> <span class='fl'>0</span><span class='op'>)</span>
<span class='va'>is_mito</span> <span class='op'>&lt;-</span> <span class='va'>hvg.sample</span> <span class='op'>%in%</span> <span class='va'>mito_set</span>
<span class='va'>is_ribo</span> <span class='op'>&lt;-</span> <span class='va'>hvg.sample</span> <span class='op'>%in%</span> <span class='va'>ribo_set</span>
<span class='va'>hvg.sample</span> <span class='op'>&lt;-</span> <span class='va'>hvg.sample</span><span class='op'>[</span><span class='op'>!</span><span class='op'>(</span><span class='va'>is_mito</span> <span class='op'>|</span> <span class='va'>is_ribo</span><span class='op'>)</span><span class='op'>]</span>

<span class='co'># Re-process original data -----------------------------------------------------</span>

<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='http://bioconductor.org/packages/scater/'>scater</a></span><span class='op'>)</span>
<span class='co'># NOTE: This is a no-op if the same hvg set is used from cell selection.</span>
<span class='fu'><a href='https://rdrr.io/r/base/Random.html'>set.seed</a></span><span class='op'>(</span><span class='fl'>11235</span><span class='op'>)</span>
<span class='va'>sce</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scran/man/denoisePCA.html'>denoisePCA</a></span><span class='op'>(</span><span class='va'>sce</span>, <span class='va'>var_fit</span>, subset.row <span class='op'>=</span> <span class='va'>hvg</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/base/Random.html'>set.seed</a></span><span class='op'>(</span><span class='fl'>8875</span><span class='op'>)</span>
<span class='va'>sce</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scater/man/runUMAP.html'>runUMAP</a></span><span class='op'>(</span><span class='va'>sce</span>, dimred <span class='op'>=</span> <span class='st'>"PCA"</span><span class='op'>)</span>
<span class='va'>umap_df</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/cbind.html'>cbind</a></span><span class='op'>(</span>
  <span class='fu'><a href='https://rdrr.io/r/base/data.frame.html'>data.frame</a></span><span class='op'>(</span>
    x <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/pkg/SingleCellExperiment/man/reducedDims.html'>reducedDim</a></span><span class='op'>(</span><span class='va'>sce</span>, <span class='st'>"UMAP"</span><span class='op'>)</span><span class='op'>[</span>, <span class='fl'>1</span><span class='op'>]</span>,
    y <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/pkg/SingleCellExperiment/man/reducedDims.html'>reducedDim</a></span><span class='op'>(</span><span class='va'>sce</span>, <span class='st'>"UMAP"</span><span class='op'>)</span><span class='op'>[</span>, <span class='fl'>2</span><span class='op'>]</span><span class='op'>)</span>,
  <span class='fu'><a href='https://rdrr.io/r/base/as.data.frame.html'>as.data.frame</a></span><span class='op'>(</span><span class='fu'>colData</span><span class='op'>(</span><span class='va'>sce</span><span class='op'>)</span><span class='op'>[</span>, <span class='op'>!</span><span class='fu'><a href='https://rdrr.io/r/base/colnames.html'>colnames</a></span><span class='op'>(</span><span class='fu'>colData</span><span class='op'>(</span><span class='va'>sce</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%in%</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"TRA"</span>, <span class='st'>"TRB"</span><span class='op'>)</span><span class='op'>]</span><span class='op'>)</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/base/Random.html'>set.seed</a></span><span class='op'>(</span><span class='fl'>8111</span><span class='op'>)</span>
<span class='va'>snn_gr</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scran/man/buildSNNGraph.html'>buildSNNGraph</a></span><span class='op'>(</span><span class='va'>sce</span>, use.dimred <span class='op'>=</span> <span class='st'>"PCA"</span><span class='op'>)</span>
<span class='va'>clusters</span> <span class='op'>&lt;-</span> <span class='fu'>igraph</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/pkg/igraph/man/cluster_louvain.html'>cluster_louvain</a></span><span class='op'>(</span><span class='va'>snn_gr</span><span class='op'>)</span>
<span class='va'>sce</span><span class='op'>$</span><span class='va'>cluster</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/factor.html'>factor</a></span><span class='op'>(</span><span class='va'>clusters</span><span class='op'>$</span><span class='va'>membership</span><span class='op'>)</span>
<span class='va'>umap_df</span><span class='op'>$</span><span class='va'>cluster</span> <span class='op'>&lt;-</span> <span class='va'>sce</span><span class='op'>$</span><span class='va'>cluster</span>
<span class='va'>cluster_colours</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/setNames.html'>setNames</a></span><span class='op'>(</span>
  <span class='fu'>Polychrome</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/pkg/Polychrome/man/palettes.html'>glasbey.colors</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/nlevels.html'>nlevels</a></span><span class='op'>(</span><span class='va'>sce</span><span class='op'>$</span><span class='va'>cluster</span><span class='op'>)</span> <span class='op'>+</span> <span class='fl'>1</span><span class='op'>)</span><span class='op'>[</span><span class='op'>-</span><span class='fl'>1</span><span class='op'>]</span>,
  <span class='fu'><a href='https://rdrr.io/r/base/levels.html'>levels</a></span><span class='op'>(</span><span class='va'>sce</span><span class='op'>$</span><span class='va'>cluster</span><span class='op'>)</span><span class='op'>)</span>
<span class='va'>sce</span><span class='op'>$</span><span class='va'>cluster_colours</span> <span class='op'>&lt;-</span> <span class='va'>cluster_colours</span><span class='op'>[</span><span class='va'>sce</span><span class='op'>$</span><span class='va'>cluster</span><span class='op'>]</span>

<span class='co'># Diagnosing batch effects -----------------------------------------------------</span>

<span class='co'># Samples were collected in a single capture, but there are some strong</span>
<span class='co'># differences between Venetoclax and Control samples.</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://patchwork.data-imaginist.com'>patchwork</a></span><span class='op'>)</span>
<span class='co'># Some clusters are highly treatment specific (just another way of showing</span>
<span class='co'># what is shown in the plots at the end of 'cell selection').</span>
<span class='fu'><a href='https://rdrr.io/r/base/table.html'>table</a></span><span class='op'>(</span>cluster <span class='op'>=</span> <span class='va'>sce</span><span class='op'>$</span><span class='va'>cluster</span>, treatment <span class='op'>=</span> <span class='va'>sce</span><span class='op'>$</span><span class='va'>Treatment</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<pre><code>       treatment
cluster Infected Uninfected
     1       141       1248
     2      1651         66
     3        86         18
     4       173        379
     5        37        816
     6        13        291
     7       133        856
     8       724        671
     9        71        840
     10      827         90</code></pre>
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>uncorrected.p1</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scater/man/plot_reddim.html'>plotUMAP</a></span><span class='op'>(</span><span class='va'>sce</span>, colour_by <span class='op'>=</span> <span class='st'>"Treatment"</span>, point_size <span class='op'>=</span> <span class='fl'>0.5</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>scale_colour_manual</span><span class='op'>(</span>values <span class='op'>=</span> <span class='va'>treatment_colours</span>, name <span class='op'>=</span> <span class='st'>"Treatment"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>ggtitle</span><span class='op'>(</span><span class='st'>"Uncorrected"</span><span class='op'>)</span>
<span class='va'>uncorrected.p2</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scater/man/plot_reddim.html'>plotUMAP</a></span><span class='op'>(</span><span class='va'>sce</span>, colour_by <span class='op'>=</span> <span class='st'>"cluster"</span>, point_size <span class='op'>=</span> <span class='fl'>0.5</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>scale_colour_manual</span><span class='op'>(</span>values <span class='op'>=</span> <span class='va'>cluster_colours</span>, name <span class='op'>=</span> <span class='st'>"cluster"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>ggtitle</span><span class='op'>(</span><span class='st'>"Uncorrected"</span><span class='op'>)</span>
<span class='va'>uncorrected.p1</span> <span class='op'>+</span> <span class='va'>uncorrected.p2</span>
</code></pre>
</div>
</details>
<img src="annotation_DE_DA_files/figure-html5/unnamed-chunk-1-1.png" width="624" />
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://wilkelab.org/cowplot/reference/plot_grid.html'>plot_grid</a></span><span class='op'>(</span>
  <span class='fu'>ggplot</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/as.data.frame.html'>as.data.frame</a></span><span class='op'>(</span><span class='fu'>colData</span><span class='op'>(</span><span class='va'>sce</span><span class='op'>)</span><span class='op'>[</span>, <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"cluster"</span>, <span class='st'>"Sample"</span><span class='op'>)</span><span class='op'>]</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>geom_bar</span><span class='op'>(</span>
      <span class='fu'>aes</span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>cluster</span>, fill <span class='op'>=</span> <span class='va'>Sample</span><span class='op'>)</span>,
      position <span class='op'>=</span> <span class='fu'>position_fill</span><span class='op'>(</span>reverse <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>coord_flip</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>ylab</span><span class='op'>(</span><span class='st'>"Frequency"</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>scale_fill_manual</span><span class='op'>(</span>values <span class='op'>=</span> <span class='va'>sample_colours</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'><a href='https://wilkelab.org/cowplot/reference/theme_cowplot.html'>theme_cowplot</a></span><span class='op'>(</span>font_size <span class='op'>=</span> <span class='fl'>8</span><span class='op'>)</span>,
  <span class='fu'>ggplot</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/as.data.frame.html'>as.data.frame</a></span><span class='op'>(</span><span class='fu'>colData</span><span class='op'>(</span><span class='va'>sce</span><span class='op'>)</span><span class='op'>[</span>, <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"cluster"</span>, <span class='st'>"Treatment"</span><span class='op'>)</span><span class='op'>]</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>geom_bar</span><span class='op'>(</span>
      <span class='fu'>aes</span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>cluster</span>, fill <span class='op'>=</span> <span class='va'>Treatment</span><span class='op'>)</span>,
      position <span class='op'>=</span> <span class='fu'>position_fill</span><span class='op'>(</span>reverse <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>coord_flip</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>ylab</span><span class='op'>(</span><span class='st'>"Frequency"</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>scale_fill_manual</span><span class='op'>(</span>values <span class='op'>=</span> <span class='va'>treatment_colours</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'><a href='https://wilkelab.org/cowplot/reference/theme_cowplot.html'>theme_cowplot</a></span><span class='op'>(</span>font_size <span class='op'>=</span> <span class='fl'>8</span><span class='op'>)</span>,
  <span class='fu'>ggplot</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/as.data.frame.html'>as.data.frame</a></span><span class='op'>(</span><span class='fu'>colData</span><span class='op'>(</span><span class='va'>sce</span><span class='op'>)</span><span class='op'>[</span>, <span class='st'>"cluster"</span>, drop <span class='op'>=</span> <span class='cn'>FALSE</span><span class='op'>]</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>geom_bar</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>cluster</span>, fill <span class='op'>=</span> <span class='va'>cluster</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>coord_flip</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>ylab</span><span class='op'>(</span><span class='st'>"Number of droplets"</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>scale_fill_manual</span><span class='op'>(</span>values <span class='op'>=</span> <span class='va'>cluster_colours</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'><a href='https://wilkelab.org/cowplot/reference/theme_cowplot.html'>theme_cowplot</a></span><span class='op'>(</span>font_size <span class='op'>=</span> <span class='fl'>8</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>guides</span><span class='op'>(</span>fill <span class='op'>=</span> <span class='cn'>FALSE</span><span class='op'>)</span>,
  align <span class='op'>=</span> <span class='st'>"h"</span>,
  ncol <span class='op'>=</span> <span class='fl'>3</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<img src="annotation_DE_DA_files/figure-html5/unnamed-chunk-1-2.png" width="624" />
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># Linear regression with rescaleBatches() --------------------------------------</span>

<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'>batchelor</span><span class='op'>)</span>
<span class='va'>rescaled</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/batchelor/man/rescaleBatches.html'>rescaleBatches</a></span><span class='op'>(</span><span class='va'>sce</span>, batch <span class='op'>=</span> <span class='va'>sce</span><span class='op'>$</span><span class='va'>Treatment</span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'>scran</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/base/Random.html'>set.seed</a></span><span class='op'>(</span><span class='fl'>666</span><span class='op'>)</span>
<span class='va'>rescaled</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scran/man/denoisePCA.html'>denoisePCA</a></span><span class='op'>(</span>
  <span class='va'>rescaled</span>,
  <span class='va'>var_fit</span>,
  subset.row <span class='op'>=</span> <span class='va'>hvg</span>,
  assay.type <span class='op'>=</span> <span class='st'>"corrected"</span><span class='op'>)</span>
<span class='va'>snn.gr</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scran/man/buildSNNGraph.html'>buildSNNGraph</a></span><span class='op'>(</span><span class='va'>rescaled</span>, use.dimred<span class='op'>=</span><span class='st'>"PCA"</span><span class='op'>)</span>
<span class='va'>clusters.resc</span> <span class='op'>&lt;-</span> <span class='fu'>igraph</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/pkg/igraph/man/cluster_louvain.html'>cluster_louvain</a></span><span class='op'>(</span><span class='va'>snn.gr</span><span class='op'>)</span><span class='op'>$</span><span class='va'>membership</span>
<span class='fu'><a href='https://rdrr.io/r/base/table.html'>table</a></span><span class='op'>(</span>cluster<span class='op'>=</span><span class='va'>clusters.resc</span>, treatment<span class='op'>=</span><span class='va'>rescaled</span><span class='op'>$</span><span class='va'>batch</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<pre><code>       treatment
cluster Infected Uninfected
     1        98         30
     2       942        264
     3       868       1004
     4        12        223
     5       189        450
     6        76        735
     7       687        672
     8        89        295
     9       579       1264
     10      316        338</code></pre>
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>rescaled</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scater/man/runUMAP.html'>runUMAP</a></span><span class='op'>(</span><span class='va'>rescaled</span>, dimred<span class='op'>=</span><span class='st'>"PCA"</span><span class='op'>)</span>
<span class='va'>rescaled</span><span class='op'>$</span><span class='va'>batch</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/factor.html'>factor</a></span><span class='op'>(</span><span class='va'>rescaled</span><span class='op'>$</span><span class='va'>batch</span><span class='op'>)</span>
<span class='va'>rescaled</span><span class='op'>$</span><span class='va'>cluster</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/factor.html'>factor</a></span><span class='op'>(</span><span class='va'>clusters.resc</span><span class='op'>)</span>
<span class='va'>rescaled.p1</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scater/man/plot_reddim.html'>plotUMAP</a></span><span class='op'>(</span><span class='va'>rescaled</span>, colour_by <span class='op'>=</span> <span class='st'>"batch"</span>, point_size <span class='op'>=</span> <span class='fl'>0.5</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>scale_colour_manual</span><span class='op'>(</span>values <span class='op'>=</span> <span class='va'>treatment_colours</span>, name <span class='op'>=</span> <span class='st'>"Treatment"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>ggtitle</span><span class='op'>(</span><span class='st'>"Rescaled"</span><span class='op'>)</span>
<span class='va'>rescaled.p2</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scater/man/plot_reddim.html'>plotUMAP</a></span><span class='op'>(</span><span class='va'>rescaled</span>, colour_by <span class='op'>=</span> <span class='st'>"cluster"</span>, point_size <span class='op'>=</span> <span class='fl'>0.5</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>ggtitle</span><span class='op'>(</span><span class='st'>"Rescaled"</span><span class='op'>)</span>
<span class='va'>rescaled.p1</span> <span class='op'>+</span> <span class='va'>rescaled.p2</span>
</code></pre>
</div>
</details>
<img src="annotation_DE_DA_files/figure-html5/unnamed-chunk-1-3.png" width="624" />
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://wilkelab.org/cowplot/reference/plot_grid.html'>plot_grid</a></span><span class='op'>(</span>
  <span class='fu'>ggplot</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/as.data.frame.html'>as.data.frame</a></span><span class='op'>(</span>
    <span class='fu'><a href='https://rdrr.io/r/base/cbind.html'>cbind</a></span><span class='op'>(</span>
      <span class='fu'>colData</span><span class='op'>(</span><span class='va'>sce</span><span class='op'>)</span><span class='op'>[</span>, <span class='st'>"Sample"</span>, drop <span class='op'>=</span> <span class='cn'>FALSE</span><span class='op'>]</span>,
      <span class='fu'>colData</span><span class='op'>(</span><span class='va'>rescaled</span><span class='op'>)</span><span class='op'>[</span>, <span class='st'>"cluster"</span>, drop <span class='op'>=</span> <span class='cn'>FALSE</span><span class='op'>]</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>geom_bar</span><span class='op'>(</span>
      <span class='fu'>aes</span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>cluster</span>, fill <span class='op'>=</span> <span class='va'>Sample</span><span class='op'>)</span>,
      position <span class='op'>=</span> <span class='fu'>position_fill</span><span class='op'>(</span>reverse <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>coord_flip</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>ylab</span><span class='op'>(</span><span class='st'>"Frequency"</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>scale_fill_manual</span><span class='op'>(</span>values <span class='op'>=</span> <span class='va'>sample_colours</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'><a href='https://wilkelab.org/cowplot/reference/theme_cowplot.html'>theme_cowplot</a></span><span class='op'>(</span>font_size <span class='op'>=</span> <span class='fl'>8</span><span class='op'>)</span>,
  <span class='fu'>ggplot</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/as.data.frame.html'>as.data.frame</a></span><span class='op'>(</span>
    <span class='fu'><a href='https://rdrr.io/r/base/cbind.html'>cbind</a></span><span class='op'>(</span>
      <span class='fu'>colData</span><span class='op'>(</span><span class='va'>sce</span><span class='op'>)</span><span class='op'>[</span>, <span class='st'>"Treatment"</span>, drop <span class='op'>=</span> <span class='cn'>FALSE</span><span class='op'>]</span>,
      <span class='fu'>colData</span><span class='op'>(</span><span class='va'>rescaled</span><span class='op'>)</span><span class='op'>[</span>, <span class='st'>"cluster"</span>, drop <span class='op'>=</span> <span class='cn'>FALSE</span><span class='op'>]</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>geom_bar</span><span class='op'>(</span>
      <span class='fu'>aes</span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>cluster</span>, fill <span class='op'>=</span> <span class='va'>Treatment</span><span class='op'>)</span>,
      position <span class='op'>=</span> <span class='fu'>position_fill</span><span class='op'>(</span>reverse <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>coord_flip</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>ylab</span><span class='op'>(</span><span class='st'>"Frequency"</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>scale_fill_manual</span><span class='op'>(</span>values <span class='op'>=</span> <span class='va'>treatment_colours</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'><a href='https://wilkelab.org/cowplot/reference/theme_cowplot.html'>theme_cowplot</a></span><span class='op'>(</span>font_size <span class='op'>=</span> <span class='fl'>8</span><span class='op'>)</span>,
  <span class='fu'>ggplot</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/as.data.frame.html'>as.data.frame</a></span><span class='op'>(</span><span class='fu'>colData</span><span class='op'>(</span><span class='va'>rescaled</span><span class='op'>)</span><span class='op'>[</span>, <span class='st'>"cluster"</span>, drop <span class='op'>=</span> <span class='cn'>FALSE</span><span class='op'>]</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>geom_bar</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>cluster</span>, fill <span class='op'>=</span> <span class='va'>cluster</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>coord_flip</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>ylab</span><span class='op'>(</span><span class='st'>"Number of droplets"</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'><a href='https://wilkelab.org/cowplot/reference/theme_cowplot.html'>theme_cowplot</a></span><span class='op'>(</span>font_size <span class='op'>=</span> <span class='fl'>8</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>guides</span><span class='op'>(</span>fill <span class='op'>=</span> <span class='cn'>FALSE</span><span class='op'>)</span>,
  align <span class='op'>=</span> <span class='st'>"h"</span>,
  ncol <span class='op'>=</span> <span class='fl'>3</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<img src="annotation_DE_DA_files/figure-html5/unnamed-chunk-1-4.png" width="624" />
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># Linear regression with regressBatches() --------------------------------------</span>

<span class='fu'><a href='https://rdrr.io/r/base/Random.html'>set.seed</a></span><span class='op'>(</span><span class='fl'>10001</span><span class='op'>)</span>
<span class='va'>residuals</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/batchelor/man/regressBatches.html'>regressBatches</a></span><span class='op'>(</span><span class='va'>sce</span>, batch <span class='op'>=</span> <span class='va'>sce</span><span class='op'>$</span><span class='va'>Treatment</span>, d <span class='op'>=</span> <span class='fl'>50</span>,
                            subset.row<span class='op'>=</span><span class='va'>hvg</span>, correct.all<span class='op'>=</span><span class='cn'>TRUE</span><span class='op'>)</span>

<span class='va'>snn.gr</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scran/man/buildSNNGraph.html'>buildSNNGraph</a></span><span class='op'>(</span><span class='va'>residuals</span>, use.dimred<span class='op'>=</span><span class='st'>"corrected"</span><span class='op'>)</span>
<span class='va'>clusters.resid</span> <span class='op'>&lt;-</span> <span class='fu'>igraph</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/pkg/igraph/man/cluster_louvain.html'>cluster_louvain</a></span><span class='op'>(</span><span class='va'>snn.gr</span><span class='op'>)</span><span class='op'>$</span><span class='va'>membership</span>
<span class='fu'><a href='https://rdrr.io/r/base/table.html'>table</a></span><span class='op'>(</span>Cluster<span class='op'>=</span><span class='va'>clusters.resid</span>, treatment<span class='op'>=</span><span class='va'>residuals</span><span class='op'>$</span><span class='va'>batch</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<pre><code>       treatment
Cluster Infected Uninfected
     1       519       1168
     2        19        254
     3       191        380
     4        92        817
     5       195        814
     6       249          7
     7      1031        223
     8       740        884
     9        91         28
     10      729        700</code></pre>
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>residuals</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scater/man/runUMAP.html'>runUMAP</a></span><span class='op'>(</span><span class='va'>residuals</span>, dimred<span class='op'>=</span><span class='st'>"corrected"</span><span class='op'>)</span>
<span class='va'>residuals</span><span class='op'>$</span><span class='va'>batch</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/factor.html'>factor</a></span><span class='op'>(</span><span class='va'>residuals</span><span class='op'>$</span><span class='va'>batch</span><span class='op'>)</span>
<span class='va'>residuals</span><span class='op'>$</span><span class='va'>cluster</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/factor.html'>factor</a></span><span class='op'>(</span><span class='va'>clusters.resid</span><span class='op'>)</span>
<span class='va'>residuals.p1</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scater/man/plot_reddim.html'>plotUMAP</a></span><span class='op'>(</span><span class='va'>residuals</span>, colour_by <span class='op'>=</span> <span class='st'>"batch"</span>, point_size <span class='op'>=</span> <span class='fl'>0.5</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>scale_colour_manual</span><span class='op'>(</span>values <span class='op'>=</span> <span class='va'>treatment_colours</span>, name <span class='op'>=</span> <span class='st'>"Treatment"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>ggtitle</span><span class='op'>(</span><span class='st'>"Residuals"</span><span class='op'>)</span>
<span class='va'>residuals.p2</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scater/man/plot_reddim.html'>plotUMAP</a></span><span class='op'>(</span><span class='va'>residuals</span>, colour_by <span class='op'>=</span> <span class='st'>"cluster"</span>, point_size <span class='op'>=</span> <span class='fl'>0.5</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>ggtitle</span><span class='op'>(</span><span class='st'>"Residuals"</span><span class='op'>)</span>
<span class='va'>residuals.p1</span> <span class='op'>+</span> <span class='va'>residuals.p2</span>
</code></pre>
</div>
</details>
<img src="annotation_DE_DA_files/figure-html5/unnamed-chunk-1-5.png" width="624" />
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://wilkelab.org/cowplot/reference/plot_grid.html'>plot_grid</a></span><span class='op'>(</span>
  <span class='fu'>ggplot</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/as.data.frame.html'>as.data.frame</a></span><span class='op'>(</span>
    <span class='fu'><a href='https://rdrr.io/r/base/cbind.html'>cbind</a></span><span class='op'>(</span>
      <span class='fu'>colData</span><span class='op'>(</span><span class='va'>sce</span><span class='op'>)</span><span class='op'>[</span>, <span class='st'>"Sample"</span>, drop <span class='op'>=</span> <span class='cn'>FALSE</span><span class='op'>]</span>,
      <span class='fu'>colData</span><span class='op'>(</span><span class='va'>residuals</span><span class='op'>)</span><span class='op'>[</span>, <span class='st'>"cluster"</span>, drop <span class='op'>=</span> <span class='cn'>FALSE</span><span class='op'>]</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>geom_bar</span><span class='op'>(</span>
      <span class='fu'>aes</span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>cluster</span>, fill <span class='op'>=</span> <span class='va'>Sample</span><span class='op'>)</span>,
      position <span class='op'>=</span> <span class='fu'>position_fill</span><span class='op'>(</span>reverse <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>coord_flip</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>ylab</span><span class='op'>(</span><span class='st'>"Frequency"</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>scale_fill_manual</span><span class='op'>(</span>values <span class='op'>=</span> <span class='va'>sample_colours</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'><a href='https://wilkelab.org/cowplot/reference/theme_cowplot.html'>theme_cowplot</a></span><span class='op'>(</span>font_size <span class='op'>=</span> <span class='fl'>8</span><span class='op'>)</span>,
  <span class='fu'>ggplot</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/as.data.frame.html'>as.data.frame</a></span><span class='op'>(</span>
    <span class='fu'><a href='https://rdrr.io/r/base/cbind.html'>cbind</a></span><span class='op'>(</span>
      <span class='fu'>colData</span><span class='op'>(</span><span class='va'>sce</span><span class='op'>)</span><span class='op'>[</span>, <span class='st'>"Treatment"</span>, drop <span class='op'>=</span> <span class='cn'>FALSE</span><span class='op'>]</span>,
      <span class='fu'>colData</span><span class='op'>(</span><span class='va'>residuals</span><span class='op'>)</span><span class='op'>[</span>, <span class='st'>"cluster"</span>, drop <span class='op'>=</span> <span class='cn'>FALSE</span><span class='op'>]</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>geom_bar</span><span class='op'>(</span>
      <span class='fu'>aes</span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>cluster</span>, fill <span class='op'>=</span> <span class='va'>Treatment</span><span class='op'>)</span>,
      position <span class='op'>=</span> <span class='fu'>position_fill</span><span class='op'>(</span>reverse <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>coord_flip</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>ylab</span><span class='op'>(</span><span class='st'>"Frequency"</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>scale_fill_manual</span><span class='op'>(</span>values <span class='op'>=</span> <span class='va'>treatment_colours</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'><a href='https://wilkelab.org/cowplot/reference/theme_cowplot.html'>theme_cowplot</a></span><span class='op'>(</span>font_size <span class='op'>=</span> <span class='fl'>8</span><span class='op'>)</span>,
  <span class='fu'>ggplot</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/as.data.frame.html'>as.data.frame</a></span><span class='op'>(</span><span class='fu'>colData</span><span class='op'>(</span><span class='va'>residuals</span><span class='op'>)</span><span class='op'>[</span>, <span class='st'>"cluster"</span>, drop <span class='op'>=</span> <span class='cn'>FALSE</span><span class='op'>]</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>geom_bar</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>cluster</span>, fill <span class='op'>=</span> <span class='va'>cluster</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>coord_flip</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>ylab</span><span class='op'>(</span><span class='st'>"Number of droplets"</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'><a href='https://wilkelab.org/cowplot/reference/theme_cowplot.html'>theme_cowplot</a></span><span class='op'>(</span>font_size <span class='op'>=</span> <span class='fl'>8</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>guides</span><span class='op'>(</span>fill <span class='op'>=</span> <span class='cn'>FALSE</span><span class='op'>)</span>,
  align <span class='op'>=</span> <span class='st'>"h"</span>,
  ncol <span class='op'>=</span> <span class='fl'>3</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<img src="annotation_DE_DA_files/figure-html5/unnamed-chunk-1-6.png" width="624" />
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># MNN by treatment -------------------------------------------------------------</span>

<span class='fu'><a href='https://rdrr.io/r/base/Random.html'>set.seed</a></span><span class='op'>(</span><span class='fl'>1000101001</span><span class='op'>)</span>
<span class='va'>mnn_treatment.out</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/batchelor/man/fastMNN.html'>fastMNN</a></span><span class='op'>(</span><span class='va'>sce</span>, batch <span class='op'>=</span> <span class='va'>sce</span><span class='op'>$</span><span class='va'>Treatment</span>, d<span class='op'>=</span><span class='fl'>50</span>, k<span class='op'>=</span><span class='fl'>20</span>, subset.row<span class='op'>=</span><span class='va'>hvg</span><span class='op'>)</span>
<span class='va'>snn.gr</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scran/man/buildSNNGraph.html'>buildSNNGraph</a></span><span class='op'>(</span><span class='va'>mnn_treatment.out</span>, use.dimred<span class='op'>=</span><span class='st'>"corrected"</span><span class='op'>)</span>
<span class='va'>clusters.mnn_treatment</span> <span class='op'>&lt;-</span> <span class='fu'>igraph</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/pkg/igraph/man/cluster_louvain.html'>cluster_louvain</a></span><span class='op'>(</span><span class='va'>snn.gr</span><span class='op'>)</span><span class='op'>$</span><span class='va'>membership</span>
<span class='fu'><a href='https://rdrr.io/r/base/table.html'>table</a></span><span class='op'>(</span>Cluster<span class='op'>=</span><span class='va'>clusters.mnn_treatment</span>, treatment<span class='op'>=</span><span class='va'>mnn_treatment.out</span><span class='op'>$</span><span class='va'>batch</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<pre><code>       treatment
Cluster Infected Uninfected
     1       341       1245
     2       270        308
     3       327        802
     4       110        336
     5       239          4
     6       710        679
     7        67         28
     8       521        572
     9      1179        577
     10       92        724</code></pre>
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>mnn_treatment.out</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scater/man/runUMAP.html'>runUMAP</a></span><span class='op'>(</span><span class='va'>mnn_treatment.out</span>, dimred<span class='op'>=</span><span class='st'>"corrected"</span><span class='op'>)</span>
<span class='va'>mnn_treatment.out</span><span class='op'>$</span><span class='va'>batch</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/factor.html'>factor</a></span><span class='op'>(</span><span class='va'>mnn_treatment.out</span><span class='op'>$</span><span class='va'>batch</span><span class='op'>)</span>
<span class='va'>mnn_treatment.out</span><span class='op'>$</span><span class='va'>cluster</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/factor.html'>factor</a></span><span class='op'>(</span><span class='va'>clusters.mnn_treatment</span><span class='op'>)</span>
<span class='va'>mnn_treatment.p1</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scater/man/plot_reddim.html'>plotUMAP</a></span><span class='op'>(</span><span class='va'>mnn_treatment.out</span>, colour_by <span class='op'>=</span> <span class='st'>"batch"</span>, point_size <span class='op'>=</span> <span class='fl'>0.5</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>scale_colour_manual</span><span class='op'>(</span>values <span class='op'>=</span> <span class='va'>treatment_colours</span>, name <span class='op'>=</span> <span class='st'>"Treatment"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>ggtitle</span><span class='op'>(</span><span class='st'>"MNN (treatment)"</span><span class='op'>)</span>
<span class='va'>mnn_treatment.p2</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scater/man/plot_reddim.html'>plotUMAP</a></span><span class='op'>(</span><span class='va'>mnn_treatment.out</span>, colour_by <span class='op'>=</span> <span class='st'>"cluster"</span>, point_size <span class='op'>=</span> <span class='fl'>0.5</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>ggtitle</span><span class='op'>(</span><span class='st'>"MNN (treatment)"</span><span class='op'>)</span>
<span class='va'>mnn_treatment.p1</span> <span class='op'>+</span> <span class='va'>mnn_treatment.p2</span>
</code></pre>
</div>
</details>
<img src="annotation_DE_DA_files/figure-html5/unnamed-chunk-1-7.png" width="624" />
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'>metadata</span><span class='op'>(</span><span class='va'>mnn_treatment.out</span><span class='op'>)</span><span class='op'>$</span><span class='va'>merge.info</span><span class='op'>$</span><span class='va'>lost.var</span>
</code></pre>
</div>
</details>
<pre><code>       Infected Uninfected
[1,] 0.02292624  0.0100355</code></pre>
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://wilkelab.org/cowplot/reference/plot_grid.html'>plot_grid</a></span><span class='op'>(</span>
  <span class='fu'>ggplot</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/as.data.frame.html'>as.data.frame</a></span><span class='op'>(</span>
    <span class='fu'><a href='https://rdrr.io/r/base/cbind.html'>cbind</a></span><span class='op'>(</span>
      <span class='fu'>colData</span><span class='op'>(</span><span class='va'>sce</span><span class='op'>)</span><span class='op'>[</span>, <span class='st'>"Sample"</span>, drop <span class='op'>=</span> <span class='cn'>FALSE</span><span class='op'>]</span>,
      <span class='fu'>colData</span><span class='op'>(</span><span class='va'>mnn_treatment.out</span><span class='op'>)</span><span class='op'>[</span>, <span class='st'>"cluster"</span>, drop <span class='op'>=</span> <span class='cn'>FALSE</span><span class='op'>]</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>geom_bar</span><span class='op'>(</span>
      <span class='fu'>aes</span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>cluster</span>, fill <span class='op'>=</span> <span class='va'>Sample</span><span class='op'>)</span>,
      position <span class='op'>=</span> <span class='fu'>position_fill</span><span class='op'>(</span>reverse <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>coord_flip</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>ylab</span><span class='op'>(</span><span class='st'>"Frequency"</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>scale_fill_manual</span><span class='op'>(</span>values <span class='op'>=</span> <span class='va'>sample_colours</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'><a href='https://wilkelab.org/cowplot/reference/theme_cowplot.html'>theme_cowplot</a></span><span class='op'>(</span>font_size <span class='op'>=</span> <span class='fl'>8</span><span class='op'>)</span>,
  <span class='fu'>ggplot</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/as.data.frame.html'>as.data.frame</a></span><span class='op'>(</span>
    <span class='fu'><a href='https://rdrr.io/r/base/cbind.html'>cbind</a></span><span class='op'>(</span>
      <span class='fu'>colData</span><span class='op'>(</span><span class='va'>sce</span><span class='op'>)</span><span class='op'>[</span>, <span class='st'>"Treatment"</span>, drop <span class='op'>=</span> <span class='cn'>FALSE</span><span class='op'>]</span>,
      <span class='fu'>colData</span><span class='op'>(</span><span class='va'>mnn_treatment.out</span><span class='op'>)</span><span class='op'>[</span>, <span class='st'>"cluster"</span>, drop <span class='op'>=</span> <span class='cn'>FALSE</span><span class='op'>]</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>geom_bar</span><span class='op'>(</span>
      <span class='fu'>aes</span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>cluster</span>, fill <span class='op'>=</span> <span class='va'>Treatment</span><span class='op'>)</span>,
      position <span class='op'>=</span> <span class='fu'>position_fill</span><span class='op'>(</span>reverse <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>coord_flip</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>ylab</span><span class='op'>(</span><span class='st'>"Frequency"</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>scale_fill_manual</span><span class='op'>(</span>values <span class='op'>=</span> <span class='va'>treatment_colours</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'><a href='https://wilkelab.org/cowplot/reference/theme_cowplot.html'>theme_cowplot</a></span><span class='op'>(</span>font_size <span class='op'>=</span> <span class='fl'>8</span><span class='op'>)</span>,
  <span class='fu'>ggplot</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/as.data.frame.html'>as.data.frame</a></span><span class='op'>(</span><span class='fu'>colData</span><span class='op'>(</span><span class='va'>mnn_treatment.out</span><span class='op'>)</span><span class='op'>[</span>, <span class='st'>"cluster"</span>, drop <span class='op'>=</span> <span class='cn'>FALSE</span><span class='op'>]</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>geom_bar</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>cluster</span>, fill <span class='op'>=</span> <span class='va'>cluster</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>coord_flip</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>ylab</span><span class='op'>(</span><span class='st'>"Number of droplets"</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'><a href='https://wilkelab.org/cowplot/reference/theme_cowplot.html'>theme_cowplot</a></span><span class='op'>(</span>font_size <span class='op'>=</span> <span class='fl'>8</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>guides</span><span class='op'>(</span>fill <span class='op'>=</span> <span class='cn'>FALSE</span><span class='op'>)</span>,
  align <span class='op'>=</span> <span class='st'>"h"</span>,
  ncol <span class='op'>=</span> <span class='fl'>3</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<img src="annotation_DE_DA_files/figure-html5/unnamed-chunk-1-8.png" width="624" />
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># MNN by sample -----------------------------------------------------------------</span>

<span class='fu'><a href='https://rdrr.io/r/base/Random.html'>set.seed</a></span><span class='op'>(</span><span class='fl'>1000101001</span><span class='op'>)</span>
<span class='va'>mnn_sample.out</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/batchelor/man/fastMNN.html'>fastMNN</a></span><span class='op'>(</span><span class='va'>sce</span>, batch <span class='op'>=</span> <span class='va'>sce</span><span class='op'>$</span><span class='va'>Sample</span>, d<span class='op'>=</span><span class='fl'>50</span>, k<span class='op'>=</span><span class='fl'>20</span>, subset.row<span class='op'>=</span><span class='va'>hvg.sample</span><span class='op'>)</span>
<span class='va'>snn.gr</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scran/man/buildSNNGraph.html'>buildSNNGraph</a></span><span class='op'>(</span><span class='va'>mnn_sample.out</span>, use.dimred<span class='op'>=</span><span class='st'>"corrected"</span><span class='op'>)</span>
<span class='va'>clusters.mnn_sample</span> <span class='op'>&lt;-</span> <span class='fu'>igraph</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/pkg/igraph/man/cluster_louvain.html'>cluster_louvain</a></span><span class='op'>(</span><span class='va'>snn.gr</span><span class='op'>)</span><span class='op'>$</span><span class='va'>membership</span>
<span class='fu'><a href='https://rdrr.io/r/base/table.html'>table</a></span><span class='op'>(</span>Cluster<span class='op'>=</span><span class='va'>clusters.mnn_sample</span>, treatment<span class='op'>=</span><span class='va'>mnn_sample.out</span><span class='op'>$</span><span class='va'>batch</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<pre><code>       treatment
Cluster infected_1 infected_2 infected_3 uninfected_1 uninfected_2
      1        205        366        383          202          254
      2        281        260        182          378          406
      3        208        164        327          181          348
      4         60         16          9          280          226
      5        193        166        207          116          299
      6        169        132        171          242          132
      7        231         71         55          390          387
       treatment
Cluster uninfected_3
      1           98
      2          359
      3          140
      4          196
      5           93
      6          132
      7          416</code></pre>
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>mnn_sample.out</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scater/man/runUMAP.html'>runUMAP</a></span><span class='op'>(</span><span class='va'>mnn_sample.out</span>, dimred<span class='op'>=</span><span class='st'>"corrected"</span><span class='op'>)</span>
<span class='va'>mnn_sample.out</span><span class='op'>$</span><span class='va'>batch</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/factor.html'>factor</a></span><span class='op'>(</span><span class='va'>mnn_sample.out</span><span class='op'>$</span><span class='va'>batch</span><span class='op'>)</span>
<span class='va'>mnn_sample.out</span><span class='op'>$</span><span class='va'>cluster</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/factor.html'>factor</a></span><span class='op'>(</span><span class='va'>clusters.mnn_sample</span><span class='op'>)</span>
<span class='va'>mnn_sample.p1</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scater/man/plot_reddim.html'>plotUMAP</a></span><span class='op'>(</span><span class='va'>mnn_sample.out</span>, colour_by <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/AsIs.html'>I</a></span><span class='op'>(</span><span class='va'>sce</span><span class='op'>$</span><span class='va'>Treatment</span><span class='op'>)</span>, point_size <span class='op'>=</span> <span class='fl'>0.5</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>scale_colour_manual</span><span class='op'>(</span>values <span class='op'>=</span> <span class='va'>treatment_colours</span>, name <span class='op'>=</span> <span class='st'>"Treatment"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>ggtitle</span><span class='op'>(</span><span class='st'>"MNN (sample)"</span><span class='op'>)</span>
<span class='va'>mnn_sample.p2</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scater/man/plot_reddim.html'>plotUMAP</a></span><span class='op'>(</span><span class='va'>mnn_sample.out</span>, colour_by <span class='op'>=</span> <span class='st'>"cluster"</span>, point_size <span class='op'>=</span> <span class='fl'>0.5</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>ggtitle</span><span class='op'>(</span><span class='st'>"MNN (sample)"</span><span class='op'>)</span>
<span class='va'>mnn_sample.p3</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scater/man/plot_reddim.html'>plotUMAP</a></span><span class='op'>(</span><span class='va'>mnn_sample.out</span>, colour_by <span class='op'>=</span> <span class='st'>"batch"</span>, point_size <span class='op'>=</span> <span class='fl'>0.5</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>scale_colour_manual</span><span class='op'>(</span>values <span class='op'>=</span> <span class='va'>sample_colours</span>, name <span class='op'>=</span> <span class='st'>"sample"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>ggtitle</span><span class='op'>(</span><span class='st'>"MNN (sample)"</span><span class='op'>)</span>
<span class='va'>mnn_sample.p1</span> <span class='op'>+</span> <span class='va'>mnn_sample.p2</span> <span class='op'>+</span> <span class='va'>mnn_sample.p3</span> <span class='op'>+</span> <span class='fu'><a href='https://patchwork.data-imaginist.com/reference/plot_layout.html'>plot_layout</a></span><span class='op'>(</span>ncol <span class='op'>=</span> <span class='fl'>2</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<img src="annotation_DE_DA_files/figure-html5/unnamed-chunk-1-9.png" width="624" />
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'>metadata</span><span class='op'>(</span><span class='va'>mnn_sample.out</span><span class='op'>)</span><span class='op'>$</span><span class='va'>merge.info</span><span class='op'>$</span><span class='va'>lost.var</span>
</code></pre>
</div>
</details>
<pre><code>      infected_1  infected_2  infected_3 uninfected_1 uninfected_2
[1,] 0.020956717 0.033500234 0.000000000  0.000000000  0.000000000
[2,] 0.002891713 0.003293084 0.032371402  0.000000000  0.000000000
[3,] 0.016385869 0.012359206 0.009731893  0.029496458  0.000000000
[4,] 0.002337161 0.002204300 0.002114354  0.003197765  0.037530298
[5,] 0.002273115 0.001716986 0.001771384  0.002828429  0.002689654
     uninfected_3
[1,]   0.00000000
[2,]   0.00000000
[3,]   0.00000000
[4,]   0.00000000
[5,]   0.04373178</code></pre>
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://wilkelab.org/cowplot/reference/plot_grid.html'>plot_grid</a></span><span class='op'>(</span>
  <span class='fu'>ggplot</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/as.data.frame.html'>as.data.frame</a></span><span class='op'>(</span>
    <span class='fu'><a href='https://rdrr.io/r/base/cbind.html'>cbind</a></span><span class='op'>(</span>
      <span class='fu'>colData</span><span class='op'>(</span><span class='va'>sce</span><span class='op'>)</span><span class='op'>[</span>, <span class='st'>"Sample"</span>, drop <span class='op'>=</span> <span class='cn'>FALSE</span><span class='op'>]</span>,
      <span class='fu'>colData</span><span class='op'>(</span><span class='va'>mnn_sample.out</span><span class='op'>)</span><span class='op'>[</span>, <span class='st'>"cluster"</span>, drop <span class='op'>=</span> <span class='cn'>FALSE</span><span class='op'>]</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>geom_bar</span><span class='op'>(</span>
      <span class='fu'>aes</span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>cluster</span>, fill <span class='op'>=</span> <span class='va'>Sample</span><span class='op'>)</span>,
      position <span class='op'>=</span> <span class='fu'>position_fill</span><span class='op'>(</span>reverse <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>coord_flip</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>ylab</span><span class='op'>(</span><span class='st'>"Frequency"</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>scale_fill_manual</span><span class='op'>(</span>values <span class='op'>=</span> <span class='va'>sample_colours</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'><a href='https://wilkelab.org/cowplot/reference/theme_cowplot.html'>theme_cowplot</a></span><span class='op'>(</span>font_size <span class='op'>=</span> <span class='fl'>8</span><span class='op'>)</span>,
  <span class='fu'>ggplot</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/as.data.frame.html'>as.data.frame</a></span><span class='op'>(</span>
    <span class='fu'><a href='https://rdrr.io/r/base/cbind.html'>cbind</a></span><span class='op'>(</span>
      <span class='fu'>colData</span><span class='op'>(</span><span class='va'>sce</span><span class='op'>)</span><span class='op'>[</span>, <span class='st'>"Treatment"</span>, drop <span class='op'>=</span> <span class='cn'>FALSE</span><span class='op'>]</span>,
      <span class='fu'>colData</span><span class='op'>(</span><span class='va'>mnn_sample.out</span><span class='op'>)</span><span class='op'>[</span>, <span class='st'>"cluster"</span>, drop <span class='op'>=</span> <span class='cn'>FALSE</span><span class='op'>]</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>geom_bar</span><span class='op'>(</span>
      <span class='fu'>aes</span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>cluster</span>, fill <span class='op'>=</span> <span class='va'>Treatment</span><span class='op'>)</span>,
      position <span class='op'>=</span> <span class='fu'>position_fill</span><span class='op'>(</span>reverse <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>coord_flip</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>ylab</span><span class='op'>(</span><span class='st'>"Frequency"</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>scale_fill_manual</span><span class='op'>(</span>values <span class='op'>=</span> <span class='va'>treatment_colours</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'><a href='https://wilkelab.org/cowplot/reference/theme_cowplot.html'>theme_cowplot</a></span><span class='op'>(</span>font_size <span class='op'>=</span> <span class='fl'>8</span><span class='op'>)</span>,
  <span class='fu'>ggplot</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/as.data.frame.html'>as.data.frame</a></span><span class='op'>(</span><span class='fu'>colData</span><span class='op'>(</span><span class='va'>mnn_sample.out</span><span class='op'>)</span><span class='op'>[</span>, <span class='st'>"cluster"</span>, drop <span class='op'>=</span> <span class='cn'>FALSE</span><span class='op'>]</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>geom_bar</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>cluster</span>, fill <span class='op'>=</span> <span class='va'>cluster</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>coord_flip</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>ylab</span><span class='op'>(</span><span class='st'>"Number of droplets"</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'><a href='https://wilkelab.org/cowplot/reference/theme_cowplot.html'>theme_cowplot</a></span><span class='op'>(</span>font_size <span class='op'>=</span> <span class='fl'>8</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>guides</span><span class='op'>(</span>fill <span class='op'>=</span> <span class='cn'>FALSE</span><span class='op'>)</span>,
  align <span class='op'>=</span> <span class='st'>"h"</span>,
  ncol <span class='op'>=</span> <span class='fl'>3</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<img src="annotation_DE_DA_files/figure-html5/unnamed-chunk-1-10.png" width="624" />
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># Summary of data integration results ------------------------------------------</span>

<span class='va'>uncorrected.p1</span> <span class='op'>+</span> <span class='va'>rescaled.p1</span> <span class='op'>+</span> <span class='va'>residuals.p1</span> <span class='op'>+</span> <span class='va'>mnn_treatment.p1</span> <span class='op'>+</span>
  <span class='va'>mnn_sample.p1</span> <span class='op'>+</span> <span class='fu'><a href='https://patchwork.data-imaginist.com/reference/plot_layout.html'>plot_layout</a></span><span class='op'>(</span>guides <span class='op'>=</span> <span class='st'>"collect"</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<img src="annotation_DE_DA_files/figure-html5/unnamed-chunk-1-11.png" width="624" />
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>uncorrected.p2</span> <span class='op'>+</span> <span class='va'>rescaled.p2</span> <span class='op'>+</span> <span class='va'>residuals.p2</span> <span class='op'>+</span> <span class='va'>mnn_treatment.p2</span> <span class='op'>+</span>
  <span class='va'>mnn_sample.p2</span>
</code></pre>
</div>
</details>
<img src="annotation_DE_DA_files/figure-html5/unnamed-chunk-1-12.png" width="624" />
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># NOTE: Uncorrected data has strong treatment-specific differences (and</span>
<span class='co'>#       presumably donor-specific differences).</span>
<span class='co'>#       Correcting for treatment using any of the 4 approaches removes/dampens</span>
<span class='co'>#       those treatment-specific differences.</span>
<span class='co'>#       However, it's a little hard to interpret if this is a good or bad thing.</span>
<span class='co'>#       Therefore, will just use uncorrected data in what follows while</span>
<span class='co'>#       remembering that this means there will be very treatment-specific</span>
<span class='co'>#       (and perhaps donor-specific) clusters.</span>

<span class='co'># Clustering at different resolutions ------------------------------------------</span>

<span class='fu'><a href='https://rdrr.io/r/base/Random.html'>set.seed</a></span><span class='op'>(</span><span class='fl'>126</span><span class='op'>)</span>
<span class='va'>snn_gr</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scran/man/buildSNNGraph.html'>buildSNNGraph</a></span><span class='op'>(</span><span class='va'>sce</span>, use.dimred <span class='op'>=</span> <span class='st'>"PCA"</span>, k <span class='op'>=</span> <span class='fl'>20</span><span class='op'>)</span>
<span class='va'>clusters</span> <span class='op'>&lt;-</span> <span class='fu'>igraph</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/pkg/igraph/man/cluster_louvain.html'>cluster_louvain</a></span><span class='op'>(</span><span class='va'>snn_gr</span><span class='op'>)</span>
<span class='va'>sce</span><span class='op'>$</span><span class='va'>cluster_k20</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/factor.html'>factor</a></span><span class='op'>(</span><span class='va'>clusters</span><span class='op'>$</span><span class='va'>membership</span><span class='op'>)</span>
<span class='va'>snn_gr</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scran/man/buildSNNGraph.html'>buildSNNGraph</a></span><span class='op'>(</span><span class='va'>sce</span>, use.dimred <span class='op'>=</span> <span class='st'>"PCA"</span>, k <span class='op'>=</span> <span class='fl'>50</span><span class='op'>)</span>
<span class='va'>clusters</span> <span class='op'>&lt;-</span> <span class='fu'>igraph</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/pkg/igraph/man/cluster_louvain.html'>cluster_louvain</a></span><span class='op'>(</span><span class='va'>snn_gr</span><span class='op'>)</span>
<span class='va'>sce</span><span class='op'>$</span><span class='va'>cluster_k50</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/factor.html'>factor</a></span><span class='op'>(</span><span class='va'>clusters</span><span class='op'>$</span><span class='va'>membership</span><span class='op'>)</span>
<span class='va'>snn_gr</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scran/man/buildSNNGraph.html'>buildSNNGraph</a></span><span class='op'>(</span><span class='va'>sce</span>, use.dimred <span class='op'>=</span> <span class='st'>"PCA"</span>, k <span class='op'>=</span> <span class='fl'>100</span><span class='op'>)</span>
<span class='va'>clusters</span> <span class='op'>&lt;-</span> <span class='fu'>igraph</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/pkg/igraph/man/cluster_louvain.html'>cluster_louvain</a></span><span class='op'>(</span><span class='va'>snn_gr</span><span class='op'>)</span>
<span class='va'>sce</span><span class='op'>$</span><span class='va'>cluster_k100</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/factor.html'>factor</a></span><span class='op'>(</span><span class='va'>clusters</span><span class='op'>$</span><span class='va'>membership</span><span class='op'>)</span>

<span class='va'>p1</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scater/man/plot_reddim.html'>plotUMAP</a></span><span class='op'>(</span><span class='va'>sce</span>, colour_by <span class='op'>=</span> <span class='st'>"cluster"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>scale_colour_manual</span><span class='op'>(</span>values <span class='op'>=</span> <span class='va'>cluster_colours</span>, name <span class='op'>=</span> <span class='st'>"cluster"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>ggtitle</span><span class='op'>(</span><span class='st'>"Uncorrected: k = 10"</span><span class='op'>)</span>
<span class='va'>p2</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scater/man/plot_reddim.html'>plotUMAP</a></span><span class='op'>(</span><span class='va'>sce</span>, colour_by <span class='op'>=</span> <span class='st'>"cluster_k20"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>ggtitle</span><span class='op'>(</span><span class='st'>"Uncorrected: k = 20"</span><span class='op'>)</span>
<span class='va'>p3</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scater/man/plot_reddim.html'>plotUMAP</a></span><span class='op'>(</span><span class='va'>sce</span>, colour_by <span class='op'>=</span> <span class='st'>"cluster_k50"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>ggtitle</span><span class='op'>(</span><span class='st'>"Uncorrected: k = 50"</span><span class='op'>)</span>
<span class='va'>p4</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scater/man/plot_reddim.html'>plotUMAP</a></span><span class='op'>(</span><span class='va'>sce</span>, colour_by <span class='op'>=</span> <span class='st'>"cluster_k100"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>ggtitle</span><span class='op'>(</span><span class='st'>"Uncorrected: k = 100"</span><span class='op'>)</span>
<span class='va'>p1</span> <span class='op'>+</span> <span class='va'>p2</span> <span class='op'>+</span> <span class='va'>p3</span> <span class='op'>+</span> <span class='va'>p4</span> <span class='op'>+</span> <span class='fu'><a href='https://patchwork.data-imaginist.com/reference/plot_layout.html'>plot_layout</a></span><span class='op'>(</span>ncol <span class='op'>=</span> <span class='fl'>2</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<img src="annotation_DE_DA_files/figure-html5/unnamed-chunk-1-13.png" width="624" />
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># NOTE: In all clusterings we observe an 'out group' on the right hand side.</span>

<span class='co'># Look at cycling cluster(s) ---------------------------------------------------</span>

<span class='co'># NOTE: Cell cycle could really be proliferation of T-cells upon activation</span>

<span class='co'># Appears to be a cycling and non-cycling clustering driving the results.</span>
<span class='co'># Cycling cluster(s) typified by upregulation of a large number of genes, larger</span>
<span class='co'># library sizes, and cyclin expression.</span>
<span class='co'># Non-cycling clusters typified by opposite and no upregulation of specific</span>
<span class='co'># markers.</span>

<span class='va'>cycling_cluster</span> <span class='op'>&lt;-</span> <span class='st'>"8"</span>
<span class='va'>sce</span><span class='op'>$</span><span class='va'>cycling_cluster</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/ifelse.html'>ifelse</a></span><span class='op'>(</span>
  <span class='va'>sce</span><span class='op'>$</span><span class='va'>cluster</span> <span class='op'>%in%</span> <span class='va'>cycling_cluster</span>,
  <span class='st'>"Cycling"</span>,
  <span class='st'>"Not cycling"</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/pkg/scater/man/plot_reddim.html'>plotUMAP</a></span><span class='op'>(</span><span class='va'>sce</span>, colour_by <span class='op'>=</span> <span class='st'>"cycling_cluster"</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<img src="annotation_DE_DA_files/figure-html5/unnamed-chunk-1-14.png" width="624" />
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>z</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scran/man/findMarkers.html'>findMarkers</a></span><span class='op'>(</span><span class='va'>sce</span>, <span class='va'>sce</span><span class='op'>$</span><span class='va'>cycling_cluster</span>, direction <span class='op'>=</span> <span class='st'>"up"</span><span class='op'>)</span>

<span class='va'>cyclin_genes</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/grep.html'>grep</a></span><span class='op'>(</span><span class='st'>"^CCN[ABDE][0-9]$"</span>, <span class='fu'>rowData</span><span class='op'>(</span><span class='va'>sce</span><span class='op'>)</span><span class='op'>$</span><span class='va'>Symbol</span><span class='op'>)</span>
<span class='va'>cyclin_genes</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/sort.html'>sort</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/colnames.html'>rownames</a></span><span class='op'>(</span><span class='va'>sce</span><span class='op'>)</span><span class='op'>[</span><span class='va'>cyclin_genes</span><span class='op'>]</span><span class='op'>)</span>
<span class='va'>cyclin_genes</span>
</code></pre>
</div>
</details>
<pre><code> [1] &quot;CCNA1&quot; &quot;CCNA2&quot; &quot;CCNB1&quot; &quot;CCNB2&quot; &quot;CCNB3&quot; &quot;CCND1&quot; &quot;CCND2&quot; &quot;CCND3&quot;
 [9] &quot;CCNE1&quot; &quot;CCNE2&quot;</code></pre>
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>sce</span><span class='op'>$</span><span class='va'>ls</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/Log.html'>log10</a></span><span class='op'>(</span><span class='va'>sce</span><span class='op'>$</span><span class='va'>sum</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/pkg/scater/man/plotHeatmap.html'>plotHeatmap</a></span><span class='op'>(</span>
  <span class='va'>sce</span>,
  <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span>
    <span class='fu'><a href='https://rdrr.io/r/utils/head.html'>head</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/colnames.html'>rownames</a></span><span class='op'>(</span><span class='va'>z</span><span class='op'>[[</span><span class='st'>"Not cycling"</span><span class='op'>]</span><span class='op'>]</span><span class='op'>)</span>, <span class='fl'>25</span><span class='op'>)</span>,
    <span class='fu'><a href='https://rdrr.io/r/utils/head.html'>head</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/colnames.html'>rownames</a></span><span class='op'>(</span><span class='va'>z</span><span class='op'>[[</span><span class='st'>"Cycling"</span><span class='op'>]</span><span class='op'>]</span><span class='op'>)</span>, <span class='fl'>25</span><span class='op'>)</span>,
    <span class='va'>cyclin_genes</span><span class='op'>)</span>,
  order_columns_by <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"cycling_cluster"</span>, <span class='st'>"cluster"</span><span class='op'>)</span>,
  cluster_rows <span class='op'>=</span> <span class='cn'>FALSE</span>,
  color <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/grDevices/palettes.html'>hcl.colors</a></span><span class='op'>(</span><span class='fl'>101</span>, <span class='st'>"Blue-Red 3"</span><span class='op'>)</span>,
  center <span class='op'>=</span> <span class='cn'>TRUE</span>,
  zlim <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='op'>-</span><span class='fl'>3</span>, <span class='fl'>3</span><span class='op'>)</span>,
  colour_columns_by <span class='op'>=</span> <span class='st'>"ls"</span>,
  colour_annotation_colours <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span>
    cluster <span class='op'>=</span> <span class='va'>cluster_colours</span><span class='op'>)</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<img src="annotation_DE_DA_files/figure-html5/unnamed-chunk-1-15.png" width="624" />
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://wilkelab.org/cowplot/reference/plot_grid.html'>plot_grid</a></span><span class='op'>(</span>
  <span class='fu'>ggplot</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/as.data.frame.html'>as.data.frame</a></span><span class='op'>(</span><span class='fu'>colData</span><span class='op'>(</span><span class='va'>sce</span><span class='op'>)</span><span class='op'>[</span>, <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"cycling_cluster"</span>, <span class='st'>"Sample"</span><span class='op'>)</span><span class='op'>]</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>geom_bar</span><span class='op'>(</span>
      <span class='fu'>aes</span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>cycling_cluster</span>, fill <span class='op'>=</span> <span class='va'>Sample</span><span class='op'>)</span>,
      position <span class='op'>=</span> <span class='fu'>position_fill</span><span class='op'>(</span>reverse <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>coord_flip</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>ylab</span><span class='op'>(</span><span class='st'>"Frequency"</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>scale_fill_manual</span><span class='op'>(</span>values <span class='op'>=</span> <span class='va'>sample_colours</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'><a href='https://wilkelab.org/cowplot/reference/theme_cowplot.html'>theme_cowplot</a></span><span class='op'>(</span>font_size <span class='op'>=</span> <span class='fl'>8</span><span class='op'>)</span>,
  <span class='fu'>ggplot</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/as.data.frame.html'>as.data.frame</a></span><span class='op'>(</span><span class='fu'>colData</span><span class='op'>(</span><span class='va'>sce</span><span class='op'>)</span><span class='op'>[</span>, <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"cycling_cluster"</span>, <span class='st'>"Treatment"</span><span class='op'>)</span><span class='op'>]</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>geom_bar</span><span class='op'>(</span>
      <span class='fu'>aes</span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>cycling_cluster</span>, fill <span class='op'>=</span> <span class='va'>Treatment</span><span class='op'>)</span>,
      position <span class='op'>=</span> <span class='fu'>position_fill</span><span class='op'>(</span>reverse <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>coord_flip</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>ylab</span><span class='op'>(</span><span class='st'>"Frequency"</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>scale_fill_manual</span><span class='op'>(</span>values <span class='op'>=</span> <span class='va'>treatment_colours</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'><a href='https://wilkelab.org/cowplot/reference/theme_cowplot.html'>theme_cowplot</a></span><span class='op'>(</span>font_size <span class='op'>=</span> <span class='fl'>8</span><span class='op'>)</span>,
  <span class='fu'>ggplot</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/as.data.frame.html'>as.data.frame</a></span><span class='op'>(</span><span class='fu'>colData</span><span class='op'>(</span><span class='va'>sce</span><span class='op'>)</span><span class='op'>[</span>, <span class='st'>"cycling_cluster"</span>, drop <span class='op'>=</span> <span class='cn'>FALSE</span><span class='op'>]</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>geom_bar</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>cycling_cluster</span>, fill <span class='op'>=</span> <span class='va'>cycling_cluster</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>coord_flip</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>ylab</span><span class='op'>(</span><span class='st'>"Number of droplets"</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'><a href='https://wilkelab.org/cowplot/reference/theme_cowplot.html'>theme_cowplot</a></span><span class='op'>(</span>font_size <span class='op'>=</span> <span class='fl'>8</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>guides</span><span class='op'>(</span>fill <span class='op'>=</span> <span class='cn'>FALSE</span><span class='op'>)</span>,
  align <span class='op'>=</span> <span class='st'>"h"</span>,
  ncol <span class='op'>=</span> <span class='fl'>3</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<img src="annotation_DE_DA_files/figure-html5/unnamed-chunk-1-16.png" width="624" />
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># Subset analysis based on cycling cluster(s) ----------------------------------</span>

<span class='fu'><a href='https://rdrr.io/r/base/Random.html'>set.seed</a></span><span class='op'>(</span><span class='fl'>9391</span><span class='op'>)</span>
<span class='va'>list_of_sce</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scran/man/quickSubCluster.html'>quickSubCluster</a></span><span class='op'>(</span>
  <span class='va'>sce</span>,
  groups <span class='op'>=</span> <span class='va'>sce</span><span class='op'>$</span><span class='va'>cycling_cluster</span>,
  prepFUN <span class='op'>=</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>x</span><span class='op'>)</span> <span class='op'>{</span>
    <span class='va'>var_fit</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scran/man/modelGeneVarByPoisson.html'>modelGeneVarByPoisson</a></span><span class='op'>(</span><span class='va'>x</span><span class='op'>)</span>
    <span class='va'>hvg</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scran/man/getTopHVGs.html'>getTopHVGs</a></span><span class='op'>(</span><span class='va'>var_fit</span>, var.threshold <span class='op'>=</span> <span class='fl'>0</span><span class='op'>)</span>
    <span class='va'>is_mito</span> <span class='op'>&lt;-</span> <span class='va'>hvg</span> <span class='op'>%in%</span> <span class='va'>mito_set</span>
    <span class='va'>is_ribo</span> <span class='op'>&lt;-</span> <span class='va'>hvg</span> <span class='op'>%in%</span> <span class='va'>ribo_set</span>
    <span class='va'>hvg</span> <span class='op'>&lt;-</span> <span class='va'>hvg</span><span class='op'>[</span><span class='op'>!</span><span class='op'>(</span><span class='va'>is_mito</span> <span class='op'>|</span> <span class='va'>is_ribo</span><span class='op'>)</span><span class='op'>]</span>
    <span class='co'># NOTE: Keep the original dimensionality reduction around for downstream</span>
    <span class='co'>#       plotting.</span>
    <span class='fu'><a href='https://rdrr.io/pkg/SingleCellExperiment/man/reducedDims.html'>reducedDimNames</a></span><span class='op'>(</span><span class='va'>x</span><span class='op'>)</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/paste.html'>paste0</a></span><span class='op'>(</span><span class='st'>"original_"</span>, <span class='fu'><a href='https://rdrr.io/pkg/SingleCellExperiment/man/reducedDims.html'>reducedDimNames</a></span><span class='op'>(</span><span class='va'>x</span><span class='op'>)</span><span class='op'>)</span>
    <span class='fu'><a href='https://rdrr.io/pkg/scran/man/denoisePCA.html'>denoisePCA</a></span><span class='op'>(</span><span class='va'>x</span>, <span class='va'>var_fit</span>, subset.row <span class='op'>=</span> <span class='va'>hvg</span><span class='op'>)</span>
  <span class='op'>}</span>,
  clusterFUN <span class='op'>=</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>x</span><span class='op'>)</span> <span class='op'>{</span>
    <span class='va'>snn_gr</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scran/man/buildSNNGraph.html'>buildSNNGraph</a></span><span class='op'>(</span><span class='va'>x</span>, use.dimred <span class='op'>=</span> <span class='st'>"PCA"</span>, k <span class='op'>=</span> <span class='fl'>50</span><span class='op'>)</span>
    <span class='fu'><a href='https://rdrr.io/r/base/factor.html'>factor</a></span><span class='op'>(</span><span class='fu'>igraph</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/pkg/igraph/man/cluster_louvain.html'>cluster_louvain</a></span><span class='op'>(</span><span class='va'>snn_gr</span><span class='op'>)</span><span class='op'>$</span><span class='va'>membership</span><span class='op'>)</span>
  <span class='op'>}</span><span class='op'>)</span>
<span class='co'># It's also useful to have per-sample UMAP representations.</span>
<span class='fu'><a href='https://rdrr.io/r/base/Random.html'>set.seed</a></span><span class='op'>(</span><span class='fl'>17127</span><span class='op'>)</span>
<span class='va'>list_of_sce</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/lapply.html'>lapply</a></span><span class='op'>(</span><span class='va'>list_of_sce</span>, <span class='va'>runUMAP</span>, dimred <span class='op'>=</span> <span class='st'>"PCA"</span><span class='op'>)</span>
<span class='co'># It's also useful to have SingleR DICE with fine labels for subclusters</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://github.com/LTLA/SingleR'>SingleR</a></span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://github.com/LTLA/celldex'>celldex</a></span><span class='op'>)</span>
<span class='va'>ref</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/SingleR/man/datasets.html'>DatabaseImmuneCellExpressionData</a></span><span class='op'>(</span><span class='op'>)</span>
<span class='va'>labels_fine</span> <span class='op'>&lt;-</span> <span class='va'>ref</span><span class='op'>$</span><span class='va'>label.fine</span>
<span class='co'># NOTE: This code doesn't necessarily generalise beyond the DICE main labels.</span>
<span class='va'>label_fine_collapsed_colours</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/setNames.html'>setNames</a></span><span class='op'>(</span>
  <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span>
    <span class='fu'>Polychrome</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/pkg/Polychrome/man/palettes.html'>glasbey.colors</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/nlevels.html'>nlevels</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/factor.html'>factor</a></span><span class='op'>(</span><span class='va'>labels_fine</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span> <span class='fl'>1</span><span class='op'>)</span><span class='op'>[</span><span class='op'>-</span><span class='fl'>1</span><span class='op'>]</span>,
    <span class='st'>"orange"</span><span class='op'>)</span>,
  <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/levels.html'>levels</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/factor.html'>factor</a></span><span class='op'>(</span><span class='va'>labels_fine</span><span class='op'>)</span><span class='op'>)</span>, <span class='st'>"other"</span><span class='op'>)</span><span class='op'>)</span>
<span class='va'>list_of_sce</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/lapply.html'>lapply</a></span><span class='op'>(</span><span class='va'>list_of_sce</span>, <span class='kw'>function</span><span class='op'>(</span><span class='va'>x</span><span class='op'>)</span> <span class='op'>{</span>
  <span class='va'>pred_subcluster_fine</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/SingleR/man/SingleR.html'>SingleR</a></span><span class='op'>(</span>
    test <span class='op'>=</span> <span class='va'>x</span>,
    ref <span class='op'>=</span> <span class='va'>ref</span>,
    labels <span class='op'>=</span> <span class='va'>labels_fine</span>,
    clusters <span class='op'>=</span> <span class='va'>x</span><span class='op'>$</span><span class='va'>subcluster</span><span class='op'>)</span>
  <span class='va'>x</span><span class='op'>$</span><span class='va'>label_subcluster_fine</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/factor.html'>factor</a></span><span class='op'>(</span>
    <span class='va'>pred_subcluster_fine</span><span class='op'>[</span><span class='va'>x</span><span class='op'>$</span><span class='va'>subcluster</span>, <span class='st'>"pruned.labels"</span><span class='op'>]</span><span class='op'>)</span>
  <span class='va'>x</span>
<span class='op'>}</span><span class='op'>)</span>

<span class='va'>list_of_sce</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/lapply.html'>lapply</a></span><span class='op'>(</span><span class='va'>list_of_sce</span>, <span class='kw'>function</span><span class='op'>(</span><span class='va'>x</span><span class='op'>)</span> <span class='op'>{</span>
  <span class='va'>pred_cell_fine</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/SingleR/man/SingleR.html'>SingleR</a></span><span class='op'>(</span>
    test <span class='op'>=</span> <span class='va'>x</span>,
    ref <span class='op'>=</span> <span class='va'>ref</span>,
    labels <span class='op'>=</span> <span class='va'>labels_fine</span><span class='op'>)</span>
  <span class='va'>x</span><span class='op'>$</span><span class='va'>label_cell_fine</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/factor.html'>factor</a></span><span class='op'>(</span><span class='va'>pred_cell_fine</span><span class='op'>$</span><span class='va'>pruned.labels</span><span class='op'>)</span>
  <span class='va'>x</span>
<span class='op'>}</span><span class='op'>)</span>

<span class='fu'><a href='https://wilkelab.org/cowplot/reference/plot_grid.html'>plot_grid</a></span><span class='op'>(</span>
  plotlist <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/lapply.html'>lapply</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/names.html'>names</a></span><span class='op'>(</span><span class='va'>list_of_sce</span><span class='op'>)</span>, <span class='kw'>function</span><span class='op'>(</span><span class='va'>n</span><span class='op'>)</span> <span class='op'>{</span>
    <span class='va'>x</span> <span class='op'>&lt;-</span> <span class='va'>list_of_sce</span><span class='op'>[[</span><span class='va'>n</span><span class='op'>]</span><span class='op'>]</span>
    <span class='fu'><a href='https://rdrr.io/pkg/scater/man/plot_reddim.html'>plotUMAP</a></span><span class='op'>(</span><span class='va'>x</span>, colour_by <span class='op'>=</span> <span class='st'>"subcluster"</span><span class='op'>)</span> <span class='op'>+</span>
      <span class='fu'>ggtitle</span><span class='op'>(</span><span class='va'>n</span><span class='op'>)</span>
  <span class='op'>}</span><span class='op'>)</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<img src="annotation_DE_DA_files/figure-html5/unnamed-chunk-1-17.png" width="624" />
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://wilkelab.org/cowplot/reference/plot_grid.html'>plot_grid</a></span><span class='op'>(</span>
  plotlist <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/lapply.html'>lapply</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/names.html'>names</a></span><span class='op'>(</span><span class='va'>list_of_sce</span><span class='op'>)</span>, <span class='kw'>function</span><span class='op'>(</span><span class='va'>n</span><span class='op'>)</span> <span class='op'>{</span>
    <span class='va'>x</span> <span class='op'>&lt;-</span> <span class='va'>list_of_sce</span><span class='op'>[[</span><span class='va'>n</span><span class='op'>]</span><span class='op'>]</span>
    <span class='fu'><a href='https://rdrr.io/pkg/scater/man/plot_reddim.html'>plotUMAP</a></span><span class='op'>(</span><span class='va'>x</span>, colour_by <span class='op'>=</span> <span class='st'>"label_subcluster_fine"</span>, text_by <span class='op'>=</span> <span class='st'>"subcluster"</span><span class='op'>)</span> <span class='op'>+</span>
      <span class='fu'>ggtitle</span><span class='op'>(</span><span class='va'>n</span><span class='op'>)</span>
  <span class='op'>}</span><span class='op'>)</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<img src="annotation_DE_DA_files/figure-html5/unnamed-chunk-1-18.png" width="624" />
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://wilkelab.org/cowplot/reference/plot_grid.html'>plot_grid</a></span><span class='op'>(</span>
  plotlist <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/lapply.html'>lapply</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/names.html'>names</a></span><span class='op'>(</span><span class='va'>list_of_sce</span><span class='op'>)</span>, <span class='kw'>function</span><span class='op'>(</span><span class='va'>n</span><span class='op'>)</span> <span class='op'>{</span>
    <span class='va'>x</span> <span class='op'>&lt;-</span> <span class='va'>list_of_sce</span><span class='op'>[[</span><span class='va'>n</span><span class='op'>]</span><span class='op'>]</span>
    <span class='fu'><a href='https://rdrr.io/pkg/scater/man/plot_reddim.html'>plotUMAP</a></span><span class='op'>(</span><span class='va'>x</span>, colour_by <span class='op'>=</span> <span class='st'>"label_cell_fine"</span>, text_by <span class='op'>=</span> <span class='st'>"subcluster"</span><span class='op'>)</span> <span class='op'>+</span>
      <span class='fu'>ggtitle</span><span class='op'>(</span><span class='va'>n</span><span class='op'>)</span>
  <span class='op'>}</span><span class='op'>)</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<img src="annotation_DE_DA_files/figure-html5/unnamed-chunk-1-19.png" width="624" />
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>x</span> <span class='op'>&lt;-</span> <span class='va'>list_of_sce</span><span class='op'>[[</span><span class='st'>"Not cycling"</span><span class='op'>]</span><span class='op'>]</span>
<span class='va'>m</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scran/man/findMarkers.html'>findMarkers</a></span><span class='op'>(</span><span class='va'>x</span>, <span class='va'>x</span><span class='op'>$</span><span class='va'>subcluster</span>, direction <span class='op'>=</span> <span class='st'>"up"</span>, pval.type <span class='op'>=</span> <span class='st'>"all"</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/base/lapply.html'>sapply</a></span><span class='op'>(</span><span class='va'>m</span>, <span class='kw'>function</span><span class='op'>(</span><span class='va'>x</span><span class='op'>)</span> <span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span><span class='va'>x</span><span class='op'>$</span><span class='va'>FDR</span> <span class='op'>&lt;</span> <span class='fl'>0.05</span><span class='op'>)</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<pre><code>Not cycling.1 Not cycling.2 Not cycling.3 Not cycling.4 Not cycling.5 
          136           424           203           277           652 </code></pre>
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>features</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/unique.html'>unique</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/unlist.html'>unlist</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/lapply.html'>lapply</a></span><span class='op'>(</span><span class='va'>m</span>, <span class='kw'>function</span><span class='op'>(</span><span class='va'>x</span><span class='op'>)</span> <span class='fu'><a href='https://rdrr.io/r/utils/head.html'>head</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/colnames.html'>rownames</a></span><span class='op'>(</span><span class='va'>x</span><span class='op'>)</span>, <span class='fl'>10</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/pkg/scater/man/plotHeatmap.html'>plotHeatmap</a></span><span class='op'>(</span>
  <span class='va'>x</span>,
  features <span class='op'>=</span> <span class='va'>features</span>,
  order_columns_by <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"subcluster"</span>, <span class='st'>"Treatment"</span>, <span class='st'>"Sample"</span><span class='op'>)</span>,
  color <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/grDevices/palettes.html'>hcl.colors</a></span><span class='op'>(</span><span class='fl'>101</span>, <span class='st'>"Blue-Red 3"</span><span class='op'>)</span>,
  center <span class='op'>=</span> <span class='cn'>TRUE</span>,
  zlim <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='op'>-</span><span class='fl'>3</span>, <span class='fl'>3</span><span class='op'>)</span>,
  column_annotation_colors <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span>
    Treatment <span class='op'>=</span> <span class='va'>treatment_colours</span>,
    Sample <span class='op'>=</span> <span class='va'>sample_colours</span><span class='op'>)</span>,
  cluster_rows <span class='op'>=</span> <span class='cn'>FALSE</span>,
  annotation_row <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/data.frame.html'>data.frame</a></span><span class='op'>(</span>
    subcluster <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/names.html'>names</a></span><span class='op'>(</span><span class='va'>m</span><span class='op'>)</span>, each <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/length.html'>length</a></span><span class='op'>(</span><span class='va'>features</span><span class='op'>)</span> <span class='op'>/</span> <span class='fu'><a href='https://rdrr.io/r/base/length.html'>length</a></span><span class='op'>(</span><span class='va'>m</span><span class='op'>)</span><span class='op'>)</span>,
    row.names <span class='op'>=</span> <span class='va'>features</span><span class='op'>)</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<img src="annotation_DE_DA_files/figure-html5/unnamed-chunk-1-20.png" width="624" />
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>x</span> <span class='op'>&lt;-</span> <span class='va'>list_of_sce</span><span class='op'>[[</span><span class='st'>"Cycling"</span><span class='op'>]</span><span class='op'>]</span>
<span class='va'>m</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scran/man/findMarkers.html'>findMarkers</a></span><span class='op'>(</span><span class='va'>x</span>, <span class='va'>x</span><span class='op'>$</span><span class='va'>subcluster</span>, direction <span class='op'>=</span> <span class='st'>"up"</span>, pval.type <span class='op'>=</span> <span class='st'>"all"</span><span class='op'>)</span>
<span class='va'>features</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/unique.html'>unique</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/unlist.html'>unlist</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/lapply.html'>lapply</a></span><span class='op'>(</span><span class='va'>m</span>, <span class='kw'>function</span><span class='op'>(</span><span class='va'>x</span><span class='op'>)</span> <span class='fu'><a href='https://rdrr.io/r/utils/head.html'>head</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/colnames.html'>rownames</a></span><span class='op'>(</span><span class='va'>x</span><span class='op'>)</span>, <span class='fl'>10</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/pkg/scater/man/plotHeatmap.html'>plotHeatmap</a></span><span class='op'>(</span>
  <span class='va'>x</span>,
  features <span class='op'>=</span> <span class='va'>features</span>,
  order_columns_by <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"subcluster"</span>, <span class='st'>"Treatment"</span>, <span class='st'>"Sample"</span><span class='op'>)</span>,
  color <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/grDevices/palettes.html'>hcl.colors</a></span><span class='op'>(</span><span class='fl'>101</span>, <span class='st'>"Blue-Red 3"</span><span class='op'>)</span>,
  center <span class='op'>=</span> <span class='cn'>TRUE</span>,
  zlim <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='op'>-</span><span class='fl'>3</span>, <span class='fl'>3</span><span class='op'>)</span>,
  column_annotation_colors <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span>
    Treatment <span class='op'>=</span> <span class='va'>treatment_colours</span>,
    Sample <span class='op'>=</span> <span class='va'>sample_colours</span><span class='op'>)</span>,
  cluster_rows <span class='op'>=</span> <span class='cn'>FALSE</span>,
  annotation_row <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/data.frame.html'>data.frame</a></span><span class='op'>(</span>
    subcluster <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/names.html'>names</a></span><span class='op'>(</span><span class='va'>m</span><span class='op'>)</span>, each <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/length.html'>length</a></span><span class='op'>(</span><span class='va'>features</span><span class='op'>)</span> <span class='op'>/</span> <span class='fu'><a href='https://rdrr.io/r/base/length.html'>length</a></span><span class='op'>(</span><span class='va'>m</span><span class='op'>)</span><span class='op'>)</span>,
    row.names <span class='op'>=</span> <span class='va'>features</span><span class='op'>)</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<img src="annotation_DE_DA_files/figure-html5/unnamed-chunk-1-21.png" width="624" />
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># Using the cyclins ------------------------------------------------------------</span>

<span class='co'># - Cyclin A is expressed across S and G2</span>
<span class='co'># - Cyclin B is expressed highest in late G2 and mitosis (Morgan 2007).</span>
<span class='co'># - Cyclin D is expressed throughout but peaks at G1</span>
<span class='co'># - Cyclin E is expressed highest in the G1/S transition</span>

<span class='fu'><a href='https://rdrr.io/pkg/scater/man/plotHeatmap.html'>plotHeatmap</a></span><span class='op'>(</span>
  <span class='va'>sce</span>,
  order_columns_by <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"cycling_cluster"</span>, <span class='st'>"cluster"</span><span class='op'>)</span>,
  cluster_rows <span class='op'>=</span> <span class='cn'>FALSE</span>,
  features <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/sort.html'>sort</a></span><span class='op'>(</span><span class='va'>cyclin_genes</span><span class='op'>)</span>,
  color <span class='op'>=</span> <span class='fu'>viridisLite</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/pkg/viridisLite/man/viridis.html'>magma</a></span><span class='op'>(</span><span class='fl'>101</span><span class='op'>)</span>,
  column_annotation_colors <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span>cluster <span class='op'>=</span> <span class='va'>cluster_colours</span><span class='op'>)</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<img src="annotation_DE_DA_files/figure-html5/unnamed-chunk-1-22.png" width="624" />
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>markers</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scran/man/findMarkers.html'>findMarkers</a></span><span class='op'>(</span>
  <span class='va'>sce</span>,
  <span class='va'>sce</span><span class='op'>$</span><span class='va'>cluster</span>,
  subset.row <span class='op'>=</span> <span class='va'>cyclin_genes</span>,
  test.type <span class='op'>=</span> <span class='st'>"wilcox"</span>,
  direction <span class='op'>=</span> <span class='st'>"up"</span><span class='op'>)</span>
<span class='va'>markers</span><span class='op'>[[</span><span class='va'>cycling_cluster</span><span class='op'>]</span><span class='op'>]</span>
</code></pre>
</div>
</details>
<pre><code>DataFrame with 10 rows and 13 columns
            Top      p.value          FDR summary.AUC     AUC.1
      &lt;integer&gt;    &lt;numeric&gt;    &lt;numeric&gt;   &lt;numeric&gt; &lt;numeric&gt;
CCNA2         1 3.16825e-222 3.16825e-221    0.843281  0.844552
CCNB2         2 4.08240e-210 2.04120e-209    0.833734  0.835996
CCNB1         3 1.89056e-150 6.30187e-150    0.782023  0.782010
CCND3         3 1.10068e-100 2.75170e-100    0.809909  0.630868
CCNE2         4  1.85899e-39  3.71797e-39    0.642793  0.641105
CCNE1         5  1.77239e-04  2.95398e-04    0.547178  0.547178
CCNA1         6  8.67796e-02  1.23971e-01    0.522934  0.522934
CCNB3         8  4.88618e-01  6.10772e-01    0.501075  0.500715
CCND1         8  6.99189e-01  7.76877e-01    0.501142  0.490244
CCND2         8  1.00000e+00  1.00000e+00    0.509288  0.323983
          AUC.2     AUC.3     AUC.4     AUC.5     AUC.6     AUC.7
      &lt;numeric&gt; &lt;numeric&gt; &lt;numeric&gt; &lt;numeric&gt; &lt;numeric&gt; &lt;numeric&gt;
CCNA2  0.843281  0.841791  0.845650  0.844884  0.844037  0.844084
CCNB2  0.833734  0.829177  0.834188  0.835210  0.834722  0.836116
CCNB1  0.782023  0.778047  0.777010  0.778627  0.783397  0.777562
CCND3  0.550632  0.744858  0.809909  0.519120  0.568795  0.610817
CCNE2  0.642793  0.644444  0.640699  0.639405  0.644444  0.641097
CCNE1  0.540656  0.544193  0.540975  0.548282  0.549462  0.545080
CCNA1  0.519401  0.513455  0.519594  0.521494  0.523297  0.522773
CCNB3  0.501075  0.501075  0.501075  0.501075  0.501075  0.501075
CCND1  0.501142  0.501434  0.491444  0.498494  0.499784  0.500927
CCND2  0.509288  0.456383  0.478717  0.341492  0.397354  0.398468
          AUC.9    AUC.10
      &lt;numeric&gt; &lt;numeric&gt;
CCNA2  0.844647  0.843715
CCNB2  0.825768  0.834878
CCNB1  0.778895  0.778932
CCND3  0.757194  0.580631
CCNE2  0.639583  0.640585
CCNE1  0.547782  0.537729
CCNA1  0.522166  0.522176
CCNB3  0.501075  0.500530
CCND1  0.499782  0.500887
CCND2  0.316764  0.449001</code></pre>
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># Using the cyclone() classifier -----------------------------------------------</span>

<span class='co'># TODO: Save output from run on vc7-shared and load here.</span>
<span class='co'># hs.pairs &lt;- readRDS(system.file("exdata", "human_cycle_markers.rds",</span>
<span class='co'>#                                 package="scran"))</span>
<span class='co'>#</span>
<span class='co'># # Using Ensembl IDs to match up with the annotation in 'hs.pairs'.</span>
<span class='co'># NOTE: This was run and the results saved.</span>
<span class='co'># set.seed(100)</span>
<span class='co'># assignments &lt;- cyclone(</span>
<span class='co'>#   sce,</span>
<span class='co'>#   hs.pairs,</span>
<span class='co'>#   gene.names = rowData(sce)$ENSEMBL.GENEID)</span>
<span class='va'>assignments</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/readRDS.html'>readRDS</a></span><span class='op'>(</span><span class='fu'><a href='https://here.r-lib.org//reference/here.html'>here</a></span><span class='op'>(</span><span class='st'>"tmp/cyclone_assignments.rds"</span><span class='op'>)</span><span class='op'>)</span>

<span class='fu'><a href='https://rdrr.io/r/graphics/plot.default.html'>plot</a></span><span class='op'>(</span>
  x <span class='op'>=</span> <span class='va'>assignments</span><span class='op'>$</span><span class='va'>score</span><span class='op'>$</span><span class='va'>G1</span>,
  y <span class='op'>=</span> <span class='va'>assignments</span><span class='op'>$</span><span class='va'>score</span><span class='op'>$</span><span class='va'>G2M</span>,
  xlab <span class='op'>=</span> <span class='st'>"G1 score"</span>,
  ylab <span class='op'>=</span> <span class='st'>"G2/M score"</span>,
  pch <span class='op'>=</span> <span class='fl'>16</span>,
  col <span class='op'>=</span> <span class='va'>sce</span><span class='op'>$</span><span class='va'>cluster_colours</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<img src="annotation_DE_DA_files/figure-html5/unnamed-chunk-1-23.png" width="624" />
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/r/graphics/boxplot.html'>boxplot</a></span><span class='op'>(</span><span class='va'>assignments</span><span class='op'>$</span><span class='va'>scores</span><span class='op'>$</span><span class='va'>G1</span> <span class='op'>~</span> <span class='va'>sce</span><span class='op'>$</span><span class='va'>cluster</span>, ylab <span class='op'>=</span> <span class='st'>"G1"</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<img src="annotation_DE_DA_files/figure-html5/unnamed-chunk-1-24.png" width="624" />
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/r/graphics/boxplot.html'>boxplot</a></span><span class='op'>(</span><span class='va'>assignments</span><span class='op'>$</span><span class='va'>scores</span><span class='op'>$</span><span class='va'>G2M</span> <span class='op'>~</span> <span class='va'>sce</span><span class='op'>$</span><span class='va'>cluster</span>, ylab <span class='op'>=</span> <span class='st'>"G2M"</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<img src="annotation_DE_DA_files/figure-html5/unnamed-chunk-1-25.png" width="624" />
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/r/base/proportions.html'>proportions</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/table.html'>table</a></span><span class='op'>(</span><span class='va'>sce</span><span class='op'>$</span><span class='va'>cluster</span>, <span class='va'>assignments</span><span class='op'>$</span><span class='va'>phases</span><span class='op'>)</span>, <span class='fl'>1</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<pre><code>    
              G1         G2M           S
  1  0.738660907 0.002159827 0.259179266
  2  0.659289458 0.006988934 0.333721607
  3  0.163461538 0.057692308 0.778846154
  4  0.757246377 0.001811594 0.240942029
  5  0.726846424 0.003516999 0.269636577
  6  0.700657895 0.006578947 0.292763158
  7  0.647118301 0.001011122 0.351870576
  8  0.478136201 0.313978495 0.207885305
  9  0.698133919 0.006586169 0.295279912
  10 0.721919302 0.005452563 0.272628135</code></pre>
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/r/base/proportions.html'>proportions</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/table.html'>table</a></span><span class='op'>(</span><span class='va'>sce</span><span class='op'>$</span><span class='va'>cycling_cluster</span>, <span class='va'>assignments</span><span class='op'>$</span><span class='va'>phases</span><span class='op'>)</span>, <span class='fl'>1</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<pre><code>             
                       G1         G2M           S
  Cycling     0.478136201 0.313978495 0.207885305
  Not cycling 0.693381593 0.005041365 0.301577042</code></pre>
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/pkg/scater/man/plot_reddim.html'>plotUMAP</a></span><span class='op'>(</span>
  <span class='va'>sce</span>,
  colour_by <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/data.frame.html'>data.frame</a></span><span class='op'>(</span>G1 <span class='op'>=</span> <span class='va'>assignments</span><span class='op'>$</span><span class='va'>score</span><span class='op'>$</span><span class='va'>G1</span><span class='op'>)</span>,
  text_by <span class='op'>=</span> <span class='st'>"cluster"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://rdrr.io/pkg/scater/man/plot_reddim.html'>plotUMAP</a></span><span class='op'>(</span>
    <span class='va'>sce</span>,
    colour_by <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/data.frame.html'>data.frame</a></span><span class='op'>(</span>G2M <span class='op'>=</span> <span class='va'>assignments</span><span class='op'>$</span><span class='va'>score</span><span class='op'>$</span><span class='va'>G2M</span><span class='op'>)</span>,
    text_by <span class='op'>=</span> <span class='st'>"cluster"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://rdrr.io/pkg/scater/man/plot_reddim.html'>plotUMAP</a></span><span class='op'>(</span><span class='va'>sce</span>, colour_by <span class='op'>=</span> <span class='st'>"cluster"</span>, text_by <span class='op'>=</span> <span class='st'>"cluster"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>scale_colour_manual</span><span class='op'>(</span>values <span class='op'>=</span> <span class='va'>cluster_colours</span>, name <span class='op'>=</span> <span class='st'>"cluster"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://patchwork.data-imaginist.com/reference/plot_layout.html'>plot_layout</a></span><span class='op'>(</span>ncol <span class='op'>=</span> <span class='fl'>2</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<img src="annotation_DE_DA_files/figure-html5/unnamed-chunk-1-26.png" width="624" />
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># DE analysis using cycling vs. non-cycling labels -----------------------------</span>

<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='http://bioinf.wehi.edu.au/edgeR'>edgeR</a></span><span class='op'>)</span>
<span class='va'>plotMDS</span> <span class='op'>&lt;-</span> <span class='fu'>scater</span><span class='fu'>::</span><span class='va'><a href='https://rdrr.io/pkg/scater/man/plot_reddim.html'>plotMDS</a></span>

<span class='co'># NOTE: Have to drop the complicated TRA and TRB DFrameList objects.</span>
<span class='va'>tmp</span> <span class='op'>&lt;-</span> <span class='va'>sce</span>
<span class='va'>tmp</span><span class='op'>$</span><span class='va'>TRA</span> <span class='op'>&lt;-</span> <span class='cn'>NULL</span>
<span class='va'>tmp</span><span class='op'>$</span><span class='va'>TRB</span> <span class='op'>&lt;-</span> <span class='cn'>NULL</span>
<span class='va'>summed</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scuttle/man/aggregateAcrossCells.html'>aggregateAcrossCells</a></span><span class='op'>(</span>
  <span class='va'>tmp</span>,
  id <span class='op'>=</span> <span class='fu'>colData</span><span class='op'>(</span><span class='va'>tmp</span><span class='op'>)</span><span class='op'>[</span>, <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"cycling_cluster"</span>, <span class='st'>"Sample"</span><span class='op'>)</span><span class='op'>]</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/pkg/SingleCellExperiment/man/sizeFactors.html'>sizeFactors</a></span><span class='op'>(</span><span class='va'>summed</span><span class='op'>)</span> <span class='op'>&lt;-</span> <span class='cn'>NULL</span>
<span class='va'>summed</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scuttle/man/logNormCounts.html'>logNormCounts</a></span><span class='op'>(</span><span class='va'>summed</span><span class='op'>)</span>

<span class='va'>summed</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scater/man/runMDS.html'>runMDS</a></span><span class='op'>(</span><span class='va'>summed</span><span class='op'>)</span>
<span class='va'>p1</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scater/man/plot_reddim.html'>plotMDS</a></span><span class='op'>(</span><span class='va'>summed</span>, colour_by <span class='op'>=</span> <span class='st'>"Treatment"</span>, shape_by <span class='op'>=</span> <span class='st'>"cycling_cluster"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>scale_colour_manual</span><span class='op'>(</span>values <span class='op'>=</span> <span class='va'>treatment_colours</span>, name <span class='op'>=</span> <span class='st'>"Treatment"</span><span class='op'>)</span>
<span class='va'>p2</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scater/man/plot_reddim.html'>plotMDS</a></span><span class='op'>(</span><span class='va'>summed</span>, colour_by <span class='op'>=</span> <span class='st'>"Sample"</span>, shape_by <span class='op'>=</span> <span class='st'>"cycling_cluster"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>scale_colour_manual</span><span class='op'>(</span>values <span class='op'>=</span> <span class='va'>sample_colours</span>, name <span class='op'>=</span> <span class='st'>"Sample"</span><span class='op'>)</span>
<span class='va'>p1</span> <span class='op'>+</span> <span class='va'>p2</span> <span class='op'>+</span> <span class='fu'><a href='https://patchwork.data-imaginist.com/reference/plot_layout.html'>plot_layout</a></span><span class='op'>(</span>guides <span class='op'>=</span> <span class='st'>"collect"</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<img src="annotation_DE_DA_files/figure-html5/unnamed-chunk-1-27.png" width="624" />
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>summed.filt</span> <span class='op'>&lt;-</span> <span class='va'>summed</span><span class='op'>[</span>,<span class='va'>summed</span><span class='op'>$</span><span class='va'>ncells</span> <span class='op'>&gt;=</span> <span class='fl'>10</span><span class='op'>]</span>

<span class='va'>de.results</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scran/man/pseudoBulkDGE.html'>pseudoBulkDGE</a></span><span class='op'>(</span>
  <span class='va'>summed.filt</span>,
  label <span class='op'>=</span> <span class='va'>summed.filt</span><span class='op'>$</span><span class='va'>cycling_cluster</span>,
  design <span class='op'>=</span> <span class='op'>~</span><span class='va'>Treatment</span>,
  coef <span class='op'>=</span> <span class='st'>"TreatmentUninfected"</span>,
  condition <span class='op'>=</span> <span class='va'>summed.filt</span><span class='op'>$</span><span class='va'>Treatment</span>,
  include.intermediates <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span>

<span class='va'>cur.results</span> <span class='op'>&lt;-</span> <span class='va'>de.results</span><span class='op'>[[</span><span class='st'>"Not cycling"</span><span class='op'>]</span><span class='op'>]</span>
<span class='va'>cur.results</span><span class='op'>[</span><span class='fu'><a href='https://rdrr.io/r/base/order.html'>order</a></span><span class='op'>(</span><span class='va'>cur.results</span><span class='op'>$</span><span class='va'>PValue</span><span class='op'>)</span>,<span class='op'>]</span>
</code></pre>
</div>
</details>
<pre><code>DataFrame with 20602 rows and 5 columns
               logFC    logCPM         F      PValue         FDR
           &lt;numeric&gt; &lt;numeric&gt; &lt;numeric&gt;   &lt;numeric&gt;   &lt;numeric&gt;
GLUL        -1.97085   6.53864   408.519 1.57230e-09 9.67932e-06
IL4R        -1.26671   6.38142   389.426 1.75926e-09 9.67932e-06
NSMCE1      -1.07070   7.29219   349.346 3.02519e-09 9.67932e-06
CADM1       -3.69238   4.58859   421.521 3.45844e-09 9.67932e-06
CHST7       -1.63813   5.58938   260.960 1.28684e-08 2.88123e-05
...              ...       ...       ...         ...         ...
AL354822.1        NA        NA        NA          NA          NA
AC004556.1        NA        NA        NA          NA          NA
AC233755.2        NA        NA        NA          NA          NA
AC233755.1        NA        NA        NA          NA          NA
AC240274.1        NA        NA        NA          NA          NA</code></pre>
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/pkg/SingleCellExperiment/man/sizeFactors.html'>sizeFactors</a></span><span class='op'>(</span><span class='va'>summed.filt</span><span class='op'>)</span> <span class='op'>&lt;-</span> <span class='cn'>NULL</span>
<span class='fu'><a href='https://rdrr.io/pkg/scater/man/plotExpression.html'>plotExpression</a></span><span class='op'>(</span>
  <span class='fu'><a href='https://rdrr.io/pkg/scuttle/man/logNormCounts.html'>logNormCounts</a></span><span class='op'>(</span><span class='va'>summed.filt</span><span class='op'>)</span>,
  features <span class='op'>=</span> <span class='st'>"IL4R"</span>,
  x <span class='op'>=</span> <span class='st'>"Treatment"</span>,
  colour_by <span class='op'>=</span> <span class='st'>"Treatment"</span>,
  other_fields <span class='op'>=</span> <span class='st'>"cycling_cluster"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>facet_wrap</span><span class='op'>(</span><span class='op'>~</span><span class='va'>cycling_cluster</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>scale_colour_manual</span><span class='op'>(</span>values <span class='op'>=</span> <span class='va'>treatment_colours</span>, name <span class='op'>=</span> <span class='st'>"Treatment"</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<img src="annotation_DE_DA_files/figure-html5/unnamed-chunk-1-28.png" width="624" />
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>y.cur.results</span> <span class='op'>&lt;-</span> <span class='fu'>metadata</span><span class='op'>(</span><span class='va'>cur.results</span><span class='op'>)</span><span class='op'>$</span><span class='va'>y</span>
<span class='fu'><a href='https://rdrr.io/pkg/edgeR/man/plotBCV.html'>plotBCV</a></span><span class='op'>(</span><span class='va'>y.cur.results</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<img src="annotation_DE_DA_files/figure-html5/unnamed-chunk-1-29.png" width="624" />
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'>metadata</span><span class='op'>(</span><span class='va'>de.results</span><span class='op'>)</span><span class='op'>$</span><span class='va'>failed</span>
</code></pre>
</div>
</details>
<pre><code>character(0)</code></pre>
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>is.de</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scran/man/decideTestsPerLabel.html'>decideTestsPerLabel</a></span><span class='op'>(</span><span class='va'>de.results</span>, threshold<span class='op'>=</span><span class='fl'>0.05</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/pkg/scran/man/decideTestsPerLabel.html'>summarizeTestsPerLabel</a></span><span class='op'>(</span><span class='va'>is.de</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<pre><code>             -1     0   1    NA
Cycling     183  9560 147 10712
Not cycling 617 10048 530  9407</code></pre>
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># Upregulated across most labels</span>
<span class='va'>up.de</span> <span class='op'>&lt;-</span> <span class='va'>is.de</span> <span class='op'>&gt;</span> <span class='fl'>0</span> <span class='op'>&amp;</span> <span class='op'>!</span><span class='fu'><a href='https://rdrr.io/r/base/NA.html'>is.na</a></span><span class='op'>(</span><span class='va'>is.de</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/utils/head.html'>head</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/sort.html'>sort</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/colSums.html'>rowMeans</a></span><span class='op'>(</span><span class='va'>up.de</span><span class='op'>)</span>, decreasing<span class='op'>=</span><span class='cn'>TRUE</span><span class='op'>)</span>, <span class='fl'>10</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<pre><code>  RCAN3    IFI6 CCDC28B  PIK3R3  CDKN2C   IFI44  FNBP1L   THEM4 
      1       1       1       1       1       1       1       1 
     F5   GPR25 
      1       1 </code></pre>
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># Downregulated across most labels</span>
<span class='va'>down.de</span> <span class='op'>&lt;-</span> <span class='va'>is.de</span> <span class='op'>&lt;</span> <span class='fl'>0</span> <span class='op'>&amp;</span> <span class='op'>!</span><span class='fu'><a href='https://rdrr.io/r/base/NA.html'>is.na</a></span><span class='op'>(</span><span class='va'>is.de</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/utils/head.html'>head</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/sort.html'>sort</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/colSums.html'>rowMeans</a></span><span class='op'>(</span><span class='va'>down.de</span><span class='op'>)</span>, decreasing<span class='op'>=</span><span class='cn'>TRUE</span><span class='op'>)</span>, <span class='fl'>10</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<pre><code>   DHRS3  ZBTB8OS    TTC22 KIAA1324  PDE4DIP     AIM2   ATP1B1 
       1        1        1        1        1        1        1 
    NME7     GLUL     RGS2 
       1        1        1 </code></pre>
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>de.specific</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scran/man/pseudoBulkSpecific.html'>pseudoBulkSpecific</a></span><span class='op'>(</span>
  <span class='va'>summed.filt</span>,
  label <span class='op'>=</span> <span class='va'>summed.filt</span><span class='op'>$</span><span class='va'>cycling_cluster</span>,
  design <span class='op'>=</span> <span class='op'>~</span><span class='va'>Treatment</span>,
  coef <span class='op'>=</span> <span class='st'>"TreatmentUninfected"</span>,
  condition <span class='op'>=</span> <span class='va'>summed.filt</span><span class='op'>$</span><span class='va'>Treatment</span><span class='op'>)</span>

<span class='va'>cur.specific</span> <span class='op'>&lt;-</span> <span class='va'>de.specific</span><span class='op'>[[</span><span class='st'>"Not cycling"</span><span class='op'>]</span><span class='op'>]</span>
<span class='va'>cur.specific</span> <span class='op'>&lt;-</span> <span class='va'>cur.specific</span><span class='op'>[</span><span class='fu'><a href='https://rdrr.io/r/base/order.html'>order</a></span><span class='op'>(</span><span class='va'>cur.specific</span><span class='op'>$</span><span class='va'>PValue</span><span class='op'>)</span>,<span class='op'>]</span>
<span class='va'>cur.specific</span>
</code></pre>
</div>
</details>
<pre><code>DataFrame with 20602 rows and 6 columns
               logFC    logCPM         F      PValue        FDR
           &lt;numeric&gt; &lt;numeric&gt; &lt;numeric&gt;   &lt;numeric&gt;  &lt;numeric&gt;
PTGER2       4.84777   2.54622  135.2807 3.15865e-07 0.00353611
TRBV10-1     3.31391   3.72002  136.4802 1.62083e-06 0.00722661
LINC00891    2.96688   2.00801   92.1348 1.93656e-06 0.00722661
ATP6V0A1     3.26980   1.69805   79.6872 3.78419e-06 0.00923658
NBPF1        1.66827   2.69831   76.9033 4.45254e-06 0.00923658
...              ...       ...       ...         ...        ...
AL354822.1        NA        NA        NA          NA         NA
AC004556.1        NA        NA        NA          NA         NA
AC233755.2        NA        NA        NA          NA         NA
AC233755.1        NA        NA        NA          NA         NA
AC240274.1        NA        NA        NA          NA         NA
           OtherAverage
              &lt;numeric&gt;
PTGER2               NA
TRBV10-1     0.00901858
LINC00891            NA
ATP6V0A1             NA
NBPF1                NA
...                 ...
AL354822.1           NA
AC004556.1           NA
AC233755.2           NA
AC233755.1           NA
AC240274.1           NA</code></pre>
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># DE analysis using cluster labels ---------------------------------------------</span>

<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='http://bioinf.wehi.edu.au/edgeR'>edgeR</a></span><span class='op'>)</span>
<span class='va'>plotMDS</span> <span class='op'>&lt;-</span> <span class='fu'>scater</span><span class='fu'>::</span><span class='va'><a href='https://rdrr.io/pkg/scater/man/plot_reddim.html'>plotMDS</a></span>

<span class='co'># NOTE: Have to drop the complicated TRA and TRB DFrameList objects.</span>
<span class='va'>tmp</span> <span class='op'>&lt;-</span> <span class='va'>sce</span>
<span class='va'>tmp</span><span class='op'>$</span><span class='va'>TRA</span> <span class='op'>&lt;-</span> <span class='cn'>NULL</span>
<span class='va'>tmp</span><span class='op'>$</span><span class='va'>TRB</span> <span class='op'>&lt;-</span> <span class='cn'>NULL</span>
<span class='va'>summed</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scuttle/man/aggregateAcrossCells.html'>aggregateAcrossCells</a></span><span class='op'>(</span>
  <span class='va'>tmp</span>,
  id <span class='op'>=</span> <span class='fu'>colData</span><span class='op'>(</span><span class='va'>tmp</span><span class='op'>)</span><span class='op'>[</span>, <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"cluster"</span>, <span class='st'>"Sample"</span><span class='op'>)</span><span class='op'>]</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/pkg/SingleCellExperiment/man/sizeFactors.html'>sizeFactors</a></span><span class='op'>(</span><span class='va'>summed</span><span class='op'>)</span> <span class='op'>&lt;-</span> <span class='cn'>NULL</span>
<span class='va'>summed</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scuttle/man/logNormCounts.html'>logNormCounts</a></span><span class='op'>(</span><span class='va'>summed</span><span class='op'>)</span>

<span class='va'>summed</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scater/man/runMDS.html'>runMDS</a></span><span class='op'>(</span><span class='va'>summed</span><span class='op'>)</span>
<span class='va'>p1</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scater/man/plot_reddim.html'>plotMDS</a></span><span class='op'>(</span><span class='va'>summed</span>, colour_by <span class='op'>=</span> <span class='st'>"cluster"</span>, shape_by <span class='op'>=</span> <span class='st'>"Treatment"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>scale_colour_manual</span><span class='op'>(</span>values <span class='op'>=</span> <span class='va'>cluster_colours</span>, name <span class='op'>=</span> <span class='st'>"cluster"</span><span class='op'>)</span>
<span class='va'>p2</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scater/man/plot_reddim.html'>plotMDS</a></span><span class='op'>(</span><span class='va'>summed</span>, colour_by <span class='op'>=</span> <span class='st'>"cluster"</span>, shape_by <span class='op'>=</span> <span class='st'>"Sample"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>scale_colour_manual</span><span class='op'>(</span>values <span class='op'>=</span> <span class='va'>cluster_colours</span>, name <span class='op'>=</span> <span class='st'>"cluster"</span><span class='op'>)</span>
<span class='va'>p1</span> <span class='op'>+</span> <span class='va'>p2</span> <span class='op'>+</span> <span class='fu'><a href='https://patchwork.data-imaginist.com/reference/plot_layout.html'>plot_layout</a></span><span class='op'>(</span>guides <span class='op'>=</span> <span class='st'>"collect"</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<img src="annotation_DE_DA_files/figure-html5/unnamed-chunk-1-30.png" width="624" />
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>summed.filt</span> <span class='op'>&lt;-</span> <span class='va'>summed</span><span class='op'>[</span>,<span class='va'>summed</span><span class='op'>$</span><span class='va'>ncells</span> <span class='op'>&gt;=</span> <span class='fl'>10</span><span class='op'>]</span>

<span class='va'>de.results</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scran/man/pseudoBulkDGE.html'>pseudoBulkDGE</a></span><span class='op'>(</span>
  <span class='va'>summed.filt</span>,
  label <span class='op'>=</span> <span class='va'>summed.filt</span><span class='op'>$</span><span class='va'>cluster</span>,
  design <span class='op'>=</span> <span class='op'>~</span><span class='va'>Treatment</span>,
  coef <span class='op'>=</span> <span class='st'>"TreatmentUninfected"</span>,
  condition <span class='op'>=</span> <span class='va'>summed.filt</span><span class='op'>$</span><span class='va'>Treatment</span>,
  include.intermediates <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span>

<span class='va'>cur.results</span> <span class='op'>&lt;-</span> <span class='va'>de.results</span><span class='op'>[[</span><span class='st'>"8"</span><span class='op'>]</span><span class='op'>]</span>
<span class='va'>cur.results</span><span class='op'>[</span><span class='fu'><a href='https://rdrr.io/r/base/order.html'>order</a></span><span class='op'>(</span><span class='va'>cur.results</span><span class='op'>$</span><span class='va'>PValue</span><span class='op'>)</span>,<span class='op'>]</span>
</code></pre>
</div>
</details>
<pre><code>DataFrame with 20602 rows and 5 columns
               logFC    logCPM         F      PValue         FDR
           &lt;numeric&gt; &lt;numeric&gt; &lt;numeric&gt;   &lt;numeric&gt;   &lt;numeric&gt;
CADM1       -4.41554   4.93024   413.094 1.58133e-11 1.56393e-07
GLUL        -2.04934   6.68893   355.098 4.25676e-11 2.10497e-07
LTA          3.07047   4.89093   287.890 1.66639e-10 5.49355e-07
APBA2       -4.32479   3.61273   176.907 3.76220e-09 9.30203e-06
RASGRP4      4.42101   3.35886   122.077 3.78884e-08 7.49433e-05
...              ...       ...       ...         ...         ...
AL354822.1        NA        NA        NA          NA          NA
AC004556.1        NA        NA        NA          NA          NA
AC233755.2        NA        NA        NA          NA          NA
AC233755.1        NA        NA        NA          NA          NA
AC240274.1        NA        NA        NA          NA          NA</code></pre>
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/pkg/SingleCellExperiment/man/sizeFactors.html'>sizeFactors</a></span><span class='op'>(</span><span class='va'>summed.filt</span><span class='op'>)</span> <span class='op'>&lt;-</span> <span class='cn'>NULL</span>
<span class='fu'><a href='https://rdrr.io/pkg/scater/man/plotExpression.html'>plotExpression</a></span><span class='op'>(</span>
  <span class='fu'><a href='https://rdrr.io/pkg/scuttle/man/logNormCounts.html'>logNormCounts</a></span><span class='op'>(</span><span class='va'>summed.filt</span><span class='op'>)</span>,
  features <span class='op'>=</span> <span class='st'>"CADM1"</span>,
  x <span class='op'>=</span> <span class='st'>"Treatment"</span>,
  colour_by <span class='op'>=</span> <span class='st'>"Treatment"</span>,
  other_fields <span class='op'>=</span> <span class='st'>"cluster"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>facet_wrap</span><span class='op'>(</span><span class='op'>~</span><span class='va'>cluster</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>scale_colour_manual</span><span class='op'>(</span>values <span class='op'>=</span> <span class='va'>treatment_colours</span>, name <span class='op'>=</span> <span class='st'>"Treatment"</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<img src="annotation_DE_DA_files/figure-html5/unnamed-chunk-1-31.png" width="624" />
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>y.cur.results</span> <span class='op'>&lt;-</span> <span class='fu'>metadata</span><span class='op'>(</span><span class='va'>cur.results</span><span class='op'>)</span><span class='op'>$</span><span class='va'>y</span>
<span class='fu'><a href='https://rdrr.io/pkg/edgeR/man/plotBCV.html'>plotBCV</a></span><span class='op'>(</span><span class='va'>y.cur.results</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<img src="annotation_DE_DA_files/figure-html5/unnamed-chunk-1-32.png" width="624" />
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'>metadata</span><span class='op'>(</span><span class='va'>de.results</span><span class='op'>)</span><span class='op'>$</span><span class='va'>failed</span>
</code></pre>
</div>
</details>
<pre><code>[1] &quot;3&quot; &quot;6&quot;</code></pre>
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>is.de</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scran/man/decideTestsPerLabel.html'>decideTestsPerLabel</a></span><span class='op'>(</span><span class='va'>de.results</span>, threshold<span class='op'>=</span><span class='fl'>0.05</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/pkg/scran/man/decideTestsPerLabel.html'>summarizeTestsPerLabel</a></span><span class='op'>(</span><span class='va'>is.de</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<pre><code>    -1    0   1    NA
1   32 8878  14 11678
10  10 6258   4 14330
2   10 7089   7 13496
4  242 5206 254 14900
5    5 7592   6 12999
7   10 7505  11 13076
8  183 9560 147 10712
9   29 8253  27 12293</code></pre>
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># Upregulated across most labels</span>
<span class='va'>up.de</span> <span class='op'>&lt;-</span> <span class='va'>is.de</span> <span class='op'>&gt;</span> <span class='fl'>0</span> <span class='op'>&amp;</span> <span class='op'>!</span><span class='fu'><a href='https://rdrr.io/r/base/NA.html'>is.na</a></span><span class='op'>(</span><span class='va'>is.de</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/utils/head.html'>head</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/sort.html'>sort</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/colSums.html'>rowMeans</a></span><span class='op'>(</span><span class='va'>up.de</span><span class='op'>)</span>, decreasing<span class='op'>=</span><span class='cn'>TRUE</span><span class='op'>)</span>, <span class='fl'>10</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<pre><code>  CISH   XAF1  RCAN3  GPR25  FOXP1  PLAC8    LTB    TOX TBC1D4  ISG15 
 0.500  0.500  0.375  0.375  0.375  0.375  0.375  0.375  0.375  0.250 </code></pre>
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># Downregulated across most labels</span>
<span class='va'>down.de</span> <span class='op'>&lt;-</span> <span class='va'>is.de</span> <span class='op'>&lt;</span> <span class='fl'>0</span> <span class='op'>&amp;</span> <span class='op'>!</span><span class='fu'><a href='https://rdrr.io/r/base/NA.html'>is.na</a></span><span class='op'>(</span><span class='va'>is.de</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/utils/head.html'>head</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/sort.html'>sort</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/colSums.html'>rowMeans</a></span><span class='op'>(</span><span class='va'>down.de</span><span class='op'>)</span>, decreasing<span class='op'>=</span><span class='cn'>TRUE</span><span class='op'>)</span>, <span class='fl'>10</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<pre><code>    GLUL     RGS2     CBLB     CD74  HLA-DRA   NFKBIA     LMO4 
   0.750    0.750    0.625    0.625    0.625    0.625    0.500 
HLA-DRB5 HLA-DRB1 HLA-DPA1 
   0.500    0.500    0.500 </code></pre>
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>de.specific</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scran/man/pseudoBulkSpecific.html'>pseudoBulkSpecific</a></span><span class='op'>(</span>
  <span class='va'>summed.filt</span>,
  label <span class='op'>=</span> <span class='va'>summed.filt</span><span class='op'>$</span><span class='va'>cluster</span>,
  design <span class='op'>=</span> <span class='op'>~</span><span class='va'>Treatment</span>,
  coef <span class='op'>=</span> <span class='st'>"TreatmentUninfected"</span>,
  condition <span class='op'>=</span> <span class='va'>summed.filt</span><span class='op'>$</span><span class='va'>Treatment</span><span class='op'>)</span>

<span class='va'>cur.specific</span> <span class='op'>&lt;-</span> <span class='va'>de.specific</span><span class='op'>[[</span><span class='st'>"8"</span><span class='op'>]</span><span class='op'>]</span>
<span class='va'>cur.specific</span> <span class='op'>&lt;-</span> <span class='va'>cur.specific</span><span class='op'>[</span><span class='fu'><a href='https://rdrr.io/r/base/order.html'>order</a></span><span class='op'>(</span><span class='va'>cur.specific</span><span class='op'>$</span><span class='va'>PValue</span><span class='op'>)</span>,<span class='op'>]</span>
<span class='va'>cur.specific</span>
</code></pre>
</div>
</details>
<pre><code>DataFrame with 20602 rows and 6 columns
               logFC    logCPM         F      PValue        FDR
           &lt;numeric&gt; &lt;numeric&gt; &lt;numeric&gt;   &lt;numeric&gt;  &lt;numeric&gt;
CHN2        -2.82549   3.29849   88.9951 2.55015e-07 0.00105827
LTA          3.07047   4.89093  287.8897 2.78324e-07 0.00105827
GLB1L3      -3.15161   2.93790   85.5971 3.21012e-07 0.00105827
FNBP1L       4.90794   2.14151   72.4389 8.49798e-07 0.00206386
CTSW        -1.30698   5.13668   69.8988 1.04341e-06 0.00206386
...              ...       ...       ...         ...        ...
AL354822.1        NA        NA        NA          NA         NA
AC004556.1        NA        NA        NA          NA         NA
AC233755.2        NA        NA        NA          NA         NA
AC233755.1        NA        NA        NA          NA         NA
AC240274.1        NA        NA        NA          NA         NA
           OtherAverage
              &lt;numeric&gt;
CHN2                 NA
LTA            1.350294
GLB1L3               NA
FNBP1L               NA
CTSW           0.771803
...                 ...
AL354822.1           NA
AC004556.1           NA
AC233755.2           NA
AC233755.1           NA
AC240274.1           NA</code></pre>
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># DE analysis using subcluster labels in non-cycling clusters ------------------</span>

<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='http://bioinf.wehi.edu.au/edgeR'>edgeR</a></span><span class='op'>)</span>
<span class='va'>plotMDS</span> <span class='op'>&lt;-</span> <span class='fu'>scater</span><span class='fu'>::</span><span class='va'><a href='https://rdrr.io/pkg/scater/man/plot_reddim.html'>plotMDS</a></span>

<span class='co'># NOTE: Have to drop the complicated TRA and TRB DFrameList objects.</span>
<span class='va'>tmp</span> <span class='op'>&lt;-</span> <span class='va'>list_of_sce</span><span class='op'>$</span><span class='va'>`Not cycling`</span>
<span class='va'>tmp</span><span class='op'>$</span><span class='va'>TRA</span> <span class='op'>&lt;-</span> <span class='cn'>NULL</span>
<span class='va'>tmp</span><span class='op'>$</span><span class='va'>TRB</span> <span class='op'>&lt;-</span> <span class='cn'>NULL</span>
<span class='va'>summed</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scuttle/man/aggregateAcrossCells.html'>aggregateAcrossCells</a></span><span class='op'>(</span>
  <span class='va'>tmp</span>,
  id <span class='op'>=</span> <span class='fu'>colData</span><span class='op'>(</span><span class='va'>tmp</span><span class='op'>)</span><span class='op'>[</span>, <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"subcluster"</span>, <span class='st'>"Sample"</span><span class='op'>)</span><span class='op'>]</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/pkg/SingleCellExperiment/man/sizeFactors.html'>sizeFactors</a></span><span class='op'>(</span><span class='va'>summed</span><span class='op'>)</span> <span class='op'>&lt;-</span> <span class='cn'>NULL</span>
<span class='va'>summed</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scuttle/man/logNormCounts.html'>logNormCounts</a></span><span class='op'>(</span><span class='va'>summed</span><span class='op'>)</span>

<span class='va'>summed</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scater/man/runMDS.html'>runMDS</a></span><span class='op'>(</span><span class='va'>summed</span><span class='op'>)</span>
<span class='va'>p1</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scater/man/plot_reddim.html'>plotMDS</a></span><span class='op'>(</span><span class='va'>summed</span>, colour_by <span class='op'>=</span> <span class='st'>"subcluster"</span>, shape_by <span class='op'>=</span> <span class='st'>"Treatment"</span><span class='op'>)</span>
<span class='va'>p2</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scater/man/plot_reddim.html'>plotMDS</a></span><span class='op'>(</span><span class='va'>summed</span>, colour_by <span class='op'>=</span> <span class='st'>"subcluster"</span>, shape_by <span class='op'>=</span> <span class='st'>"Sample"</span><span class='op'>)</span>
<span class='va'>p1</span> <span class='op'>+</span> <span class='va'>p2</span> <span class='op'>+</span> <span class='fu'><a href='https://patchwork.data-imaginist.com/reference/plot_layout.html'>plot_layout</a></span><span class='op'>(</span>guides <span class='op'>=</span> <span class='st'>"collect"</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<img src="annotation_DE_DA_files/figure-html5/unnamed-chunk-1-33.png" width="624" />
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>summed.filt</span> <span class='op'>&lt;-</span> <span class='va'>summed</span><span class='op'>[</span>,<span class='va'>summed</span><span class='op'>$</span><span class='va'>ncells</span> <span class='op'>&gt;=</span> <span class='fl'>10</span><span class='op'>]</span>

<span class='va'>de.results</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scran/man/pseudoBulkDGE.html'>pseudoBulkDGE</a></span><span class='op'>(</span>
  <span class='va'>summed.filt</span>,
  label <span class='op'>=</span> <span class='va'>summed.filt</span><span class='op'>$</span><span class='va'>subcluster</span>,
  design <span class='op'>=</span> <span class='op'>~</span><span class='va'>Treatment</span>,
  coef <span class='op'>=</span> <span class='st'>"TreatmentUninfected"</span>,
  condition <span class='op'>=</span> <span class='va'>summed.filt</span><span class='op'>$</span><span class='va'>Treatment</span>,
  include.intermediates <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span>

<span class='va'>cur.results</span> <span class='op'>&lt;-</span> <span class='va'>de.results</span><span class='op'>[[</span><span class='st'>"Not cycling.4"</span><span class='op'>]</span><span class='op'>]</span>
<span class='va'>cur.results</span><span class='op'>[</span><span class='fu'><a href='https://rdrr.io/r/base/order.html'>order</a></span><span class='op'>(</span><span class='va'>cur.results</span><span class='op'>$</span><span class='va'>PValue</span><span class='op'>)</span>,<span class='op'>]</span>
</code></pre>
</div>
</details>
<pre><code>DataFrame with 20602 rows and 5 columns
               logFC    logCPM         F      PValue        FDR
           &lt;numeric&gt; &lt;numeric&gt; &lt;numeric&gt;   &lt;numeric&gt;  &lt;numeric&gt;
CISH        2.981798   3.73973   74.8370 3.82607e-07 0.00192372
GPR25       2.097036   5.02550   73.6263 4.23308e-07 0.00192372
RASGRP4     6.036752   1.38445   63.0885 1.08835e-06 0.00329735
CD74       -0.710945  11.53186   50.7015 3.96384e-06 0.00900684
ITGB1      -0.766457  10.32276   48.0432 5.40378e-06 0.00982299
...              ...       ...       ...         ...        ...
AL354822.1        NA        NA        NA          NA         NA
AC004556.1        NA        NA        NA          NA         NA
AC233755.2        NA        NA        NA          NA         NA
AC233755.1        NA        NA        NA          NA         NA
AC240274.1        NA        NA        NA          NA         NA</code></pre>
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/pkg/SingleCellExperiment/man/sizeFactors.html'>sizeFactors</a></span><span class='op'>(</span><span class='va'>summed.filt</span><span class='op'>)</span> <span class='op'>&lt;-</span> <span class='cn'>NULL</span>
<span class='fu'><a href='https://rdrr.io/pkg/scater/man/plotExpression.html'>plotExpression</a></span><span class='op'>(</span>
  <span class='fu'><a href='https://rdrr.io/pkg/scuttle/man/logNormCounts.html'>logNormCounts</a></span><span class='op'>(</span><span class='va'>summed.filt</span><span class='op'>)</span>,
  features <span class='op'>=</span> <span class='st'>"CD74"</span>,
  x <span class='op'>=</span> <span class='st'>"Treatment"</span>,
  colour_by <span class='op'>=</span> <span class='st'>"Treatment"</span>,
  other_fields <span class='op'>=</span> <span class='st'>"subcluster"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>facet_wrap</span><span class='op'>(</span><span class='op'>~</span><span class='va'>subcluster</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>scale_colour_manual</span><span class='op'>(</span>values <span class='op'>=</span> <span class='va'>treatment_colours</span>, name <span class='op'>=</span> <span class='st'>"Treatment"</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<img src="annotation_DE_DA_files/figure-html5/unnamed-chunk-1-34.png" width="624" />
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>y.cur.results</span> <span class='op'>&lt;-</span> <span class='fu'>metadata</span><span class='op'>(</span><span class='va'>cur.results</span><span class='op'>)</span><span class='op'>$</span><span class='va'>y</span>
<span class='fu'><a href='https://rdrr.io/pkg/edgeR/man/plotBCV.html'>plotBCV</a></span><span class='op'>(</span><span class='va'>y.cur.results</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<img src="annotation_DE_DA_files/figure-html5/unnamed-chunk-1-35.png" width="624" />
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'>metadata</span><span class='op'>(</span><span class='va'>de.results</span><span class='op'>)</span><span class='op'>$</span><span class='va'>failed</span>
</code></pre>
</div>
</details>
<pre><code>character(0)</code></pre>
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>is.de</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scran/man/decideTestsPerLabel.html'>decideTestsPerLabel</a></span><span class='op'>(</span><span class='va'>de.results</span>, threshold<span class='op'>=</span><span class='fl'>0.05</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/pkg/scran/man/decideTestsPerLabel.html'>summarizeTestsPerLabel</a></span><span class='op'>(</span><span class='va'>is.de</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<pre><code>              -1    0  1    NA
Not cycling.1 12 6103  6 14481
Not cycling.2 14 8239  8 12341
Not cycling.3 84 8712 68 11738
Not cycling.4 14 9058 17 11513
Not cycling.5 88 9361 46 11107</code></pre>
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># Upregulated across most labels</span>
<span class='va'>up.de</span> <span class='op'>&lt;-</span> <span class='va'>is.de</span> <span class='op'>&gt;</span> <span class='fl'>0</span> <span class='op'>&amp;</span> <span class='op'>!</span><span class='fu'><a href='https://rdrr.io/r/base/NA.html'>is.na</a></span><span class='op'>(</span><span class='va'>is.de</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/utils/head.html'>head</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/sort.html'>sort</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/colSums.html'>rowMeans</a></span><span class='op'>(</span><span class='va'>up.de</span><span class='op'>)</span>, decreasing<span class='op'>=</span><span class='cn'>TRUE</span><span class='op'>)</span>, <span class='fl'>10</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<pre><code>  PTPN4    CISH   CCND2   ISG15   TCEA3   IFI44 DENND2D    LMNA 
    0.6     0.6     0.6     0.4     0.4     0.4     0.4     0.4 
  GPR25 TRABD2A 
    0.4     0.4 </code></pre>
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># Downregulated across most labels</span>
<span class='va'>down.de</span> <span class='op'>&lt;-</span> <span class='va'>is.de</span> <span class='op'>&lt;</span> <span class='fl'>0</span> <span class='op'>&amp;</span> <span class='op'>!</span><span class='fu'><a href='https://rdrr.io/r/base/NA.html'>is.na</a></span><span class='op'>(</span><span class='va'>is.de</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/utils/head.html'>head</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/sort.html'>sort</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/colSums.html'>rowMeans</a></span><span class='op'>(</span><span class='va'>down.de</span><span class='op'>)</span>, decreasing<span class='op'>=</span><span class='cn'>TRUE</span><span class='op'>)</span>, <span class='fl'>10</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<pre><code>    CD74 HLA-DRB5  ALOX5AP     LMO4     RGS2  HLA-DRA HLA-DRB1 
     0.8      0.8      0.8      0.6      0.6      0.6      0.6 
HLA-DQA1 HLA-DQA2 HLA-DPA1 
     0.6      0.6      0.6 </code></pre>
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>de.specific</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scran/man/pseudoBulkSpecific.html'>pseudoBulkSpecific</a></span><span class='op'>(</span>
  <span class='va'>summed.filt</span>,
  label <span class='op'>=</span> <span class='va'>summed.filt</span><span class='op'>$</span><span class='va'>subcluster</span>,
  design <span class='op'>=</span> <span class='op'>~</span><span class='va'>Treatment</span>,
  coef <span class='op'>=</span> <span class='st'>"TreatmentUninfected"</span>,
  condition <span class='op'>=</span> <span class='va'>summed.filt</span><span class='op'>$</span><span class='va'>Treatment</span><span class='op'>)</span>

<span class='va'>cur.specific</span> <span class='op'>&lt;-</span> <span class='va'>de.specific</span><span class='op'>[[</span><span class='st'>"Not cycling.4"</span><span class='op'>]</span><span class='op'>]</span>
<span class='va'>cur.specific</span> <span class='op'>&lt;-</span> <span class='va'>cur.specific</span><span class='op'>[</span><span class='fu'><a href='https://rdrr.io/r/base/order.html'>order</a></span><span class='op'>(</span><span class='va'>cur.specific</span><span class='op'>$</span><span class='va'>PValue</span><span class='op'>)</span>,<span class='op'>]</span>
<span class='va'>cur.specific</span>
</code></pre>
</div>
</details>
<pre><code>DataFrame with 20602 rows and 6 columns
               logFC    logCPM         F      PValue       FDR
           &lt;numeric&gt; &lt;numeric&gt; &lt;numeric&gt;   &lt;numeric&gt; &lt;numeric&gt;
DTHD1       4.486733   1.12407   28.7466 8.53701e-05  0.482701
RASSF1      0.979815   6.09213   34.1281 1.06216e-04  0.482701
FOXP3       2.747233   2.94990   27.5003 2.59671e-04  0.496065
TRGV8       3.691656   2.78502   28.1151 2.85481e-04  0.496065
DRAIC       3.492989   1.56497   26.2134 3.10287e-04  0.496065
...              ...       ...       ...         ...       ...
AL354822.1        NA        NA        NA          NA        NA
AC004556.1        NA        NA        NA          NA        NA
AC233755.2        NA        NA        NA          NA        NA
AC233755.1        NA        NA        NA          NA        NA
AC240274.1        NA        NA        NA          NA        NA
           OtherAverage
              &lt;numeric&gt;
DTHD1                NA
RASSF1         0.102385
FOXP3          0.280986
TRGV8                NA
DRAIC          0.357498
...                 ...
AL354822.1           NA
AC004556.1           NA
AC233755.2           NA
AC233755.1           NA
AC240274.1           NA</code></pre>
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># DE analysis using subcluster labels in cycling clusters ----------------------</span>

<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='http://bioinf.wehi.edu.au/edgeR'>edgeR</a></span><span class='op'>)</span>
<span class='va'>plotMDS</span> <span class='op'>&lt;-</span> <span class='fu'>scater</span><span class='fu'>::</span><span class='va'><a href='https://rdrr.io/pkg/scater/man/plot_reddim.html'>plotMDS</a></span>

<span class='co'># NOTE: Have to drop the complicated TRA and TRB DFrameList objects.</span>
<span class='va'>tmp</span> <span class='op'>&lt;-</span> <span class='va'>list_of_sce</span><span class='op'>$</span><span class='va'>Cycling</span>
<span class='va'>tmp</span><span class='op'>$</span><span class='va'>TRA</span> <span class='op'>&lt;-</span> <span class='cn'>NULL</span>
<span class='va'>tmp</span><span class='op'>$</span><span class='va'>TRB</span> <span class='op'>&lt;-</span> <span class='cn'>NULL</span>
<span class='va'>summed</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scuttle/man/aggregateAcrossCells.html'>aggregateAcrossCells</a></span><span class='op'>(</span>
  <span class='va'>tmp</span>,
  id <span class='op'>=</span> <span class='fu'>colData</span><span class='op'>(</span><span class='va'>tmp</span><span class='op'>)</span><span class='op'>[</span>, <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"subcluster"</span>, <span class='st'>"Sample"</span><span class='op'>)</span><span class='op'>]</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/pkg/SingleCellExperiment/man/sizeFactors.html'>sizeFactors</a></span><span class='op'>(</span><span class='va'>summed</span><span class='op'>)</span> <span class='op'>&lt;-</span> <span class='cn'>NULL</span>
<span class='va'>summed</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scuttle/man/logNormCounts.html'>logNormCounts</a></span><span class='op'>(</span><span class='va'>summed</span><span class='op'>)</span>

<span class='va'>summed</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scater/man/runMDS.html'>runMDS</a></span><span class='op'>(</span><span class='va'>summed</span><span class='op'>)</span>
<span class='va'>p1</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scater/man/plot_reddim.html'>plotMDS</a></span><span class='op'>(</span><span class='va'>summed</span>, colour_by <span class='op'>=</span> <span class='st'>"subcluster"</span>, shape_by <span class='op'>=</span> <span class='st'>"Treatment"</span><span class='op'>)</span>
<span class='va'>p2</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scater/man/plot_reddim.html'>plotMDS</a></span><span class='op'>(</span><span class='va'>summed</span>, colour_by <span class='op'>=</span> <span class='st'>"subcluster"</span>, shape_by <span class='op'>=</span> <span class='st'>"Sample"</span><span class='op'>)</span>
<span class='va'>p1</span> <span class='op'>+</span> <span class='va'>p2</span> <span class='op'>+</span> <span class='fu'><a href='https://patchwork.data-imaginist.com/reference/plot_layout.html'>plot_layout</a></span><span class='op'>(</span>guides <span class='op'>=</span> <span class='st'>"collect"</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<img src="annotation_DE_DA_files/figure-html5/unnamed-chunk-1-36.png" width="624" />
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>summed.filt</span> <span class='op'>&lt;-</span> <span class='va'>summed</span><span class='op'>[</span>,<span class='va'>summed</span><span class='op'>$</span><span class='va'>ncells</span> <span class='op'>&gt;=</span> <span class='fl'>10</span><span class='op'>]</span>

<span class='va'>de.results</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scran/man/pseudoBulkDGE.html'>pseudoBulkDGE</a></span><span class='op'>(</span>
  <span class='va'>summed.filt</span>,
  label <span class='op'>=</span> <span class='va'>summed.filt</span><span class='op'>$</span><span class='va'>subcluster</span>,
  design <span class='op'>=</span> <span class='op'>~</span><span class='va'>Treatment</span>,
  coef <span class='op'>=</span> <span class='st'>"TreatmentUninfected"</span>,
  condition <span class='op'>=</span> <span class='va'>summed.filt</span><span class='op'>$</span><span class='va'>Treatment</span>,
  include.intermediates <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span>

<span class='va'>cur.results</span> <span class='op'>&lt;-</span> <span class='va'>de.results</span><span class='op'>[[</span><span class='st'>"Cycling.1"</span><span class='op'>]</span><span class='op'>]</span>
<span class='va'>cur.results</span><span class='op'>[</span><span class='fu'><a href='https://rdrr.io/r/base/order.html'>order</a></span><span class='op'>(</span><span class='va'>cur.results</span><span class='op'>$</span><span class='va'>PValue</span><span class='op'>)</span>,<span class='op'>]</span>
</code></pre>
</div>
</details>
<pre><code>DataFrame with 20602 rows and 5 columns
               logFC    logCPM         F      PValue         FDR
           &lt;numeric&gt; &lt;numeric&gt; &lt;numeric&gt;   &lt;numeric&gt;   &lt;numeric&gt;
GLUL        -2.11535   6.55222  186.5379 5.36013e-13 4.13534e-09
CADM1       -4.47232   5.19656  156.8050 4.64020e-12 1.78996e-08
RGS2        -4.21474   5.60664  168.2808 4.07983e-11 1.04920e-07
GNG4        -3.56366   5.74719  142.4618 8.29211e-10 1.59934e-06
LTA          2.78225   4.60942   85.1966 1.79361e-09 2.61272e-06
...              ...       ...       ...         ...         ...
AL354822.1        NA        NA        NA          NA          NA
AC004556.1        NA        NA        NA          NA          NA
AC233755.2        NA        NA        NA          NA          NA
AC233755.1        NA        NA        NA          NA          NA
AC240274.1        NA        NA        NA          NA          NA</code></pre>
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/pkg/SingleCellExperiment/man/sizeFactors.html'>sizeFactors</a></span><span class='op'>(</span><span class='va'>summed.filt</span><span class='op'>)</span> <span class='op'>&lt;-</span> <span class='cn'>NULL</span>
<span class='fu'><a href='https://rdrr.io/pkg/scater/man/plotExpression.html'>plotExpression</a></span><span class='op'>(</span>
  <span class='fu'><a href='https://rdrr.io/pkg/scuttle/man/logNormCounts.html'>logNormCounts</a></span><span class='op'>(</span><span class='va'>summed.filt</span><span class='op'>)</span>,
  features <span class='op'>=</span> <span class='st'>"GLUL"</span>,
  x <span class='op'>=</span> <span class='st'>"Treatment"</span>,
  colour_by <span class='op'>=</span> <span class='st'>"Treatment"</span>,
  other_fields <span class='op'>=</span> <span class='st'>"subcluster"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>facet_wrap</span><span class='op'>(</span><span class='op'>~</span><span class='va'>subcluster</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>scale_colour_manual</span><span class='op'>(</span>values <span class='op'>=</span> <span class='va'>treatment_colours</span>, name <span class='op'>=</span> <span class='st'>"Treatment"</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<img src="annotation_DE_DA_files/figure-html5/unnamed-chunk-1-37.png" width="624" />
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>y.cur.results</span> <span class='op'>&lt;-</span> <span class='fu'>metadata</span><span class='op'>(</span><span class='va'>cur.results</span><span class='op'>)</span><span class='op'>$</span><span class='va'>y</span>
<span class='fu'><a href='https://rdrr.io/pkg/edgeR/man/plotBCV.html'>plotBCV</a></span><span class='op'>(</span><span class='va'>y.cur.results</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<img src="annotation_DE_DA_files/figure-html5/unnamed-chunk-1-38.png" width="624" />
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'>metadata</span><span class='op'>(</span><span class='va'>de.results</span><span class='op'>)</span><span class='op'>$</span><span class='va'>failed</span>
</code></pre>
</div>
</details>
<pre><code>character(0)</code></pre>
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>is.de</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scran/man/decideTestsPerLabel.html'>decideTestsPerLabel</a></span><span class='op'>(</span><span class='va'>de.results</span>, threshold<span class='op'>=</span><span class='fl'>0.05</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/pkg/scran/man/decideTestsPerLabel.html'>summarizeTestsPerLabel</a></span><span class='op'>(</span><span class='va'>is.de</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<pre><code>           -1    0  1    NA
Cycling.1  98 7519 98 12887
Cycling.2  98 6051 66 14387
Cycling.3 112 8356 75 12059</code></pre>
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># Upregulated across most labels</span>
<span class='va'>up.de</span> <span class='op'>&lt;-</span> <span class='va'>is.de</span> <span class='op'>&gt;</span> <span class='fl'>0</span> <span class='op'>&amp;</span> <span class='op'>!</span><span class='fu'><a href='https://rdrr.io/r/base/NA.html'>is.na</a></span><span class='op'>(</span><span class='va'>is.de</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/utils/head.html'>head</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/sort.html'>sort</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/colSums.html'>rowMeans</a></span><span class='op'>(</span><span class='va'>up.de</span><span class='op'>)</span>, decreasing<span class='op'>=</span><span class='cn'>TRUE</span><span class='op'>)</span>, <span class='fl'>10</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<pre><code>  IFI6  THEM4  FOXP1    LTA    SMS    TOX   IRF7 RCBTB2 MYCBP2    MAF 
     1      1      1      1      1      1      1      1      1      1 </code></pre>
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># Downregulated across most labels</span>
<span class='va'>down.de</span> <span class='op'>&lt;-</span> <span class='va'>is.de</span> <span class='op'>&lt;</span> <span class='fl'>0</span> <span class='op'>&amp;</span> <span class='op'>!</span><span class='fu'><a href='https://rdrr.io/r/base/NA.html'>is.na</a></span><span class='op'>(</span><span class='va'>is.de</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/utils/head.html'>head</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/sort.html'>sort</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/colSums.html'>rowMeans</a></span><span class='op'>(</span><span class='va'>down.de</span><span class='op'>)</span>, decreasing<span class='op'>=</span><span class='cn'>TRUE</span><span class='op'>)</span>, <span class='fl'>10</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<pre><code>KIAA1324     GLUL     RGS2   SNAP47 SLC25A46    ACSL6     CD74 
       1        1        1        1        1        1        1 
 HLA-DRA   CITED2    EEPD1 
       1        1        1 </code></pre>
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>de.specific</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scran/man/pseudoBulkSpecific.html'>pseudoBulkSpecific</a></span><span class='op'>(</span>
  <span class='va'>summed.filt</span>,
  label <span class='op'>=</span> <span class='va'>summed.filt</span><span class='op'>$</span><span class='va'>subcluster</span>,
  design <span class='op'>=</span> <span class='op'>~</span><span class='va'>Treatment</span>,
  coef <span class='op'>=</span> <span class='st'>"TreatmentUninfected"</span>,
  condition <span class='op'>=</span> <span class='va'>summed.filt</span><span class='op'>$</span><span class='va'>Treatment</span><span class='op'>)</span>

<span class='va'>cur.specific</span> <span class='op'>&lt;-</span> <span class='va'>de.specific</span><span class='op'>[[</span><span class='st'>"Cycling.1"</span><span class='op'>]</span><span class='op'>]</span>
<span class='va'>cur.specific</span> <span class='op'>&lt;-</span> <span class='va'>cur.specific</span><span class='op'>[</span><span class='fu'><a href='https://rdrr.io/r/base/order.html'>order</a></span><span class='op'>(</span><span class='va'>cur.specific</span><span class='op'>$</span><span class='va'>PValue</span><span class='op'>)</span>,<span class='op'>]</span>
<span class='va'>cur.specific</span>
</code></pre>
</div>
</details>
<pre><code>DataFrame with 20602 rows and 6 columns
               logFC    logCPM         F      PValue       FDR
           &lt;numeric&gt; &lt;numeric&gt; &lt;numeric&gt;   &lt;numeric&gt; &lt;numeric&gt;
ARHGAP31    3.063452   3.11914   30.7922 9.51531e-06 0.0734106
AL590764.1  1.970744   3.35892   20.2040 1.42039e-04 0.5479137
TYMS       -0.373388   9.05897   16.2153 5.87338e-04 1.0000000
TTN         1.787665   4.05699   28.3184 8.03669e-04 1.0000000
ARHGAP35    1.584186   3.59939   16.7064 8.87867e-04 1.0000000
...              ...       ...       ...         ...       ...
AL354822.1        NA        NA        NA          NA        NA
AC004556.1        NA        NA        NA          NA        NA
AC233755.2        NA        NA        NA          NA        NA
AC233755.1        NA        NA        NA          NA        NA
AC240274.1        NA        NA        NA          NA        NA
           OtherAverage
              &lt;numeric&gt;
ARHGAP31             NA
AL590764.1           NA
TYMS        -0.00791508
TTN          0.49885324
ARHGAP35     0.11837668
...                 ...
AL354822.1           NA
AC004556.1           NA
AC233755.2           NA
AC233755.1           NA
AC240274.1           NA</code></pre>
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># DA analysis using cycling vs. non-cycling labels -----------------------------</span>

<span class='co'># TODO: Need to think about how to do this with only 2 labels.</span>

<span class='co'># DA analysis using cluster labels ---------------------------------------------</span>

<span class='va'>abundances</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/table.html'>table</a></span><span class='op'>(</span><span class='va'>sce</span><span class='op'>$</span><span class='va'>cluster</span>, <span class='va'>sce</span><span class='op'>$</span><span class='va'>Sample</span><span class='op'>)</span>
<span class='va'>abundances</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/class.html'>unclass</a></span><span class='op'>(</span><span class='va'>abundances</span><span class='op'>)</span>
<span class='va'>abundances</span>
</code></pre>
</div>
</details>
<pre><code>    
     infected_1 infected_2 infected_3 uninfected_1 uninfected_2
  1         107         15         19          418          399
  2         247        685        719           23           18
  3          58         20          8            9            4
  4          69         44         60          209           47
  5          22          3         12          174          515
  6           6          1          6          127          139
  7          79         29         25          288          255
  8         226        171        327          171          358
  9          56         10          5          345          281
  10        477        197        153           25           36
    
     uninfected_3
  1           431
  2            25
  3             5
  4           123
  5           127
  6            25
  7           313
  8           142
  9           214
  10           29</code></pre>
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>extra.info</span> <span class='op'>&lt;-</span> <span class='fu'>colData</span><span class='op'>(</span><span class='va'>sce</span><span class='op'>)</span><span class='op'>[</span><span class='fu'><a href='https://rdrr.io/r/base/match.html'>match</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/colnames.html'>colnames</a></span><span class='op'>(</span><span class='va'>abundances</span><span class='op'>)</span>, <span class='va'>sce</span><span class='op'>$</span><span class='va'>Sample</span><span class='op'>)</span>,<span class='op'>]</span>
<span class='va'>y.ab</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/edgeR/man/DGEList.html'>DGEList</a></span><span class='op'>(</span><span class='va'>abundances</span>, samples<span class='op'>=</span><span class='va'>extra.info</span><span class='op'>)</span>

<span class='va'>keep</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/edgeR/man/filterByExpr.html'>filterByExpr</a></span><span class='op'>(</span><span class='va'>y.ab</span>, group<span class='op'>=</span><span class='va'>y.ab</span><span class='op'>$</span><span class='va'>samples</span><span class='op'>$</span><span class='va'>Treatment</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/base/summary.html'>summary</a></span><span class='op'>(</span><span class='va'>keep</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<pre><code>   Mode   FALSE    TRUE 
logical       1       9 </code></pre>
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>y.ab</span> <span class='op'>&lt;-</span> <span class='va'>y.ab</span><span class='op'>[</span><span class='va'>keep</span>,<span class='op'>]</span>

<span class='va'>design</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/model.matrix.html'>model.matrix</a></span><span class='op'>(</span><span class='op'>~</span><span class='va'>Treatment</span>, <span class='va'>y.ab</span><span class='op'>$</span><span class='va'>samples</span><span class='op'>)</span>

<span class='va'>y.ab</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/edgeR/man/estimateDisp.html'>estimateDisp</a></span><span class='op'>(</span><span class='va'>y.ab</span>, <span class='va'>design</span>, trend<span class='op'>=</span><span class='st'>"none"</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/base/summary.html'>summary</a></span><span class='op'>(</span><span class='va'>y.ab</span><span class='op'>$</span><span class='va'>common.dispersion</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
 0.3099  0.3099  0.3099  0.3099  0.3099  0.3099 </code></pre>
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/pkg/edgeR/man/plotBCV.html'>plotBCV</a></span><span class='op'>(</span><span class='va'>y.ab</span>, cex<span class='op'>=</span><span class='fl'>1</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<img src="annotation_DE_DA_files/figure-html5/unnamed-chunk-1-39.png" width="624" />
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>fit.ab</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/edgeR/man/glmQLFTest.html'>glmQLFit</a></span><span class='op'>(</span><span class='va'>y.ab</span>, <span class='va'>design</span>, robust<span class='op'>=</span><span class='cn'>TRUE</span>, abundance.trend<span class='op'>=</span><span class='cn'>FALSE</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/base/summary.html'>summary</a></span><span class='op'>(</span><span class='va'>fit.ab</span><span class='op'>$</span><span class='va'>var.prior</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
  1.097   1.097   1.097   1.097   1.097   1.097 </code></pre>
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># NOTE: With only 2 labels this doesn't work / make sense</span>
<span class='fu'><a href='https://rdrr.io/r/base/summary.html'>summary</a></span><span class='op'>(</span><span class='va'>fit.ab</span><span class='op'>$</span><span class='va'>df.prior</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
    Inf     Inf     Inf     Inf     Inf     Inf </code></pre>
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/pkg/edgeR/man/plotQLDisp.html'>plotQLDisp</a></span><span class='op'>(</span><span class='va'>fit.ab</span>, cex<span class='op'>=</span><span class='fl'>1</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<img src="annotation_DE_DA_files/figure-html5/unnamed-chunk-1-40.png" width="624" />
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>res</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/edgeR/man/glmQLFTest.html'>glmQLFTest</a></span><span class='op'>(</span><span class='va'>fit.ab</span>, coef <span class='op'>=</span> <span class='st'>"TreatmentUninfected"</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/base/summary.html'>summary</a></span><span class='op'>(</span><span class='fu'>decideTests</span><span class='op'>(</span><span class='va'>res</span><span class='op'>)</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<pre><code>       TreatmentUninfected
Down                     2
NotSig                   2
Up                       5</code></pre>
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/pkg/edgeR/man/topTags.html'>topTags</a></span><span class='op'>(</span><span class='va'>res</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<pre><code>Coefficient:  TreatmentUninfected 
        logFC   logCPM          F       PValue          FDR
2  -5.0608155 17.77602 37.4339396 4.830479e-07 4.347431e-06
5   3.9487880 16.26832 24.4846606 1.759911e-05 7.919599e-05
6   3.9439823 14.83639 22.1815535 3.635058e-05 9.058258e-05
10 -3.6163947 16.81716 21.8650595 4.025893e-05 9.058258e-05
9   3.1429795 16.45985 17.0400142 2.071776e-04 3.729197e-04
1   2.7689919 17.09845 13.9027383 6.601014e-04 9.901521e-04
7   2.2977786 16.64016  9.8849535 3.331764e-03 4.283697e-03
4   0.7516523 15.89775  1.1425514 2.922290e-01 3.287576e-01
8  -0.5966428 17.24622  0.7399974 3.953546e-01 3.953546e-01</code></pre>
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/pkg/scater/man/plot_reddim.html'>plotUMAP</a></span><span class='op'>(</span><span class='va'>sce</span>, colour_by <span class='op'>=</span> <span class='st'>"cluster"</span>, text_by <span class='op'>=</span> <span class='st'>"cluster"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>scale_colour_manual</span><span class='op'>(</span>values <span class='op'>=</span> <span class='va'>cluster_colours</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://rdrr.io/pkg/scater/man/plot_reddim.html'>plotUMAP</a></span><span class='op'>(</span><span class='va'>sce</span>, colour_by <span class='op'>=</span> <span class='st'>"Treatment"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>scale_colour_manual</span><span class='op'>(</span>values <span class='op'>=</span> <span class='va'>treatment_colours</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<img src="annotation_DE_DA_files/figure-html5/unnamed-chunk-1-41.png" width="624" />
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># DA analysis using subcluster labels in non-cycling clusters ------------------</span>

<span class='va'>tmp</span> <span class='op'>&lt;-</span> <span class='va'>list_of_sce</span><span class='op'>$</span><span class='va'>`Not cycling`</span>
<span class='va'>abundances</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/table.html'>table</a></span><span class='op'>(</span><span class='va'>tmp</span><span class='op'>$</span><span class='va'>subcluster</span>, <span class='va'>tmp</span><span class='op'>$</span><span class='va'>Sample</span><span class='op'>)</span>
<span class='va'>abundances</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/class.html'>unclass</a></span><span class='op'>(</span><span class='va'>abundances</span><span class='op'>)</span>
<span class='va'>abundances</span>
</code></pre>
</div>
</details>
<pre><code>               
                infected_1 infected_2 infected_3 uninfected_1
  Not cycling.1         32          3         14          247
  Not cycling.2         53         11          7          342
  Not cycling.3        241        101         70          366
  Not cycling.4        532        848        881           29
  Not cycling.5        263         41         35          634
               
                uninfected_2 uninfected_3
  Not cycling.1          507           97
  Not cycling.2          258          197
  Not cycling.3          440          380
  Not cycling.4           30           41
  Not cycling.5          459          577</code></pre>
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>extra.info</span> <span class='op'>&lt;-</span> <span class='fu'>colData</span><span class='op'>(</span><span class='va'>tmp</span><span class='op'>)</span><span class='op'>[</span><span class='fu'><a href='https://rdrr.io/r/base/match.html'>match</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/colnames.html'>colnames</a></span><span class='op'>(</span><span class='va'>abundances</span><span class='op'>)</span>, <span class='va'>tmp</span><span class='op'>$</span><span class='va'>Sample</span><span class='op'>)</span>,<span class='op'>]</span>
<span class='va'>y.ab</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/edgeR/man/DGEList.html'>DGEList</a></span><span class='op'>(</span><span class='va'>abundances</span>, samples<span class='op'>=</span><span class='va'>extra.info</span><span class='op'>)</span>

<span class='va'>keep</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/edgeR/man/filterByExpr.html'>filterByExpr</a></span><span class='op'>(</span><span class='va'>y.ab</span>, group<span class='op'>=</span><span class='va'>y.ab</span><span class='op'>$</span><span class='va'>samples</span><span class='op'>$</span><span class='va'>Treatment</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/base/summary.html'>summary</a></span><span class='op'>(</span><span class='va'>keep</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<pre><code>   Mode    TRUE 
logical       5 </code></pre>
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>y.ab</span> <span class='op'>&lt;-</span> <span class='va'>y.ab</span><span class='op'>[</span><span class='va'>keep</span>,<span class='op'>]</span>

<span class='va'>design</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/model.matrix.html'>model.matrix</a></span><span class='op'>(</span><span class='op'>~</span><span class='va'>Treatment</span>, <span class='va'>y.ab</span><span class='op'>$</span><span class='va'>samples</span><span class='op'>)</span>

<span class='va'>y.ab</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/edgeR/man/estimateDisp.html'>estimateDisp</a></span><span class='op'>(</span><span class='va'>y.ab</span>, <span class='va'>design</span>, trend<span class='op'>=</span><span class='st'>"none"</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/base/summary.html'>summary</a></span><span class='op'>(</span><span class='va'>y.ab</span><span class='op'>$</span><span class='va'>common.dispersion</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
 0.3614  0.3614  0.3614  0.3614  0.3614  0.3614 </code></pre>
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/pkg/edgeR/man/plotBCV.html'>plotBCV</a></span><span class='op'>(</span><span class='va'>y.ab</span>, cex<span class='op'>=</span><span class='fl'>1</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<img src="annotation_DE_DA_files/figure-html5/unnamed-chunk-1-42.png" width="624" />
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>fit.ab</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/edgeR/man/glmQLFTest.html'>glmQLFit</a></span><span class='op'>(</span><span class='va'>y.ab</span>, <span class='va'>design</span>, robust<span class='op'>=</span><span class='cn'>TRUE</span>, abundance.trend<span class='op'>=</span><span class='cn'>FALSE</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/base/summary.html'>summary</a></span><span class='op'>(</span><span class='va'>fit.ab</span><span class='op'>$</span><span class='va'>var.prior</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
  1.172   1.172   1.172   1.172   1.172   1.172 </code></pre>
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># NOTE: With only 2 labels this doesn't work / make sense</span>
<span class='fu'><a href='https://rdrr.io/r/base/summary.html'>summary</a></span><span class='op'>(</span><span class='va'>fit.ab</span><span class='op'>$</span><span class='va'>df.prior</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
    527     527     527     527     527     527 </code></pre>
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/pkg/edgeR/man/plotQLDisp.html'>plotQLDisp</a></span><span class='op'>(</span><span class='va'>fit.ab</span>, cex<span class='op'>=</span><span class='fl'>1</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<img src="annotation_DE_DA_files/figure-html5/unnamed-chunk-1-43.png" width="624" />
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>res</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/edgeR/man/glmQLFTest.html'>glmQLFTest</a></span><span class='op'>(</span><span class='va'>fit.ab</span>, coef <span class='op'>=</span> <span class='st'>"TreatmentUninfected"</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/base/summary.html'>summary</a></span><span class='op'>(</span><span class='fu'>decideTests</span><span class='op'>(</span><span class='va'>res</span><span class='op'>)</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<pre><code>       TreatmentUninfected
Down                     1
NotSig                   1
Up                       3</code></pre>
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/pkg/edgeR/man/topTags.html'>topTags</a></span><span class='op'>(</span><span class='va'>res</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<pre><code>Coefficient:  TreatmentUninfected 
                  logFC   logCPM         F       PValue          FDR
Not cycling.4 -5.023154 18.52370 30.230585 2.211093e-05 0.0001105546
Not cycling.1  3.521584 16.56704 16.468650 6.140660e-04 0.0015351649
Not cycling.2  2.973155 16.58736 12.465420 2.100608e-03 0.0035010134
Not cycling.5  1.835732 17.85842  5.305937 3.211608e-02 0.0401450989
Not cycling.3  1.017014 17.57522  1.711972 2.055674e-01 0.2055674223</code></pre>
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/pkg/scater/man/plot_reddim.html'>plotUMAP</a></span><span class='op'>(</span><span class='va'>tmp</span>, colour_by <span class='op'>=</span> <span class='st'>"subcluster"</span>, text_by <span class='op'>=</span> <span class='st'>"subcluster"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://rdrr.io/pkg/scater/man/plot_reddim.html'>plotUMAP</a></span><span class='op'>(</span><span class='va'>tmp</span>, colour_by <span class='op'>=</span> <span class='st'>"Treatment"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>scale_colour_manual</span><span class='op'>(</span>values <span class='op'>=</span> <span class='va'>treatment_colours</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<img src="annotation_DE_DA_files/figure-html5/unnamed-chunk-1-44.png" width="624" />
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># DA analysis using subcluster labels in cycling clusters ----------------------</span>

<span class='va'>tmp</span> <span class='op'>&lt;-</span> <span class='va'>list_of_sce</span><span class='op'>$</span><span class='va'>Cycling</span>
<span class='va'>abundances</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/table.html'>table</a></span><span class='op'>(</span><span class='va'>tmp</span><span class='op'>$</span><span class='va'>subcluster</span>, <span class='va'>tmp</span><span class='op'>$</span><span class='va'>Sample</span><span class='op'>)</span>
<span class='va'>abundances</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/class.html'>unclass</a></span><span class='op'>(</span><span class='va'>abundances</span><span class='op'>)</span>
<span class='va'>abundances</span>
</code></pre>
</div>
</details>
<pre><code>           
            infected_1 infected_2 infected_3 uninfected_1
  Cycling.1         73         65        147           42
  Cycling.2         72         45         55           55
  Cycling.3         81         61        125           74
           
            uninfected_2 uninfected_3
  Cycling.1          112           48
  Cycling.2          113           43
  Cycling.3          133           51</code></pre>
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>extra.info</span> <span class='op'>&lt;-</span> <span class='fu'>colData</span><span class='op'>(</span><span class='va'>tmp</span><span class='op'>)</span><span class='op'>[</span><span class='fu'><a href='https://rdrr.io/r/base/match.html'>match</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/colnames.html'>colnames</a></span><span class='op'>(</span><span class='va'>abundances</span><span class='op'>)</span>, <span class='va'>tmp</span><span class='op'>$</span><span class='va'>Sample</span><span class='op'>)</span>,<span class='op'>]</span>
<span class='va'>y.ab</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/edgeR/man/DGEList.html'>DGEList</a></span><span class='op'>(</span><span class='va'>abundances</span>, samples<span class='op'>=</span><span class='va'>extra.info</span><span class='op'>)</span>

<span class='va'>keep</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/edgeR/man/filterByExpr.html'>filterByExpr</a></span><span class='op'>(</span><span class='va'>y.ab</span>, group<span class='op'>=</span><span class='va'>y.ab</span><span class='op'>$</span><span class='va'>samples</span><span class='op'>$</span><span class='va'>Treatment</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/base/summary.html'>summary</a></span><span class='op'>(</span><span class='va'>keep</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<pre><code>   Mode    TRUE 
logical       3 </code></pre>
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>y.ab</span> <span class='op'>&lt;-</span> <span class='va'>y.ab</span><span class='op'>[</span><span class='va'>keep</span>,<span class='op'>]</span>

<span class='va'>design</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/model.matrix.html'>model.matrix</a></span><span class='op'>(</span><span class='op'>~</span><span class='va'>Treatment</span>, <span class='va'>y.ab</span><span class='op'>$</span><span class='va'>samples</span><span class='op'>)</span>

<span class='va'>y.ab</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/edgeR/man/estimateDisp.html'>estimateDisp</a></span><span class='op'>(</span><span class='va'>y.ab</span>, <span class='va'>design</span>, trend<span class='op'>=</span><span class='st'>"none"</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/base/summary.html'>summary</a></span><span class='op'>(</span><span class='va'>y.ab</span><span class='op'>$</span><span class='va'>common.dispersion</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
0.01332 0.01332 0.01332 0.01332 0.01332 0.01332 </code></pre>
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/pkg/edgeR/man/plotBCV.html'>plotBCV</a></span><span class='op'>(</span><span class='va'>y.ab</span>, cex<span class='op'>=</span><span class='fl'>1</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<img src="annotation_DE_DA_files/figure-html5/unnamed-chunk-1-45.png" width="624" />
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>fit.ab</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/edgeR/man/glmQLFTest.html'>glmQLFit</a></span><span class='op'>(</span><span class='va'>y.ab</span>, <span class='va'>design</span>, robust<span class='op'>=</span><span class='cn'>TRUE</span>, abundance.trend<span class='op'>=</span><span class='cn'>FALSE</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/base/summary.html'>summary</a></span><span class='op'>(</span><span class='va'>fit.ab</span><span class='op'>$</span><span class='va'>var.prior</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
  0.737   0.737   0.737   0.737   0.737   0.737 </code></pre>
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># NOTE: With only 2 labels this doesn't work / make sense</span>
<span class='fu'><a href='https://rdrr.io/r/base/summary.html'>summary</a></span><span class='op'>(</span><span class='va'>fit.ab</span><span class='op'>$</span><span class='va'>df.prior</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
  4.301   4.301   4.301   4.301   4.301   4.301 </code></pre>
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/pkg/edgeR/man/plotQLDisp.html'>plotQLDisp</a></span><span class='op'>(</span><span class='va'>fit.ab</span>, cex<span class='op'>=</span><span class='fl'>1</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<img src="annotation_DE_DA_files/figure-html5/unnamed-chunk-1-46.png" width="624" />
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>res</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/edgeR/man/glmQLFTest.html'>glmQLFTest</a></span><span class='op'>(</span><span class='va'>fit.ab</span>, coef <span class='op'>=</span> <span class='st'>"TreatmentUninfected"</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/base/summary.html'>summary</a></span><span class='op'>(</span><span class='fu'>decideTests</span><span class='op'>(</span><span class='va'>res</span><span class='op'>)</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<pre><code>       TreatmentUninfected
Down                     0
NotSig                   3
Up                       0</code></pre>
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/pkg/edgeR/man/topTags.html'>topTags</a></span><span class='op'>(</span><span class='va'>res</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<pre><code>Coefficient:  TreatmentUninfected 
                logFC   logCPM         F     PValue       FDR
Cycling.1 -0.37303584 18.40769 4.3858873 0.06830628 0.2049188
Cycling.2  0.36603907 18.10346 2.5737606 0.14594828 0.2189224
Cycling.3  0.07503416 18.53074 0.3300273 0.63267221 0.6326722</code></pre>
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/pkg/scater/man/plot_reddim.html'>plotUMAP</a></span><span class='op'>(</span><span class='va'>tmp</span>, colour_by <span class='op'>=</span> <span class='st'>"subcluster"</span>, text_by <span class='op'>=</span> <span class='st'>"subcluster"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://rdrr.io/pkg/scater/man/plot_reddim.html'>plotUMAP</a></span><span class='op'>(</span><span class='va'>tmp</span>, colour_by <span class='op'>=</span> <span class='st'>"Treatment"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>scale_colour_manual</span><span class='op'>(</span>values <span class='op'>=</span> <span class='va'>treatment_colours</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<img src="annotation_DE_DA_files/figure-html5/unnamed-chunk-1-47.png" width="624" />
<details>
<summary>Show code</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># TODOs ------------------------------------------------------------------------</span>

<span class='co'># - [ ] Cell cycle could really be proliferation of T-cells upon activation.</span>
<span class='co'># - [ ] Are samples paired?</span>
<span class='co'># - [ ] Ambient RNA</span>
<span class='co'># - [ ] Heatmaps and CSVs of DEGs</span>
</code></pre>
</div>
</details>
</div>
<div class="sourceCode" id="cb58"><pre class="sourceCode r distill-force-highlighting-css"><code class="sourceCode r"></code></pre></div>
<!--radix_placeholder_article_footer-->
<!--/radix_placeholder_article_footer-->
</div>

<div class="d-appendix">
</div>


<!--radix_placeholder_site_after_body-->
<!--/radix_placeholder_site_after_body-->
<!--radix_placeholder_appendices-->
<div class="appendix-bottom"></div>
<!--/radix_placeholder_appendices-->
<!--radix_placeholder_navigation_after_body-->
<!--/radix_placeholder_navigation_after_body-->

</body>

</html>
